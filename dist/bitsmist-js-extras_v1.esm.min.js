import{Store as t,Util as r,Perk as a,AjaxUtil as s,Unit as o,URLUtil as n,ChainableStore as l}from"@bitsmist-js_v1/core";class MultiStore extends t{constructor(e){super(e),this._stores=[]}add(e){this._stores.push(e)}clear(){this._stores=[]}clone(){let e={};for(let t=0;t<this._stores.length;t++)r.deepMerge(e,this._stores[t].items);return e}get(e,t){let r,i=!1;for(let t=0;t<this._stores.length;t++)if(this._stores[t].has(e)){r=this._stores[t].get(e),i=!0;break}return i?r:t}merge(e,t){throw TypeError("MultiStore is read only.")}set(e,t,r){throw TypeError("MultiStore is read only.")}remove(e){throw TypeError("MultiStore is read only.")}has(e){let t=!1;for(let r=0;r<this._stores.length;r++)if(this._stores[r].has(e)){t=!0;break}return t}}class ArrayStore extends t{constructor(e){super(Object.assign({},e)),this.items=r.safeGet(this._options,"items",[])}get items(){return this.clone()}set items(e){r.assert(Array.isArray(e),(()=>`ArrayStore.items(setter): Items is not an array. items=${e}`),TypeError),this._items=e}clear(){this._items=[]}clone(){return r.deepMerge([],this._items)}get(e,t,i){return r.safeGet(this._items[e],t,i)}set(e,t,i,a){if(a&&a.merge)return r.safeMerge(this._items[e],t,defaultValue);r.safeSet(this._items[e],t,i)}remove(e,t){r.safeRemove(this._items[i],t)}has(e,t){return r.safeHas(this._items[e],t)}}class ObservableStore extends t{constructor(e){super(Object.assign({notifyOnChange:!0,async:!0},e)),this._filter,this._observers=[],this.filter=r.safeGet(this._options,"filter",(()=>!0))}get filter(){return this._filter}set filter(e){r.assert("function"==typeof e,(()=>`Store.filter(setter): Filter is not a function. filter=${e}`),TypeError),this._filter=e}set(e,t,i,...a){let s={},o=e?this.get(e):this._items;if(o&&"object"==typeof o?this.#e(o,t,s):this.get(e)!==t&&(r.safeSet(this._items,e,t),s[e]=t),r.safeGet(i,"notifyOnChange",r.safeGet(this._options,"notifyOnChange"))&&Object.keys(s).length>0)return this.notify(s,...a)}clear(e,...t){return super.clear(),this.notify("*",...t)}replace(e,t,...i){if(this._items={},this.#e(this._items,e),r.safeGet(t,"notifyOnChange",r.safeGet(this._options,"notifyOnChange")))return this.notify(e,...i)}subscribe(e,t,i){r.assert("function"==typeof t,(()=>`ObservableStore.subscribe(): Notification handler is not a function. id=${e}`),TypeError),this._observers.push({id:e,handler:t,options:i})}unsubscribe(e){for(let t=0;t<this._observers.length;t++)if(this._obvservers[t].id===e){this._observers.splice(t,1);break}}notify(e,...t){return r.safeGet(this._options,"async",!1)?this.notifyAsync(e,...t):this.notifySync(e,...t)}notifySync(e,...t){let r=Promise.resolve();for(let i=0;i<this._observers.length;i++)r=r.then((()=>{if(this._filter(e,this._observers[i],...t))return this._observers[i].handler(e,this._observers[i],...t)}));return r}notifyAsync(e,...t){for(let r=0;r<this._observers.length;r++)this._filter(e,this._observers[r],...t)&&this._observers[r].handler(e,this._observers[r],...t);return Promise.resolve()}mute(){this._options.notifyOnChange=!1}unmute(){this._options.notifyOnChange=!0}#e(e,t,i){return i=i||{},r.assert(e&&"object"==typeof e&&t&&"object"==typeof t,(()=>"ObservableStore.#__deepMerge(): Parameters must be an object."),TypeError),Object.keys(t).forEach((a=>{Array.isArray(e[a])?(e[a]=e[a].concat(t[a]),i[a]=e[a]):e.hasOwnProperty(a)&&e[a]&&"object"==typeof e[a]&&t[a]&&"object"==typeof t[a]&&!(e[a]instanceof HTMLElement)?r.deepMerge(e[a],t[a]):e[a]!==t[a]&&(e[a]=t[a],i[a]=e[a])})),e}}class FormatterUtil{static format(e,t,r){r=r||{};let i=t,a=FormatterUtil.#t(e,"-"),s=a[0],o=a.length>1?a[1]:"";switch(s){case"date":case"datetime":case"time":i=this.formatDate(s,o,t,r);break;case"price":i=this.formatPrice(s,o,t,r);break;case"number":i=this.formatNumber(s,o,t,r);break;default:"`"===e.charAt(0)&&(i=this.interpolateResources(e,t,r),i=this.interpolate(i,r),i=this.interpolateValue(i,t,r))}return String(i)}static formatPrice(e,t,r,i){let a=r;return r&&(r=parseInt(r).toLocaleString(navigator.language)),a||""}static formatNumber(e,t,r,i){let a=r;return r&&(r=parseInt(r).toLocaleString(navigator.language)),a||""}static formatDate(e,t,r,i){let a,s=r,o=t;if(a=8===r.length?new Date(`${r.substr(0,4)}-${r.substr(4,2)}-${r.substr(6,2)}`):new Date(r),""===t)s=a.toString();else{let e=String(a.getFullYear()),t=String(1+a.getMonth()),r=String(a.getDate()),i=String(a.getHours()),n=String(a.getMinutes()),l=String(a.getSeconds());s=o,s=s.replace(/YYYY/g,e.padStart(4,"0")),s=s.replace(/YY/g,e.slice(-2).padStart(2,"0")),s=s.replace(/MM/g,t.padStart(2,"0")),s=s.replace(/M/g,t.padStart(1,"0")),s=s.replace(/DD/g,r.padStart(2,"0")),s=s.replace(/D/g,r.padStart(1,"0")),s=s.replace(/hh/g,i.padStart(2,"0")),s=s.replace(/h/g,i.padStart(1,"0")),s=s.replace(/mm/g,n.padStart(2,"0")),s=s.replace(/m/g,n.padStart(1,"0")),s=s.replace(/ss/g,l.padStart(2,"0")),s=s.replace(/s/g,l.padStart(1,"0"))}return s||""}static deformat(e,t,r){let i=t;switch(e){case"yyyy/mm/dd":i=this.deformatDate(e,t);break;case"price":i=this.deformatPrice(e,t)}return i}static deformatPrice(e,t,r){var i="";return t&&(i=t.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"").replace("Â¥","")),i}static deformatDate(e,t,r){var i="";return t&&(i=t.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"")),i}static getNow(e,t,r){t=t||"-";var i=new Date;return i.getFullYear()+t+("00"+(i.getMonth()+1)).slice(-2)+t+("00"+i.getDate()).slice(-2)+" "+("00"+i.getHours()).slice(-2)+":"+("00"+i.getMinutes()).slice(-2)+":"+("00"+i.getSeconds()).slice(-2)}static getToday(e,t,r){t=void 0===t?"-":t;var i=new Date;return i.getFullYear()+t+("00"+(i.getMonth()+1)).slice(-2)+t+("00"+i.getDate()).slice(-2)}static sanitize(e,t){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):e}static interpolate(e,t){let r=e,i=t.interpolation;return i&&e.indexOf("${")>-1&&(r=r.replace(/\$\{(.+)\}/g,((e,r)=>{let a=FormatterUtil.#t(r,":"),s=i[a[0]];return s?s&&a.length>1&&(s=this.format(a[1],s,t)):s="${"+r+"}",s||""}))),r}static interpolateValue(e,t,r){let i=e;return e.indexOf("${value")>-1&&(i=i.replace(/\$\{value(.*)\}/g,((e,i)=>{let a=FormatterUtil.#t(i,":"),s=t;return a.length>1&&(s=this.format(a[1],t,r)),s||""}))),i}static interpolateResources(e,t,r){let i=e,a=r.resources;return a&&e.indexOf("#{")>-1&&(i=e.replace(/\#\{(.+)\}/g,((e,r)=>{let i=r.split("."),s=i[0],o=i[1];return FormatterUtil.#r(a,s,t,o)||""}))),i}static#r(e,t,r,i){let a=r;if(e&&t in e){let s=e[t].getItem(r);s&&(a=s[i])}return a}static#t(e,t){let r=[],i=e.indexOf(t);return i>-1?(r.push(e.substring(0,i)),r.push(e.substring(i+1))):r.push(e),r}}class ValueUtil{static get attributeName(){return"bm-bind"}static get formatter(){return FormatterUtil}static setFields(e,t,i){let a=r.scopedSelectorAll(e,`[${this.attributeName}]`);e.matches(`[${this.attributeName}]`)&&a.push(e),a.forEach((e=>{let a;a=e.hasAttribute(`${this.attributeName}-in`)?this.getValue(e):r.safeGet(t,e.getAttribute(this.attributeName)),void 0!==a&&this.setValue(e,a,i)}))}static getFields(e,t){let i={},a=r.scopedSelectorAll(e,`[${this.attributeName}]`);return e.matches(`[${this.attributeName}]`)&&a.push(e),a.forEach((e=>{let t=e.getAttribute(this.attributeName),r=this.getValue(e);if(Array.isArray(i[t]))r&&i[t].push(r);else if(i[t]){if(r){let e=[];e.push(i[t]),e.push(r),i[t]=e}}else i[t]=r})),i}static clearFields(e,t){let i=r.safeGet(t,"target",""),a=r.scopedSelectorAll(e,`${i} input`,t);a.forEach((e=>{this.clearValue(e,t)})),a=r.scopedSelectorAll(e,`${i} select`,t),a.forEach((e=>{this.clearValue(e,t)}))}static setValue(e,t,r){r=r||{};let i=null==t?"":t;e.hasAttribute(`${this.attributeName}-format`)&&!e.hasAttribute(`${this.attributeName}-formatted`)&&(i=this.formatter.format(e.getAttribute(`${this.attributeName}-format`),t,r),e.setAttribute(`${this.attributeName}-formatted`,"")),"string"==typeof i&&"`"===i.charAt(0)&&(i=this.formatter.interpolateResources(i,t,r),i=this.formatter.interpolate(i,r),i=this.formatter.interpolateValue(i,t,r),i=i.replace(/^`|`$/g,""));let a=e.getAttribute(`${this.attributeName}-out`);if(a?this._setValue_target(e,a,i):e.hasAttribute("value")?this._setValue_value(e,i):this._setValue_element(e,i),r.triggerEvent){let t=new CustomEvent("change",{detail:r.triggerOptions});e.dispatchEvent(t)}}static getValue(e,t){let r,i=e.getAttribute(`${this.attributeName}-in`);return r=i?this._getValue_target(e,i):this._getValue_element(e),e.hasAttribute(`${this.attributeName}-format`)&&(r=this.formatter.deformat(e.getAttribute(`${this.attribueName}-format`),r)),r}static clearValue(e,t){switch(e.type.toLowerCase()){case"select-one":case"select-multiple":e.selectedIndex=-1;break;case"checkbox":case"radio":e.checked=!1;break;default:e.value=""}if(t&&t.triggerEvent){let r=new CustomEvent("change",{detail:t.triggerOptions});e.dispatchEvent(r)}}static _setValue_target(e,t,r){let i=t.split(",");for(let t=0;t<i.length;t++){let a=i[t].toLowerCase();switch(a){case"text":e.innerText=r;break;case"html":e.innerHTML=r;break;case"outerhtml":e.outerHTML=r;break;default:e.setAttribute(a,r)}}}static _setValue_value(e,t){"input"===e.tagName.toLowerCase()&&"checkbox"===e.type.toLowerCase()||"input"===e.tagName.toLowerCase()&&"radio"===e.type.toLowerCase()?Array.isArray(t)?t.indexOf(e.getAttribute("value"))>-1&&(e.checked=!0):e.getAttribute("value")===t&&(e.checked=!0):e.setAttribute("value",t)}static _setValue_element(e,t){switch(e.tagName.toLowerCase()){case"select":e.value=t;break;case"input":switch(e.type.toLowerCase()){case"number":case"search":case"text":e.value=t;break;case"checkbox":e.checked=!(!t||"0"==t);break;case"radio":e.value===t&&(e.checked=!0)}break;default:e.innerText=t}}static _getValue_target(e,t){let r;if("text"===(t=t.toLowerCase()))r=e.innerText;else e.getAttribute(t);return r}static _getValue_element(e){let t;switch(e.tagName.toLowerCase()){case"input":switch(e.type.toLowerCase()){case"radio":case"checkbox":t=!!e.checked&&(!e.hasAttribute("value")||e.getAttribute("value"));break;default:t=e.value}break;case"select":t=e.value;break;default:t=e.hasAttribute("selected")?e.getAttribute("value"):e.textContent}return t}}class BindableStore extends t{constructor(e){super(Object.assign({},e)),this._elems={},this._valueHandler=r.safeGet(e,"valueHandler",ValueUtil)}clear(...e){return super.clear(),this._notify("*",...e)}replace(e,...t){return this._items=e,Object.keys(this._items).forEach((e=>{if(this._elems[e]&&this._elems[e].callback){let t=this._items[e];this._items[e]=this._elems[e].callback(t,{changedItem:{[e]:t}})}})),this._notify(e)}set(e,t,r,...i){return this._elems[e]&&this._elems[e].callback&&(t=this._elems[e].callback(t,{changedItem:{[e]:t}})),super.set(e,t),this._notify({[e]:t},...i)}bindTo(e,t,r){if(!!(!t.__bm_bindinfo||!t.__bm_bindinfo.bound)){this._elems[e]=this._elems[e]||{elements:[]},this._elems[e].elements.push(t),this._elems[e].callback=r;let i=this._options.direction;if("two-way"===i||"one-way-reverse"===i){let r=this._options.eventName||"change";t.addEventListener(r,(r=>{(!r.detail||r.detail&&"store"!==r.detail.triggeredBy)&&this.set(e,this._valueHandler.getValue(t),null,t)}).bind(this))}t.__bm_bindinfo={bound:!0}}}_notify(e,...t){if("one-way-reverse"!==this._options.direction)return this._notifyAsync(e,...t)}_notifyAsync(e,t,...r){return Object.keys(e).forEach((e=>{if(this._elems[e]){let r=this.get(e);for(let i=0;i<this._elems[e].elements.length;i++)this._elems[e].elements[i]!==t&&this._valueHandler.setValue(this._elems[e].elements[i],r,{resources:this._options.resources,triggerEvent:!0,triggerOptions:{triggeredBy:"store"}})}})),Promise.resolve()}}class BindableArrayStore extends ArrayStore{constructor(e){super(Object.assign({},e)),this._elems={},this._valueHandler=r.safeGet(e,"valueHandler",ValueUtil)}clear(e,...t){super.clear(...t)}replace(e,t,...r){if(this._items[e]=t,this._elems[e])return Object.keys(this._items[e]).forEach((t=>{if(this._elems[e][t]&&this._elems[e][t].callback){let r=this._items[e][t];this._items[e][t]=this._elems[e][t].callback(r,{changedItem:{[t]:r}})}})),this._notify({index:e,values:t})}set(e,t,r,i,...a){return this._elems[e][t]&&this._elems[e][t].callback&&(r=this._elems[e][t].callback(r,{changedItem:{[t]:r}})),super.set(e,t,r),this._notify({index:e,values:{[t]:r}},...a)}bindTo(e,t,r,i){if(!!(!r.__bm_bindinfo||!r.__bm_bindinfo.bound)){this._elems[e]||(this._elems[e]={});let a=this._elems[e];a[t]=this._elems[e][t]||{elements:[]},a[t].elements.push(r),a[t].callback=i;let s=this._options.direction;if("two-way"===s||"one-way-reverse"===s){let i=this._options.eventName||"change";r.addEventListener(i,(i=>{(!i.detail||i.detail&&"store"!==i.detail.triggeredBy)&&this.set(e,t,this._valueHandler.getValue(r),null,r)}).bind(this))}r.__bm_bindinfo={bound:!0,index:e}}}_notify(e,...t){if("one-way-reverse"!==this._options.direction)return this._notifyAsync(e,...t)}_notifyAsync(e,t,...r){let i=e.index,a=e.values;return Object.keys(a).forEach((e=>{if(this._elems[i][e]){let r=this.get(i,e);for(let a=0;a<this._elems[i][e].elements.length;a++)this._elems[i][e].elements[a]!==t&&this._valueHandler.setValue(this._elems[i][e].elements[a],r,{resources:this._options.resources,triggerEvent:!0,triggerOptions:{triggeredBy:"store"}})}})),Promise.resolve()}}class FilePerk extends a{static#i={sectionName:"file",order:110};static get info(){return FilePerk.#i}static init(e,t){e.use("event.add","doApplySettings",{handler:FilePerk.#a,order:FilePerk.info.order})}static#a(e,t,i){let a=[];return Object.entries(r.safeGet(t.detail,"settings.file.targets",{})).forEach((([e,t])=>{a.push(s.loadScript(t.href))})),Promise.all(a)}}class ErrorPerk extends a{static#s=new WeakMap;static#i={sectionName:"error",order:120};static get info(){return ErrorPerk.#i}static#o(e,t,i){let a=this.get("setting","error.options.errorServer",this.get("setting","system.error.options.errorServer"));return a=!0===a?"bm-error":a,this.cast("status.wait",[a]).then((()=>{let e=document.querySelector(a);e.subscribe(this,r.safeGet(t.detail,"settings.error")),DialogPerk.#s.get(unit).server=e}))}}function c(){}c.showConditionalElements=function(e,t){r.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{let i=e.getAttribute("bm-visible");r.safeEval(i,t)?e.style.removeProperty("display"):e.style.display="none"}))},c.hideConditionalElements=function(e){r.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{e.style.display="none"}))},c.build=function(e,t,r){if("select"===e.tagName.toLowerCase())c._build_select(e,t,r)},c._build_select=function(e,t,r){if(r=r||{},e.options.length=0,"emptyItem"in r){let t="text"in r.emptyItem?r.emptyItem.text:"",i="value"in r.emptyItem?r.emptyItem.value:"",a=document.createElement("option");a.text=t,a.value=i,e.appendChild(a)}Object.keys(t).forEach((i=>{let a=document.createElement("option");a.text=r.text?t[i][r.text]:i,a.value=r.value?t[i][r.value]:i,e.appendChild(a)})),e.selectedIndex=-1,"defaultValue"in r&&(e.value=r.defaultValue)},c._build_radio=function(e,t,r){Object.keys(r.items).forEach((e=>{let t=document.createElement("label"),i=document.createElement("input");i.type="radio",i.id=key,i.name=key,i.value=e,i.setAttribute("bm-bind",key),i.setAttribute("bm-submit",""),t.appendChild(i),t.appendChild(document.createTextNode(r.items[e].title)),element.appendChild(t)}))};class ElementPerk extends a{static#s=new WeakMap;static#i={sectionName:"element",order:220};static get info(){return ElementPerk.#i}static init(e,t){ElementPerk.#s.set(e,{overlay:null,overlayPromise:Promise.resolve()}),e.use("event.add","doApplySettings",{handler:ElementPerk.#n,order:ElementPerk.info.order})}static#n(e,t,i){let a=ElementPerk.info.order;Object.entries(r.safeGet(t.detail,"settings.element.targets",{})).forEach((([e,t])=>{this.use("event.add",e,{handler:ElementPerk.ElementPerk_onDoProcess,order:a,options:{attrs:t}})}))}static ElementPerk_onDoProcess(e,t,r){let i=r.options.attrs,a=[];return Object.keys(i).forEach((e=>{a=a.concat(ElementPerk.#l(this,t,e,i[e]))})),Promise.all(a)}static#c(e,t,i){let a;return a=i.selector?"this"===i.selector||i.selector===e.tagName.toLowerCase()?[e]:r.scopedSelectorAll(e,i.selector):"this"===t||t===e.tagName.toLowerCase()?[e]:r.scopedSelectorAll(e,`#${t}`),a}static#l(e,t,r,i){let a=[],s=ElementPerk.#c(e,r,i);for(let o=0;o<s.length;o++){let n=s[o];Object.keys(i).forEach((t=>{switch(t){case"scroll":s[o].scrollTo(i[t]);break;case"showLoader":ElementPerk.#d(e,i[t]),n=ElementPerk.#s.get(e).overlay;break;case"hideLoader":ElementPerk.#u(e,i[t]),n=ElementPerk.#s.get(e).overlay;break;case"build":let r=i[t].resourceName;c.build(s[o],e.get("inventory",`resource.resources.${r}`).items,i[t]);break;case"attribute":ElementPerk.#g(s[o],i[t]);break;case"class":ElementPerk.#_(s[o],i[t]);break;case"style":Object.keys(i[t]).forEach((e=>{s[o].style[e]=i[t][e]}));break;case"property":Object.keys(i[t]).forEach((e=>{s[o][e]=i[t][e]}));break;case"autoFocus":s[o].focus()}})),i.waitFor&&a.push(ElementPerk.#h(e,t,r,i,n))}return a}static#h(e,t,i,a,s){let o=!1;switch(a.waitFor){case"transition":o="0s"!==window.getComputedStyle(s).getPropertyValue("transition-duration");break;case"animation":o="none"!==window.getComputedStyle(s).getPropertyValue("animation-name")}return r.warn(o,`ElementPerk.#__initAttr(): Element not in ${a.waitFor}. name=${e.tagName}, eventName=${t.type}, elementName=${i}`),new Promise(((r,o)=>{let n=setTimeout((()=>{o(`ElementPerk.#__initAttr(): Timed out waiting for ${a.waitFor}. name=${e.tagName}, eventName=${t.type}, elementName=${i}`)}),e.get("setting","status.options.waitForTimeout",e.get("setting","system.status.options.waitForTimeout",1e4)));s.addEventListener(`${a.waitFor}end`,(()=>{clearTimeout(n),r()}),{once:!0})}))}static#g(e,t){Object.keys(t).forEach((r=>{switch(r){case"add":Object.keys(t[r]).forEach((i=>{e.setAttribute(i,t[r][i])}));break;case"remove":for(let i=0;i<t[r].length;i++)e.removeAttribute(t[r][i])}}))}static#_(e,t){setTimeout((()=>{Object.keys(t).forEach((r=>{switch(r){case"add":e.classList.add(t[r]);break;case"remove":e.classList.remove(t[r]);break;case"replace":e.setAttribute("class",t[r])}}))}),1)}static#p(e,t){let r=ElementPerk.#s.get(e).overlay;return r||(r=document.createElement("div"),r.classList.add("overlay"),e.get("inventory","basic.unitRoot").appendChild(r),ElementPerk.#s.get(e).overlay=r),r}static#m(e,t){ElementPerk.#s.get(e).overlay.addEventListener("click",(t=>{t.target===t.currentTarget&&"function"==typeof e.close&&e.close({reason:"cancel"})}),{once:!0})}static#f(e){let t="";return"0s"!==window.getComputedStyle(e).getPropertyValue("transition-duration")?t="transition":"none"!==window.getComputedStyle(e).getPropertyValue("animation-name")&&(t="animation"),t}static#d(e,t){let i=ElementPerk.#p(e);r.safeGet(t,"closeOnClick")&&ElementPerk.#m(e),window.getComputedStyle(i).getPropertyValue("visibility");let a=["show"].concat(r.safeGet(t,"addClasses",[]));i.classList.add(...a),i.classList.remove(...r.safeGet(t,"removeClasses",[]));let s=ElementPerk.#f(i);s?ElementPerk.#s.get(e).overlayPromise.then((()=>{ElementPerk.#s.get(e).overlayPromise=new Promise(((e,t)=>{i.addEventListener(`${s}end`,(()=>{e()}),{once:!0})}))})):s=Promise.resolve()}static#u(e,t){let i=ElementPerk.#s.get(e).overlay;ElementPerk.#s.get(e).overlayPromise.then((()=>{window.getComputedStyle(i).getPropertyValue("visibility");let e=["show"].concat(r.safeGet(t,"removeClasses",[]));i.classList.remove(...e),i.classList.add(...r.safeGet(t,"addClasses",[]))}))}}class ResourcePerk extends a{static#i={sectionName:"resource",order:300};static#k={addHandler:ResourcePerk.#v};static get info(){return ResourcePerk.#i}static get spells(){return ResourcePerk.#k}static init(e,t){e.upgrade("inventory","resource.resources",{}),e.use("event.add","doApplySettings",{handler:ResourcePerk.#y,order:ResourcePerk.info.order}),e.use("event.add","doFetch",{handler:ResourcePerk.#P,order:ResourcePerk.info.order}),e.use("event.add","doSubmit",{handler:ResourcePerk.#b,order:ResourcePerk.info.order})}static#y(e,t,i){let a=[];return Object.entries(r.safeGet(t.detail,"settings.resource.handlers",{})).forEach((([e,t])=>{a.push(ResourcePerk.#v(this,e,t))})),Promise.all(a)}static#P(e,t,i){let a=[];return Object.keys(this.get("inventory","resource.resources")).forEach((e=>{let i=this.get("inventory",`resource.resources.${e}`);i.options.get("autoFetch",!0)&&(i.target.id=r.safeGet(t.detail,"id",i.target.id),i.target.parameters=r.safeGet(t.detail,"parameters",i.target.parameters),a.push(i.load(i.target.id,i.target.parameters).then((()=>{t.detail.items=i.items}))))})),Promise.all(a)}static#b(e,t,i){let a=[],s=r.safeGet(t.detail,"items");return Object.keys(this.get("inventory","resource.resources")).forEach((e=>{let i=this.get("inventory",`resource.resources.${e}`);if(i.options.get("autoSubmit",!0)){let o=r.safeGet(t.detail,"method",i.target.method||"update"),n=r.safeGet(t.detail,"id",i.target.id),l=r.safeGet(t.detail,"parameters",i.target.parameters);a.push(this.get("inventory",`resource.resources.${e}`)[o](n,s,l))}})),Promise.all(a)}static#v(e,t,i){r.assert(i.handlerClassName,(()=>`ResourcePerk.#_addHandler(): handler class name not specified. name=${e.tagName}, handlerName=${t}`));let a=Promise.resolve(),s=e.get("inventory",`resource.resources.${t}`);return s||(s=this.createHandler(i.handlerClassName,e,t,i),e.set("inventory",`resource.resources.${t}`,s),a=s.init(i)),a}}class ValidationPerk extends a{static#i={sectionName:"validation",order:310};static#k={addHandler:ValidationPerk._addHandler,validate:ValidationPerk._validate};static get info(){return ValidationPerk.#i}static get spells(){return ValidationPerk.#k}static init(e,t){e.upgrade("inventory","validation.validators",{}),e.upgrade("inventory","validation.validationResult",{}),e.use("event.add","doApplySettings",{handler:ValidationPerk.ValidationPerk_onDoApplySettings,order:ValidationPerk.info.order}),e.use("event.add","doValidate",{handler:ValidationPerk.ValidationPerk_onDoValidate,order:ValidationPerk.info.order}),e.use("event.add","doReportValidity",{handler:ValidationPerk.ValidationPerk_onDoReportValidity,order:ValidationPerk.info.order})}static ValidationPerk_onDoApplySettings(e,t,i){let a=[];return Object.entries(r.safeGet(t.detail,"settings.validation.handlers",{})).forEach((([e,t])=>{a.push(ValidationPerk._addHandler(this,e,t))})),Promise.all(a)}static ValidationPerk_onDoValidate(e,t,i){let a=t.detail.validatorName;if(a){r.assert(this.get("inventory",`validation.validators.${a}`),(()=>`ValidationPerk.ValidationPerk_onDoValidate(): Validator not found. name=${this.tagName}, validatorName=${a}`));let e=r.safeGet(t.detail,"items"),i=this.get("setting",`validation.handlers.${a}.rules`),s=this.get("setting",`validation.handlers.${a}.handlerOptions`);this.get("inventory",`validation.validators.${a}`).checkValidity(e,i,s)}}static ValidationPerk_onDoReportValidity(e,t,i){let a=t.detail.validatorName;if(a){r.assert(this.get("inventory",(()=>`validation.validators.${a}`)),`ValidationPerk.ValidationPerk_onDoReportValidity(): Validator not found. name=${this.tagName}, validatorName=${a}`);let e=r.safeGet(t.detail,"items"),i=this.get("setting",`validation.handlers.${a}.rules`),s=this.get("setting",`validation.handlers.${a}.handlerOptions`);this.get("inventory",`validation.validators.${a}`).reportValidity(e,i,s)}}static _addHandler(e,t,r){let i=Promise.resolve(),a=e.get("inventory",`validation.validators.${t}`);return r.handlerClassName&&!a&&(a=this.createHandler(r.handlerClassName,e,t,r),e.set("inventory",`validation.validators.${t}`,a),i=a.init(r)),i}static _validate(e,t){return t=t||{},e.set("inventory","validation.validationResult.result",!0),Promise.resolve().then((()=>e.cast("event.trigger","beforeValidate",t))).then((()=>e.cast("event.trigger","doValidate",t))).then((()=>e.get("inventory","validation.validationResult.result")?e.cast("event.trigger","doValidateSuccess",t):e.cast("event.trigger","doValidateFail",t))).then((()=>{if(!e.get("inventory","validation.validationResult.result"))return e.cast("event.trigger","doReportValidity",t)})).then((()=>e.cast("event.trigger","afterValidate",t)))}}class FormPerk extends a{static#s=new WeakMap;static#i={sectionName:"form",order:310,depends:"ValidationPerk"};static#R={build:FormPerk.#w};static#k={submit:FormPerk.#S};static get info(){return FormPerk.#i}static get skills(){return FormPerk.#R}static get spells(){return FormPerk.#k}static init(e,t){FormPerk.#s.set(e,{lastItems:{}}),e.upgrade("inventory","form.cancelSubmit",!1),e.use("event.add","afterTransform",{handler:FormPerk.#E,order:FormPerk.info.order}),e.use("event.add","doClear",{handler:FormPerk.#L,order:FormPerk.info.order}),e.use("event.add","beforeFill",{handler:FormPerk.#D,order:FormPerk.info.order}),e.use("event.add","doFill",{handler:FormPerk.#O,order:FormPerk.info.order}),e.use("event.add","doCollect",{handler:FormPerk.#A,order:FormPerk.info.order}),e.use("event.add","afterCollect",{handler:FormPerk.#N,order:FormPerk.info.order})}static#E(e,t,r){c.hideConditionalElements(this)}static#L(e,t,i){if(this.get("setting","form.options.autoClear",!0)){let e=r.safeGet(t.detail,"target",""),i=Object.assign({target:e,triggerEvent:"change"},t.detail.options);ValueUtil.clearFields(this,i)}}static#D(e,t,r){t.detail.refill&&(t.detail.items=FormPerk.#s.get(this).lastItems)}static#O(e,t,i){if(this.get("setting","form.options.autoFill",!0)){let e=t.detail&&"selector"in t.detail?r.scopedSelectorAll(this,t.detail.rootNode)[0]:this;ValueUtil.setFields(e,t.detail.items,{resources:this.get("inventory","resource.resources"),triggerEvent:!0}),c.showConditionalElements(this,t.detail.items)}FormPerk.#s.get(this).lastItems=t.detail.items}static#A(e,t,r){this.get("setting","form.options.autoCollect",!0)&&(t.detail.items=ValueUtil.getFields(this))}static#N(e,t,r){this.get("setting","form.options.autoCrop",!0)&&(t.detail.items=FormPerk.#C(this,t.detail.items))}static#w(e,t,r,i){c.build(t,r,i)}static async#S(e,t){t=t||{},e.set("inventory","form.cancelSubmit",!1),await FormPerk.#x(e,t),e.get("setting","form.options.autoValidate",!0)&&(t.validatorName=t.validatorName||e.get("setting","form.options.validatorName"),await e.cast("validation.validate",t),e.get("inventory","validation.validationResult.result")||e.set("inventory","form.cancelSubmit",!0)),await e.cast("event.trigger","beforeSubmit",t),e.get("inventory","form.cancelSubmit")||(await e.cast("event.trigger","doSubmit",t),await e.cast("event.trigger","afterSubmit",t))}static async#x(e,t){await e.cast("event.trigger","beforeCollect",t),await e.cast("event.trigger","doCollect",t),await e.cast("event.trigger","afterCollect",t)}static#C(e,t){let i={},a=r.scopedSelectorAll(e,"[bm-submit]");return a=Array.prototype.slice.call(a,0),a.forEach((e=>{let r=e.getAttribute("bm-bind");i[r]=t[r]})),i}}class ListPerk extends a{static#s=new WeakMap;static#i={sectionName:"list",order:310};static#R={get:ListPerk.#F,update:ListPerk.#V,add:ListPerk.#$};static#k={transformRow:ListPerk.#H};static get info(){return ListPerk.#i}static get skills(){return ListPerk.#R}static get spells(){return ListPerk.#k}static init(e,t){ListPerk.#s.set(e,{lastItems:{},listRootNode:null}),e.upgrade("inventory","list.active.skinName",""),e.use("event.add","afterTransform",{handler:ListPerk.#j,order:ListPerk.info.order}),e.use("event.add","doClear",{handler:ListPerk.#T,order:ListPerk.info.order}),e.use("event.add","beforeFill",{handler:ListPerk.#M,order:ListPerk.info.order}),e.use("event.add","doFill",{handler:ListPerk.#I,order:ListPerk.info.order})}static#j(e,t,i){let a=this.get("setting","list.options.listRootNode"),s=this.get("inventory","basic.unitRoot");return ListPerk.#s.get(this).listRootNode=a?r.scopedSelectorAll(s,a)[0]:s,r.assert(ListPerk.#s.get(this).listRootNode,(()=>`List.ListPerk_onAfterTransform(): List root node not found. name=${this.tagName}, listRootNode=${this.get("setting","setting.listRootNode")}`)),ListPerk.#H(this,this.get("setting","list.options.rowSkinName","row"))}static#T(e,t,r){ListPerk.#s.get(this).listRootNode.innerHTML="",this.set("inventory","list.rows",[])}static#M(e,t,r){t.detail.refill&&(t.detail.items=ListPerk.#s.get(this).lastItems)}static async#I(e,t,i){let a=r.safeGet(t.detail.options,"async",this.get("setting","list.options.async",!0))?ListPerk.#U:ListPerk.#G,s=document.createDocumentFragment();this.set("inventory","list.rows",[]),await this.cast("event.trigger","beforeBuildRows"),await a(this,s,t.detail.items,t.detail),ListPerk.#s.get(this).listRootNode.replaceChildren(s),ListPerk.#s.get(this).lastItems=t.detail.items,await this.cast("event.trigger","afterBuildRows")}static#$(e,t,r){(e.get("setting","list.options.async",!0)?ListPerk.#U:ListPerk.#G)(e,ListPerk.#s.get(e).listRootNode,t,r)}static async#V(e,t,r){let i={no:t,item:r},a=e.get("inventory","list.rows")[t];e.get("setting","list.options.async",!0)?(await e.cast("event.trigger","beforeFillRow",i),c.showConditionalElements(a,r),e.get("setting","list.options.autoFill",!0)&&ValueUtil.setFields(a,r,{resources:e.get("inventory","inventory","resource.resources")}),await e.cast("event.trigger","doFillRow",i),await e.cast("event.trigger","afterFillRow",i)):(e.use("event.triggerSync","beforeFillRow",i),c.showConditionalElements(a,r),e.get("setting","list.options.autoFill",!0)&&ValueUtil.setFields(a,r,{resources:e.get("inventory","resource.resources")}),e.use("event.triggerSync","doFillRow",i),e.use("event.triggerSync","afterFillRow",i))}static#F(e,t){let r=[],i=e.get("inventory","list.rows"),a=t&&t.shaper||(e=>e);for(let e=0;e<i.length;e++){let t=ValueUtil.getFields(i[e]);a(t),r.push(t)}return r}static async#H(e,t,r){if(r=r||{},e.get("inventory","list.active.skinName")===t)return Promise.resolve();await e.cast("skin.summon",t),e.set("inventory","list.active.skinName",t),await e.cast("event.trigger","afterTransformRow",r)}static#G(e,t,i,a){let s=e.get("inventory","skin.skins"),o=e.get("inventory","list.active.skinName"),n=e.get("inventory","list.rows",[]);r.assert(s[o],(()=>`List.#__buildSync(): Row skin not loaded yet. name=${e.tagName}, rowSkinName=${o}`));let l=e.get("setting","list.rowevents"),d=s[o].HTML,u=Promise.resolve();for(let r=0;r<i.length;r++)u=u.then((async()=>{a.no=r,a.item=i[r];let s=ListPerk.#q(d);t.appendChild(s),a.element=s,n.push(s),l&&Object.keys(l).forEach((t=>{e.use("event.init",t,l[t],s)})),await e.cast("event.trigger","beforeFillRow",a),e.get("setting","list.options.autoFill",!0)&&(c.showConditionalElements(s,a.item),ValueUtil.setFields(s,a.item,{resources:e.get("inventory","inventory","resource.resources")})),await e.cast("event.trigger","doFillRow",a),await e.cast("event.trigger","afterFillRow",a)}));return u.then((()=>{e.set("inventory","list.rows",n),delete a.no,delete a.item,delete a.element}))}static#U(e,t,i,a){a=a||{},i=i||[];let s=e.get("inventory","skin.skins"),o=e.get("inventory","list.active.skinName"),n=e.get("inventory","list.rows",[]);r.assert(s[o],(()=>`List.#__buildAsync(): Row skin not loaded yet. name=${e.tagName}, rowSkinName=${o}`));let l=e.get("setting","list.rowevents"),d=s[o].HTML;for(let r=0;r<i.length;r++){a.no=r,a.item=i[r];let s=ListPerk.#q(d);t.appendChild(s),a.element=s,n.push(s),l&&Object.keys(l).forEach((t=>{e.use("event.init",t,l[t],s)})),e.use("event.triggerSync","beforeFillRow",a),c.showConditionalElements(s,a.item),e.get("setting","list.options.autoFill",!0)&&ValueUtil.setFields(s,a.item,{resources:e.get("inventory","resource.resources")}),e.use("event.triggerSync","doFillRow",a),e.use("event.triggerSync","afterFillRow",a)}e.set("inventory","list.rows",n),delete a.no,delete a.item,delete a.element}static#q(e){let t=document.createElement("tbody");t.innerHTML=e;let r=t.firstElementChild;return r.setAttribute("bm-powered",""),r}static#C(e){let t=r.scopedSelectorAll(e,"[bm-bind]");return t=Array.prototype.slice.call(t,0),t.forEach((e=>{let t=e.getAttribute("bm-bind");items[t]})),submitItem}}class DatabindingPerk extends a{static#s=new WeakMap;static#i={sectionName:"databinding",order:320};static#R={};static get info(){return DatabindingPerk.#i}static init(e,t){"single"===e.get("setting","databinding.options.dataType","single")?(DatabindingPerk.#s.set(e,{store:new BindableStore({resources:e.get("inventory","resource.resources"),direction:e.get("setting","databinding.options.direction","two-way")})}),DatabindingPerk.#R.bindData=DatabindingPerk.#B,e.use("event.add","beforeTransform",{handler:DatabindingPerk.#K,order:DatabindingPerk.info.order}),e.use("event.add","doFill",{handler:DatabindingPerk.#z,order:DatabindingPerk.info.order})):(DatabindingPerk.#s.set(e,{store:new BindableArrayStore({resources:e.get("inventory","resource.resources"),direction:e.get("setting","databinding.options.direction","two-way")})}),DatabindingPerk.#R.bindData=DatabindingPerk.#W,e.use("event.add","doFillRow",{handler:DatabindingPerk.#J,order:DatabindingPerk.info.order})),e.use("event.add","doClear",{handler:DatabindingPerk.#Y,order:DatabindingPerk.info.order}),e.use("event.add","doCollect",{handler:DatabindingPerk.#X,order:DatabindingPerk.info.order})}static#K(e,t,r){DatabindingPerk.#B(this)}static#Y(e,t,r){DatabindingPerk.#s.get(this).store.clear()}static#z(e,t,r){t.detail.items&&(DatabindingPerk.#s.get(this).store.replace(t.detail.items),c.showConditionalElements(this,t.detail.items))}static#J(e,t,r){DatabindingPerk.#W(this,t.detail.no,t.detail.element,t.detail.callbacks),DatabindingPerk.#s.get(this).store.replace(t.detail.no,t.detail.item)}static#X(e,t,r){this.get("setting","databinding.options.autoCollect",!0)&&(t.detail.items=DatabindingPerk.#s.get(this).store.items)}static#B(e,t){t=t||e;let i=r.scopedSelectorAll(t,"[bm-bind]");i=Array.prototype.slice.call(i,0),t.matches("[bm-bind]")&&i.push(t),i.forEach((t=>{let r=t.getAttribute("bm-bind"),i=DatabindingPerk.#Q(e,r);DatabindingPerk.#s.get(e).store.bindTo(r,t,i)}))}static#W(e,t,i){i=i||e;let a=r.scopedSelectorAll(i,"[bm-bind]");a=Array.prototype.slice.call(a,0),i.matches("[bm-bind]")&&a.push(i),a.forEach((r=>{let i=r.getAttribute("bm-bind"),a=DatabindingPerk.#Q(e,i);DatabindingPerk.#s.get(e).store.bindTo(t,i,r,a)}))}static#Q(e,t){let r;return Object.entries(e.get("setting","databinding",{})).forEach((([e,i])=>{if(i.callback){const a=i.key||e;new RegExp(a).test(t)&&(r=i.callback)}})),r}}class LocaleServer extends o{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["LocaleServer_onBeforeStart"],doApplyLocale:["LocaleServer_onDoApplyLocale"]}}}},locale:{handlers:{default:{handlerClassName:"LocaleHandler"}}},skin:{options:{hasSkin:!1}},style:{options:{hasStyle:!1,styleRef:!1}}}}LocaleServer_onBeforeStart(e,t,r){this._store=new ObservableStore({async:!0})}LocaleServer_onDoApplyLocale(e,t,r){if(this.get("setting","options.autoAttribute")){let e=this.get("setting","options.autoAttribute.rootNode"),t=e?document.querySelector(e):document.body,r=this.get("setting","options.autoAttribute.attributeName","data-locale");t.setAttribute(r,this.get("inventory","locale.active.localeName"))}return this._store.notify("*",t.detail)}subscribe(e,t){this._store.subscribe(`${e.tagName}_${e.uniqueId}`,this.#Z.bind(e))}#Z(e,t,r){return this.cast("locale.apply",{localeName:r.localeName})}}customElements.define("bm-locale",LocaleServer);class LocalePerk extends a{static#s=new WeakMap;static#i={sectionName:"locale",order:215};static#R={localize:LocalePerk.#ee,translate:LocalePerk.#te};static#k={apply:LocalePerk.#re,summon:LocalePerk.#ie,addHandler:LocalePerk.#v};static get info(){return LocalePerk.#i}static get skills(){return LocalePerk.#R}static get spells(){return LocalePerk.#k}static init(e,t){LocalePerk.#s.set(e,{server:null}),e.upgrade("inventory","locale.localizers",{}),e.upgrade("inventory","locale.messages",new MultiStore),e.upgrade("inventory","locale.active",{localeName:e.get("setting","locale.options.localeName",e.get("setting","system.locale.options.localeName",navigator.language.substring(0,2))),fallbackLocaleName:e.get("setting","locale.options.fallbackLocaleName",e.get("setting","system.locale.options.fallbackLocaleName","en")),currencyName:e.get("setting","locale.options.currencyName",e.get("setting","system.locale.options.currencyName","USD"))}),e.use("event.add","doApplySettings",{handler:LocalePerk.#ae,order:LocalePerk.info.order}),e.use("event.add","doSetup",{handler:LocalePerk.#se,order:LocalePerk.info.order}),e.use("event.add","beforeApplyLocale",{handler:LocalePerk.#oe,order:LocalePerk.info.order}),e.use("event.add","doApplyLocale",{handler:LocalePerk.#ne,order:LocalePerk.info.order}),e.get("setting","locale.options.autoLocalizeRows")&&e.use("event.add","afterFillRow",{handler:LocalePerk.#le,order:LocalePerk.info.order})}static#ae(e,t,i){let a=[];Object.entries(r.safeGet(t.detail,"settings.locale.handlers",{})).forEach((([e,t])=>{a.push(LocalePerk.#v(this,e,t))}));let s=this.get("setting","locale.options.localeServer",this.get("setting","system.locale.options.localeServer"));return s=!0===s?"bm-locale":s,!s||this instanceof LocaleServer||a.push(this.cast("status.wait",[s]).then((()=>{let e=document.querySelector(s);e.subscribe(this),LocalePerk.#s.get(this).server=e;let t=e.get("inventory","locale.active");this.set("inventory","locale.active.localeName",t.localeName),this.set("inventory","locale.active.fallbackLocaleName",t.fallbackLocaleName),this.set("inventory","locale.active.currencyName",t.currencyName)}))),Promise.all(a)}static#se(e,t,r){return LocalePerk.#re(this,{localeName:this.get("inventory","locale.active.localeName")})}static#oe(e,t,r){return this.cast("locale.summon",t.detail.localeName)}static#ne(e,t,r){if(LocalePerk.#ee(this,this),"ready"===this.get("inventory","status.status"))return this.cast("basic.fill",{refill:!0})}static#le(e,t,r){LocalePerk.#ee(this,t.detail.element,t.detail.item)}static#ee(e,t,r){t=t||e,Object.keys(e.get("inventory","locale.localizers")).forEach((i=>{e.get("inventory",`locale.localizers.${i}`).localize(t,Object.assign({interpolation:r},e.get("inventory","locale.active")))}))}static#te(e,t,r){r=r||e.get("inventory","locale.active.localeName");let i=e.get("inventory","locale.messages").get(`${r}.${t}`);return void 0===i&&(i=e.get("inventory","locale.messages").get(`${e.get("inventory","locale.fallbackLocaleName")}.${t}`)),i}static#v(e,t,i){let a=Promise.resolve();if(!e.get("inventory",`locale.localizers.${t}`)){let s=r.safeGet(i,"handlerClassName","LocaleHandler"),o=this.createHandler(s,e,i);e.set("inventory",`locale.localizers.${t}`,o),a=o.init(i)}return a}static async#re(e,t){await e.cast("event.trigger","beforeApplyLocale",t),e.set("inventory","locale.active.localeName",t.localeName),await e.cast("event.trigger","doApplyLocale",t),await e.cast("event.trigger","afterApplyLocale",t)}static#ie(e,t,r){let i=[];return Object.keys(e.get("inventory","locale.localizers")).forEach((a=>{i.push(e.get("inventory",`locale.localizers.${a}`).loadMessages(t,r))})),Promise.all(i)}}class KeyPerk extends a{static#i={sectionName:"key",order:800};static get info(){return KeyPerk.#i}static init(e,t){e.upgrade("inventory","key.isComposing",!1),e.use("event.add","afterTransform",{handler:KeyPerk.#ce,order:KeyPerk.info.order})}static#ce(e,t,r){let i=this.get("setting","key.keys");if(i){let e=KeyPerk.#de(i);this.addEventListener("keydown",(function(e){KeyPerk.#ue.call(this,e,this)})),this.addEventListener("keyup",(function(t){KeyPerk.#ge.call(this,t,this,i,e)})),Object.entries(i).forEach((([e,t])=>{KeyPerk.#_e(this,e,t)}))}}static#ue(e,t){t.set("inventory","key.isComposing",229===e.keyCode)}static#ge(e,t,r,i){if(t.get("inventory","key.isComposing"))return;let a=e.key?e.key:KeyPerk.#he(e.keyCode);switch(a){case"Esc":a="Escape";break;case"Down":a="ArrowDown";break;case"Up":a="ArrowUp";break;case"Left":a="ArrowLeft";break;case"Right":a="ArrowRight"}a=a.toLowerCase(),i[a]&&i[a].handler.call(this,e,t,i[a].option)}static async#pe(e,t,r){await t.cast("form.submit"),t.get("inventory","form.cancelSubmit")||(t.get("inventory","dialog.isModal")&&t.set("inventory","dialog.modalResult.result",!0),r&&r.autoClose&&await t.cast("dialog.close",{reason:"submit"}))}static#me(e,t,r){return t.cast("dialog.close",{reason:"cancel"})}static#fe(e,t,r){let i="";return this.hasAttribute("bm-cleartarget")&&(i=this.getAttribute("bm-cleartarget")),t.cast("basic.clear",{target:i,options:r.options})}static#he(e){let t;if(13===e)t="Enter";else t=String.fromCharCode(e);return t}static#_e(e,t,i){if(i&&i.selector){let a=i.handler?i.handler:KeyPerk.#ke(t);r.scopedSelectorAll(e,i.selector).forEach((t=>{t.addEventListener("click",(function(t){a.call(this,t,e,i)}))}))}}static#de(e){let t={};return Object.keys(e).forEach((r=>{let i=Array.isArray(e[r].key)?e[r].key:[e[r].key];for(let a=0;a<i.length;a++)t[i[a]]={},t[i[a]].type=r,t[i[a]].handler=e[r].handler?e[r].handler:KeyPerk.#ke(r),t[i[a]].option=e[r]})),t}static#ke(e){let t;switch(e){case"submit":t=KeyPerk.#pe;break;case"clear":t=KeyPerk.#fe;break;case"cancel":t=KeyPerk.#me}return t}}class ChainPerk extends a{static#i={sectionName:"chain",order:800};static get info(){return ChainPerk.#i}static init(e,t){e.use("event.add","doApplySettings",{handler:ChainPerk.#ve,order:ChainPerk.info.order})}static deinit(t,r){let i=e.details.setting.chains;i&&Object.keys(i).forEach((e=>{t.removeEventHandler(e,{handler:ChainPerk.#ve,options:i[e]})}))}static#ve(e,t,i){let a=ChainPerk.info.order;Object.entries(r.safeGet(t.detail,"settings.chain.targets",{})).forEach((([e,t])=>{this.use("event.add",e,{handler:ChainPerk.#ye,order:a,options:t})}))}static#ye(e,t,i){let a=i.options,s=[],o=Promise.resolve();for(let e=0;e<a.length;e++){let i=a[e].skillName||"basic.refresh",n=a[e].status||"ready",l=a[e].sync,c=this.use("basic.locateAll",a[e]);r.warn(c.length>0,`ChainPerk.onDoProcess(): Node not found. name=${this.tagName}, eventName=${t.type}, rootNode=${JSON.stringify(a[e])}, method=${i}`),o=l?o.then((()=>ChainPerk.#Pe(this,c,i,n))):ChainPerk.#Pe(this,c,i,n),s.push(o)}return Promise.all(s)}static#Pe(e,t,r,i){let a=[];return t.forEach((t=>{let s=e.cast("status.wait",[{object:t,status:i}]).then((()=>t.cast(r,{sender:e})));a.push(s)})),Promise.all(a)}}let d=class DialogPerk extends a{static#be;static#s=new WeakMap;static#i={sectionName:"dialog",order:800};static#k={open:DialogPerk.#Re,openModal:DialogPerk.#we,close:DialogPerk.#Se};static get info(){return DialogPerk.#i}static get spells(){return DialogPerk.#k}static init(e,t){DialogPerk.#s.set(e,{backdrop:null,backdropPromise:Promise.resolve(),modalPromise:null}),e.upgrade("inventory","dialog.cancelClose"),e.upgrade("inventory","dialog.isModal",!1),e.upgrade("inventory","dialog.modalResult",{}),e.upgrade("inventory","dialog.options"),e.use("event.add","afterReady",{handler:DialogPerk.#Ee,order:DialogPerk.info.order})}static#Ee(e,t,r){if(this.get("setting","dialog.options.autoOpen"))return this.cast("dialog.open")}static async#Re(e,t){t=t||{},e.set("inventory","dialog.options",t),await e.cast("event.trigger","beforeOpen",t),e.get("inventory","dialog.cancelOpen")||(e.get("setting","dialog.options.showBackdrop")&&await DialogPerk.#Le(e,e.get("setting","dialog.backdropOptions")),r.safeGet(t,"autoSetupOnOpen",e.get("setting","dialog.options.autoSetupOnOpen",!1))&&await e.cast("basic.setup",t),r.safeGet(t,"autoRefreshOnOpen",e.get("setting","dialog.options.autoRefreshOnOpen",!0))&&await e.cast("basic.refresh",t),await e.cast("event.trigger","doOpen",t),await e.cast("event.trigger","afterOpen",t))}static#we(e,t){return new Promise(((r,i)=>(e.set("inventory","dialog.isModal",!0),e.set("inventory","dialog.modalResult",{result:!1}),DialogPerk.#s.get(e).modalPromise={resolve:r,reject:i},DialogPerk.#Re(e,t))))}static async#Se(e,t){t=t||{},e.set("inventory","dialog.cancelClose",!1),await e.cast("event.trigger","beforeClose",t),e.get("inventory","dialog.cancelClose")||(await e.cast("event.trigger","doClose",t),e.get("setting","dialog.options.showBackdrop")&&(DialogPerk.#De(),await DialogPerk.#Oe(e,e.get("setting","dialog.backdropOptions"))),e.get("inventory","dialog.isModal")&&DialogPerk.#s.get(e).modalPromise.resolve(e.get("inventory","dialog.modalResult")),await e.cast("event.trigger","afterClose",t))}static#Ae(e,t){DialogPerk.#be||(document.body.insertAdjacentHTML("afterbegin",'<div class="backdrop"></div>'),DialogPerk.#be=document.body.firstElementChild)}static#Le(e,t){return DialogPerk.#Ae(e),DialogPerk.#s.get(e).backdropPromise.then((()=>{if(DialogPerk.#s.get(e).backdropPromise=new Promise(((i,a)=>{window.getComputedStyle(DialogPerk.#be).getPropertyValue("visibility");let s=["show"].concat(e.get("setting","dialog.backdropOptions.showOptions.addClasses",[]));DialogPerk.#be.classList.add(...s),DialogPerk.#be.classList.remove(...e.get("setting","dialog.backdropOptions.showOptions.removeClasses",[]));let o=DialogPerk.#f();o?DialogPerk.#be.addEventListener(`${o}end`,(()=>{r.safeGet(t,"closeOnClick",!0)&&DialogPerk.#Ne(e),i()}),{once:!0}):(r.safeGet(t,"closeOnClick",!0)&&DialogPerk.#Ne(e),i())})),r.safeGet(t,"showOptions.sync",r.safeGet(t,"sync")))return DialogPerk.#s.get(e).backdropPromise}))}static#Oe(e,t){return DialogPerk.#s.get(e).backdropPromise.then((()=>{if(DialogPerk.#s.get(e).backdropPromise=new Promise(((t,r)=>{window.getComputedStyle(DialogPerk.#be).getPropertyValue("visibility");let i=["show"].concat(e.get("setting","dialog.backdropOptions.hideOptions.removeClasses",[]));DialogPerk.#be.classList.remove(...i),DialogPerk.#be.classList.add(...e.get("setting","dialog.backdropOptions.hideOptions.addClasses",[]));let a=DialogPerk.#f();a?DialogPerk.#be.addEventListener(`${a}end`,(()=>{t()}),{once:!0}):t()})),r.safeGet(t,"hideOptions.sync",r.safeGet(t,"sync")))return DialogPerk.#s.get(e).backdropPromise}))}static#Ne(e,t){DialogPerk.#be.onclick=t=>{t.target===t.currentTarget&&DialogPerk.#Se(e,{reason:"cancel"})}}static#De(){DialogPerk.#be.onclick=null}static#f(){let e="";return"0s"!==window.getComputedStyle(DialogPerk.#be).getPropertyValue("transition-duration")?e="transition":"none"!==window.getComputedStyle(DialogPerk.#be).getPropertyValue("animation-name")&&(e="animation"),e}};class PreferencePerk extends a{static#s=new WeakMap;static#i={sectionName:"preference",order:900};static#R={get:PreferencePerk.#Ce};static#k={set:PreferencePerk.#xe,apply:PreferencePerk.#Fe};static get info(){return PreferencePerk.#i}static get skills(){return PreferencePerk.#R}static get spells(){return PreferencePerk.#k}static init(e,t){PreferencePerk.#s.set(e,{server:null}),e.use("event.add","doApplySettings",{handler:PreferencePerk.#Ve,order:PreferencePerk.info.order}),e.use("event.add","doSetup",{handler:PreferencePerk.#$e,order:PreferencePerk.info.order})}static#Ve(e,t,i){let a=this.get("setting","preference.options.preferenceServer",this.get("setting","system.preference.options.preferenceServer"));return a=!0===a?"bm-preference":a,r.assert(a,(()=>`Preference Server node not specified in settings. name=${this.tagName}`)),this.cast("status.wait",[a]).then((()=>{let e=document.querySelector(a);e.subscribe(this,r.safeGet(t.detail,"settings.preference")),PreferencePerk.#s.get(this).server=e}))}static#$e(e,t,r){return this.cast("preference.apply",{preferences:PreferencePerk.#s.get(this).server.items})}static#Ce(e,t,r){return t?PreferencePerk.#s.get(e).server.getPreference(t,r):PreferencePerk.#s.get(e).server.items}static async#Fe(e,t){await e.cast("event.trigger","beforeApplyPreferences",t),await e.cast("event.trigger","doApplyPreferences",t),await e.cast("event.trigger","afterApplyPreferences",t)}static#xe(e,t,r){return PreferencePerk.#s.get(e).server.setPreference(t,r,{sender:e})}}function u(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var i=e[r];if("*"!==i&&"+"!==i&&"?"!==i)if("\\"!==i)if("{"!==i)if("}"!==i)if(":"!==i)if("("!==i)t.push({type:"CHAR",index:r,value:e[r++]});else{var a=1,s="";if("?"===e[n=r+1])throw new TypeError('Pattern cannot start with "?" at '.concat(n));for(;n<e.length;)if("\\"!==e[n]){if(")"===e[n]){if(0==--a){n++;break}}else if("("===e[n]&&(a++,"?"!==e[n+1]))throw new TypeError("Capturing groups are not allowed at ".concat(n));s+=e[n++]}else s+=e[n++]+e[n++];if(a)throw new TypeError("Unbalanced pattern at ".concat(r));if(!s)throw new TypeError("Missing pattern at ".concat(r));t.push({type:"PATTERN",index:r,value:s}),r=n}else{for(var o="",n=r+1;n<e.length;){var l=e.charCodeAt(n);if(!(l>=48&&l<=57||l>=65&&l<=90||l>=97&&l<=122||95===l))break;o+=e[n++]}if(!o)throw new TypeError("Missing parameter name at ".concat(r));t.push({type:"NAME",index:r,value:o}),r=n}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),i=t.prefixes,a=void 0===i?"./":i,s="[^".concat(g(t.delimiter||"/#?"),"]+?"),o=[],n=0,l=0,c="",d=function(e){if(l<r.length&&r[l].type===e)return r[l++].value},u=function(e){var t=d(e);if(void 0!==t)return t;var i=r[l],a=i.type,s=i.index;throw new TypeError("Unexpected ".concat(a," at ").concat(s,", expected ").concat(e))},_=function(){for(var e,t="";e=d("CHAR")||d("ESCAPED_CHAR");)t+=e;return t};l<r.length;){var h=d("CHAR"),p=d("NAME"),m=d("PATTERN");if(p||m){var f=h||"";-1===a.indexOf(f)&&(c+=f,f=""),c&&(o.push(c),c=""),o.push({name:p||n++,prefix:f,suffix:"",pattern:m||s,modifier:d("MODIFIER")||""})}else{var k=h||d("ESCAPED_CHAR");if(k)c+=k;else if(c&&(o.push(c),c=""),d("OPEN")){f=_();var v=d("NAME")||"",y=d("PATTERN")||"",P=_();u("CLOSE"),o.push({name:v||(y?n++:""),pattern:v&&!y?s:y,prefix:f,suffix:P,modifier:d("MODIFIER")||""})}else u("END")}}return o}function g(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function _(e){return e&&e.sensitive?"":"i"}function h(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var i=r.strict,a=void 0!==i&&i,s=r.start,o=void 0===s||s,n=r.end,l=void 0===n||n,c=r.encode,d=void 0===c?function(e){return e}:c,u=r.delimiter,h=void 0===u?"/#?":u,p=r.endsWith,m="[".concat(g(void 0===p?"":p),"]|$"),f="[".concat(g(h),"]"),k=o?"^":"",v=0,y=e;v<y.length;v++){var P=y[v];if("string"==typeof P)k+=g(d(P));else{var b=g(d(P.prefix)),R=g(d(P.suffix));if(P.pattern)if(t&&t.push(P),b||R)if("+"===P.modifier||"*"===P.modifier){var w="*"===P.modifier?"?":"";k+="(?:".concat(b,"((?:").concat(P.pattern,")(?:").concat(R).concat(b,"(?:").concat(P.pattern,"))*)").concat(R,")").concat(w)}else k+="(?:".concat(b,"(").concat(P.pattern,")").concat(R,")").concat(P.modifier);else"+"===P.modifier||"*"===P.modifier?k+="((?:".concat(P.pattern,")").concat(P.modifier,")"):k+="(".concat(P.pattern,")").concat(P.modifier);else k+="(?:".concat(b).concat(R,")").concat(P.modifier)}}if(l)a||(k+="".concat(f,"?")),k+=r.endsWith?"(?=".concat(m,")"):"$";else{var S=e[e.length-1],E="string"==typeof S?f.indexOf(S[S.length-1])>-1:void 0===S;a||(k+="(?:".concat(f,"(?=").concat(m,"))?")),E||(k+="(?=".concat(f,"|").concat(m,")"))}return new RegExp(k,_(r))}(u(e,r),t,r)}function p(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,i=0,a=r.exec(e.source);a;)t.push({name:a[1]||i++,prefix:"",suffix:"",modifier:"",pattern:""}),a=r.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,r){var i=e.map((function(e){return p(e,t,r).source}));return new RegExp("(?:".concat(i.join("|"),")"),_(r))}(e,t,r):h(e,t,r)}class RoutePerk extends a{static#s=new WeakMap;static#i={sectionName:"routing",order:900,depends:"ValidationPerk"};static#R={addRoute:RoutePerk.#He,jumpRoute:RoutePerk.#je,refreshRoute:RoutePerk.#Te,replaceRoute:RoutePerk.#Me};static#k={switch:RoutePerk.#Ie,openRoute:RoutePerk.#Re,updateRoute:RoutePerk.#Ue,refreshRoute:RoutePerk.#Te,normalizeRoute:RoutePerk.#Ge};static get info(){return RoutePerk.#i}static get skills(){return RoutePerk.#R}static get spells(){return RoutePerk.#k}static globalInit(){history.replaceState(RoutePerk.#qe("connect"),null,null)}static init(e,t){RoutePerk.#s.set(e,{routes:[]}),e.upgrade("inventory","routing.routeInfo",{}),e.use("event.add","doApplySettings",{handler:RoutePerk.#Be,order:RoutePerk.info.order}),e.use("event.add","doStart",{handler:RoutePerk.#Ke,order:RoutePerk.info.order}),e.use("event.add","afterReady",{handler:RoutePerk.#ze,order:RoutePerk.info.order}),e.use("event.add","doValidateFail",{handler:RoutePerk.#We,order:RoutePerk.info.order}),e.use("event.add","doReportValidity",{handler:RoutePerk.#Je,order:RoutePerk.info.order}),RoutePerk.#Ye(e)}static#Be(e,t,i){Object.entries(r.safeGet(t.detail,"settings.routing.routes",{})).forEach((([e,t])=>{RoutePerk.#He(this,e,t)})),this.set("inventory","routing.routeInfo",RoutePerk.#Xe(this,window.location.href))}static#Ke(e,t,r){let i=this.get("inventory","routing.routeInfo.name");if(i){let e={query:this.get("setting","unit.options.query")};return this.cast("routing.switch",i,e)}throw new Error("route not found")}static#ze(e,t,r){return this.cast("routing.openRoute")}static#We(e,t,r){this.get("setting","routing.options.autoFix")&&RoutePerk.#Qe(this,t.detail.url)}static#Je(e,t,r){throw RoutePerk.#Ze(this),new URIError("URL validation failed.")}static#He(e,t,r,i){let a=[],s={title:t,name:r.name||t,origin:r.origin,path:r.path,settingsRef:r.settingsRef,settings:r.settings,extenderRef:r.extenderRef,extender:r.extender,routeOptions:r.routeOptions,__re:p(r.path,a),__keys:a},o=RoutePerk.#s.get(e).routes;i?o.unshift(s):o.push(s)}static async#et(e,t,r){let i=await s.loadJSON(RoutePerk.#tt(e,t),Object.assign({bindTo:e},r));e.set("inventory","routing.routeInfo.settings",i)}static async#rt(e,t,r){if(!e.get("inventory","routing.routeInfo.extender")){let r=await s.loadText(RoutePerk.#it(e,t));e.set("inventory","routing.routeInfo.extender",r)}let i=e.get("inventory","routing.routeInfo.extender");i&&new Function(`"use strict";${i}`)()}static async#Ie(e,t,i){let a;r.assert(t,(()=>"RoutePerk.#_switchRoute(): A route name not specified."),TypeError),RoutePerk.#at(e,t)&&await RoutePerk.#et(e,t),RoutePerk.#st(e,t)&&await RoutePerk.#rt(e),a=e.get("inventory","routing.routeInfo.settings"),e.use("setting.merge",a),await e.cast("setting.apply",{settings:a}),await e.cast("basic.transform")}static async#Re(e,t,i){i=Object.assign({},i);let a,s,o=e.get("inventory","routing.routeInfo");if(t?(a=n.buildURL(t,i),s=RoutePerk.#Xe(e,a)):(a=window.location.href,s=o),!i.jump&&s.name&&o.name==s.name){if(r.safeGet(i,"pushState",!!t)&&history.pushState(RoutePerk.#qe("_open.pushState"),null,a),e.set("inventory","routing.routeInfo",s),e.get("setting","routing.options.autoValidate")){let t={validatorName:e.get("setting","routing.options.validatorName"),items:n.loadParameters(a),url:a};await e.cast("validation.validate",t)}await RoutePerk.#Te(e,s,i),await RoutePerk.#Ge(e,window.location.href)}else window.location.href=a}static#je(e,t,r){let i=n.buildURL(t,r);window.location.href=i}static#Ue(e,t,r,i){return RoutePerk.#Ie(e,r.name)}static#Te(e,t,r){return e.cast("basic.refresh",r)}static#Me(e,t,r){history.replaceState(RoutePerk.#qe("replaceRoute",window.history.state),null,n.buildURL(t,r)),e.set("inventory","routing.routeInfo",RoutePerk.#Xe(e,window.location.href))}static async#Ge(e,t){await e.cast("event.trigger","beforeNormalizeURL"),await e.cast("event.trigger","doNormalizeURL"),await e.cast("event.trigger","afterNormalizeURL")}static#at(e,t){let r=!1;return e.get("inventory","routing.routeInfo.settings")||(r=!0),r}static#tt(e,t){let i,a,s,o=e.get("inventory","routing.routeInfo.settingsRef");if(o&&!0!==o){let e=n.parseURL(o);a=e.filename,i=e.path,s=e.query}else{i=r.concatPath([e.get("setting","system.unit.options.path",""),e.get("setting","unit.options.path","")]);let o=RoutePerk.#ot(e);a=e.get("setting","unit.options.fileName",e.tagName.toLowerCase())+"."+t+".settings."+o,s=e.get("setting","unit.options.query")}return r.concatPath([i,a])+(s?`?${s}`:"")}static#st(e,t){let r=!1;return(e.get("inventory","routing.routeInfo.extenderRef")||e.get("inventory","routing.routeInfo.extender"))&&(r=!0),r}static#it(e,t){let i,a,s,o=e.get("inventory","routing.routeInfo.extenderRef");if(o&&!0!==o){let e=n.parseURL(o);i=e.path,a=e.filename,s=e.query}else i=i||r.concatPath([e.get("setting","system.unit.options.path",""),e.get("setting","unit.options.path","")]),a=a||e.get("setting","unit.options.fileName",e.tagName.toLowerCase())+"."+t+".js",s=e.get("setting","unit.options.query");return r.concatPath([i,a])+(s?`?${s}`:"")}static#Xe(e,t){let i=new URL(t,window.location.href),a={URL:t,path:i.pathname,query:i.search,parsedURL:i,queryParameters:n.loadParameters(t)},s=RoutePerk.#s.get(e).routes;for(let t=s.length-1;t>=0;t--){if(s[t].origin&&i.origin!=s[t].origin)continue;let o=s[t].path?s[t].__re.exec(i.pathname):[];if(o){let i={};for(let e=0;e<o.length-1;e++)i[s[t].__keys[e].name]=o[e+1];a.title=s[t].title;let n=RoutePerk.#nt(s[t].name,i);a.name=n;let l=r.safeGet(s[t],`routeOptions.${n}.settingsRef`,s[t].settingsRef);a.settingsRef=RoutePerk.#nt(l,i);let c=r.safeGet(s[t],`routeOptions.${n}.settings`,s[t].settings);a.settings=r.getObject(c,{format:RoutePerk.#ot(e)});let d=r.safeGet(s[t],`routeOptions.${n}.extenderRef`,s[t].extenderRef);a.extenderRef=RoutePerk.#nt(d,i),a.extender=r.safeGet(s[t],`routeOptions.${n}.extender`,s[t].extender),a.routeParameters=i;break}}return a}static#nt(e,t){let r=e;if(t&&"string"==typeof e&&e.indexOf("${")>-1){let i=new RegExp(`\\$\\{(${Object.keys(t).join("|")})\\}`,"gi");r=e.replace(i,(function(e,r){return t[r]}))}return r}static#Ye(e){window.addEventListener("popstate",(async t=>{await e.cast("event.trigger","beforePopState"),await RoutePerk.#Re(e,{url:window.location.href},{pushState:!1}),await e.cast("event.trigger","afterPopState")}))}static#qe(e,t){let i={msg:e};return t&&(i=r.deepMerge(r.deepClone(t),i)),i}static#Qe(e,t){let r=!0,i=n.loadParameters(t);Object.keys(e.get("inventory","validation.validationResult.invalids")).forEach((t=>{let a=e.get("inventory",`validation.validationResult.invalids.${t}`);void 0!==a.fix?i[a.key]=a.fix:"notAllowed"===a.failed[0].validity?delete i[a.key]:r=!1})),r&&(RoutePerk.#Me(e,{queryParameters:i}),e.set("inventory","validation.validationResult.result",!0))}static#Ze(e){Object.keys(e.get("inventory","validation.validationResult.invalids")).forEach((t=>{let r=e.get("inventory",`validation.validationResult.invalids.${t}`);if(r.failed)for(let e=0;e<r.failed.length;e++);}))}static#ot(e){return e.get("setting","routing.options.settingFormat",e.get("setting","system.setting.options.settingFormat","json"))}}class ResourceHandler{constructor(e,r,i){i=i||{},this._resourceName=r,this._unit=e,this._options=new t({items:i}),this._data={},this._items=[],this._target={},this._currentIndex=0}get resourceName(){return this._resourceName}set resourceName(e){this._resourceName=e}get target(){return this._target}get data(){return this._data}set data(e){this._data=e,this._items=this.#lt(e)}get items(){return this._items}get options(){return this._options}init(e){if(this._options.get("autoLoad")){let e=this._options.get("autoLoadOptions.id"),t=this._options.get("autoLoadOptions.parameters");return this.load(e,t)}}load(e,t){return Promise.resolve().then((()=>this._load(e,t))).then((e=>(this.data=e,this._data)))}remove(e,t){return this._remove(e,t)}add(e,t,r){return this._add(e,this.#ct(t),r)}update(e,t,r){return this._update(e,this.#ct(t),r)}getText(e){let t=e,r=this._options.get("fieldOptions.text");return this._items&&e in this._items&&(t=this._items[e][r]),t}getItem(e){let t;return this._items&&e in this._items&&(t=this._items[e]),t}_load(e,t){}_remove(e,t){}_add(e,t,r){}_update(e,t,r){}#lt(e){let t=this._options.get("fieldOptions.items"),i=t?r.safeGet(e,t):e;if(this._options.get("reshapeOptions.load.reshape")){i=this._options.get("reshapeOptions.load.reshaper",this.#dt.bind(this))(i)}return i}#ct(e){if(this._options.get("reshapeOptions.update.reshape")){let t=this._options.get("reshapeOptions.update.reshaper",(()=>e));e=t(e)}return e}#dt(e){let t;if(e){let r=this._options.get("fieldOptions.id");t=e.reduce(((e,t)=>(e[t[r]]=t,e)),{})}return t}}class LocaleFormatterUtil extends FormatterUtil{static formatPrice(e,t,r,i){let a=i&&i.localeName?i.localeName:navigator.language,s=i&&i.currencyName?i.currencyName:"USD";return new Intl.NumberFormat(a,{style:"currency",currency:s}).format(r)}static formatDate(e,t,r,i){let a=r;if(t)a=super.formatDate(e,t,r,i);else{let e,t=i&&i.localeName?i.localeName:navigator.language;e=8===r.length?new Date(`${r.substr(0,4)}-${r.substr(4,2)}-${r.substr(6,2)}`):new Date(r),a=new Intl.DateTimeFormat(t).format(e)}return a||""}}class LocaleValueUtil extends ValueUtil{static get attributeName(){return"bm-locale"}static get formatter(){return LocaleFormatterUtil}}class LocaleHandler{constructor(e,r){r=r||{},this._unit=e,this._options=new t({items:r}),this._messages=new l,this._valueHandler=this.options.get("valueHandler",LocaleValueUtil),this._localeInfo={}}get options(){return this._options}get messages(){return this._messages}init(e){if(this._unit.get("inventory","locale.messages").add(this._messages),e.messages){let t=r.getObject(e.messages,{format:this.#ut(this._unit)});this._messages.merge(t)}}has(e){return this._messages.has(e)}get(e,t){return t=e+(t?`.${t}`:""),this._messages.get(t)}localize(e,t){let r=this.get(t.localeName)||this.get(t.fallbackLocaleName);this._valueHandler.setFields(e,r,t)}loadMessages(e,t){let i=r.safeGet(t,"splitLocale",this._options.get("handlerOptions.splitLocale",this._unit.get("setting","system.locale.options.splitLocale")));e=i?e:"";let a=this._localeInfo[e]||{},o=Promise.resolve();if("loaded"===a.status)return o;if(this.#gt(this._unit)){let i=this.#_t(this._unit,e);o=s.loadJSON(i,t).then((t=>{a.messages=r.getObject(t,{format:this.#ut(this._unit)}),a.status="loaded",this._messages.merge(t),this._localeInfo[e]=a}))}return o}#gt(e){let t=!1;return(e.hasAttribute("bm-localeref")||this._options.get("handlerOptions.localeRef"))&&(t=!0),t}#_t(e,t){let i,a,s,o=e.hasAttribute("bm-localeref")?e.getAttribute("bm-localeref")||!0:this._options.get("handlerOptions.localeRef");if(o&&!0!==o){let e=n.parseURL(o);a=e.filename,i=e.path,s=e.query}else{i=r.concatPath([e.get("setting","system.locale.options.path",e.get("setting","system.unit.options.path","")),e.get("setting","locale.options.path",e.get("setting","unit.options.path",""))]),a=this._options.get("handlerOptions.fileName",e.get("setting","unit.options.fileName",e.tagName.toLowerCase()));let o=this.#ut(e);s=e.get("setting","unit.options.query"),t&&(a=t?`${a}.${t}`:a),a=`${a}.messages.${o}`}return r.concatPath([i,a])+(s?`?${s}`:"")}#ut(e){return this._options.get("messageFormat",e.get("setting","locale.options.messageFormat",e.get("setting","system.locale.options.messageFormat","json")))}}class ValidationHandler{constructor(e,r,i){i=i||{},this._unit=e,this._options=new t({items:i})}get options(){return this._options}init(e){}checkValidity(e,t,r){}reportValidity(e,t){}_validate(e,t,r){t=t||{};let i={};return(r=r||{}).allowList&&Object.keys(e).forEach((a=>{if(-1===r.allowList.indexOf(a)){let r=[{rule:"allowList",validity:"notAllowed"}];i[a]=this._createValidationResult(a,e[a],t[a],r)}})),r.allowOnlyInRules&&Object.keys(e).forEach((r=>{if(!(r in t)){let a=[{rule:"allowList",validity:"notAllowed"}];i[r]=this._createValidationResult(r,e[r],t[r],a)}})),r.disallowList&&Object.keys(e).forEach((a=>{if(r.disallowList.indexOf(a)>-1){let r=[{rule:"disallowList",validity:"disallowed"}];i[a]=this._createValidationResult(a,e[a],t[a],r)}})),Object.keys(t).forEach((r=>{if("constraints"in t[r]&&t[r].constraints&&"required"in t[r].constraints&&t[r].constraints.required&&!(r in e)){let a=[{rule:"required",validity:"valueMissing"}];i[r]=this._createValidationResult(r,e[r],t[r],a)}})),i}_createValidationResult(e,t,r,i,a){return{key:e,value:t,message:this._getFunctionValue(e,t,"message",r),fix:this._getFunctionValue(e,t,"fix",r),failed:i,extras:a}}_getFunctionValue(e,t,r,i){let a;return i&&r in i&&(a="function"==typeof i[r]?i[r](e,t,i):i[r]),a}}class PreferenceServer extends o{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["PreferenceServer_onBeforeStart"],beforeSubmit:["PreferenceServer_onBeforeSubmit"],doReportValidity:["PreferenceServer_onDoReportValidity"]}}}},form:{options:{autoCollect:!1,autoCrop:!1}},skin:{options:{hasSkin:!1}},style:{options:{hasStyle:!1}}}}get items(){return this._store.items}PreferenceServer_onBeforeStart=function(e,t,r){this._store=new ObservableStore({items:this.get("setting","options.defaults"),filter:this._filter,async:!0}),Object.keys(this.get("inventory","resource.resources",{})).forEach((e=>{this._store.merge(this.get("inventory",`resource.resources.${e}`).items)}))};PreferenceServer_onBeforeSubmit=function(e,t,r){this._store.set("",t.detail.items,t.detail.options,...t.detail.args),t.detail.items=this._store.items};PreferenceServer_onDoReportValidity=function(e,t,r){let i=`Invalid preference value. name=${this.tagName}`;Object.keys(this.get("inventory","validation.validationResult.invalids")).forEach((e=>{i+="\n\tkey="+this.get("inventory",`validation.validationResult.invalids.${e}.key`)+", value="+this.get("inventory",`validation.validationResult.invalids.${e}.value`)}))};subscribe(e,t){this._store.subscribe(`${e.tagName}_${e.uniqueId}`,this._triggerEvent.bind(e),t)}getPreference(e,t){return this._store.get(e,t)}setPreference(e,t,...r){let i=this.get("setting","options.validatorName");return this.cast("form.submit",{items:e,options:t,args:r,validatorName:i})}_triggerEvent(e,t,i){let a=r.safeGet(i,"sender",this);return this.cast("preference.apply",{sender:a,preferences:e})}_filter(e,t,...r){let i=!1,a=t.options.targets;a=Array.isArray(a)?a:[a];for(let t=0;t<a.length;t++)if(e[a[t]]){i=!0;break}return i}}customElements.define("bm-preference",PreferenceServer);class ErrorServer extends o{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["ErrorServer_onBeforeStart"]}}}},skin:{options:{hasSkin:!1}},style:{options:{hasStyle:!1}}}}ErrorServer_onBeforeStart(e,t,r){this._observers=new ObservableStore({filter:this.#ht}),this.#pt()}#ht(e,t,...r){let i=!1,a=t.options.unit.get("setting","errors.targets"),s=r[0].error;for(let e=0;e<a.length;e++)if(s.name===a[e]||"*"===a[e]){i=!0;break}return i}#pt(){window.addEventListener("unhandledrejection",this.#mt.bind(this)),window.addEventListener("error",this.#ft.bind(this))}#mt(e){let t={};try{e.reason?e.reason instanceof XMLHttpRequest?(t.message=e.reason.statusText,t.stack=e.reason.stack,t.object=e.reason):(t.message=e.reason.message,t.object=e.reason):t.message=e,t.type=e.type,t.name=this.#kt(e),t.filename="",t.funcname="",t.lineno="",t.colno="",this.#vt(t)}catch(t){}return!0}#ft(e,t,r,i){let a={};try{a.type="error",a.name=this.#kt(e),a.message=e.message,a.file=e.filename,a.line=e.lineno,a.col=e.colno,e.error&&(a.stack=e.error.stack,a.object=e.error),this.#vt(a)}catch(a){}return!0}#kt(e){let t,r;if(r=e.reason instanceof XMLHttpRequest||e.reason?e.reason:e.error?e.error:e.message,r.name)t=r.name;else if(r instanceof TypeError)t="TypeError";else if(r instanceof XMLHttpRequest)t="AjaxError";else if(r instanceof EvalError)t="EvalError";else if(r instanceof RangeError)t="RangeError";else if(r instanceof ReferenceError)t="ReferenceError";else if(r instanceof SyntaxError)t="SyntaxError";else if(r instanceof URIError)t="URIError";else{let e=r.indexOf(":");e>-1&&(t=r.substring(0,e))}return t}#vt(e){let t=e.object.status,r=this.get("setting","handlers");return Object.keys(r.statusCode).forEach((e=>{t==e&&Object.keys(r.statusCode[e]).forEach((t=>{let i=r.statusCode[e][t];if("route"===t){let e=i.routeInfo;Object.keys(e.queryParameters).forEach((t=>{e.queryParameters[t]=e.queryParameters[t].replace("@URL@",location.href)})),window.location.href=n.buildURL(e)}}))})),this._observers.notifyAsync("error",{sender:this,error:e})}}customElements.define("bm-error",ErrorServer);class Router extends o{_getSettings(){return{basic:{options:{autoRefresh:!1,autoFetch:!1,autoClear:!1,autoFill:!1}},skin:{options:{hasSkin:!1}},style:{options:{hasStyle:!1}},routing:{}}}}customElements.define("bm-router",Router),a.registerPerk(FilePerk),a.registerPerk(ErrorPerk),a.registerPerk(ElementPerk),a.registerPerk(ResourcePerk),a.registerPerk(ValidationPerk),a.registerPerk(FormPerk),a.registerPerk(ListPerk),a.registerPerk(DatabindingPerk),a.registerPerk(LocalePerk),a.registerPerk(KeyPerk),a.registerPerk(ChainPerk),a.registerPerk(d),a.registerPerk(PreferencePerk),a.registerPerk(RoutePerk),a.registerHandler(class CookieResourceHandler extends ResourceHandler{constructor(e,t,i){super(e,t,Object.assign({autoLoad:!0,autoFetch:!1},i)),this._cookieName=r.safeGet(i,"cookieOptions.name","preferences")}_load(e,t){return this.#yt(this._cookieName)}_add(e,t,r){this.#Pt(this._cookieName,t)}_update(e,t,r){this.#Pt(this._cookieName,t)}#yt(e){let t=document.cookie.split(";").reduce(((e,t)=>{const[r,i]=t.split("=");return r&&(e[r.trim()]=i?decodeURIComponent(i.trim()):void 0),e}),{});return t[e]?JSON.parse(t[e]):{}}#Pt(e,t){let r=e+`=${encodeURIComponent(JSON.stringify(t))}; `,i=this._options.get("cookieOptions");r+=Object.keys(i).reduce(((e,t)=>e+=`${t}=${i[t]}; `),""),document.cookie=r}},"ResourcePerk"),a.registerHandler(class APIResourceHandler extends ResourceHandler{_load(e,t){let r="GET",i=this._getOption("headers",r),a=this._getOption("options",r),o=this._getOption("URL",r),n=o.dataType,l=this._buildApiUrl(this._resourceName,e,t,o);return s.ajaxRequest({URL:l,method:r,headers:i,options:a}).then((e=>this._convertResponseData(e.responseText,n)))}_remove(e,t){let r="DELETE",i=this._getOption("headers",r),a=this._getOption("options",r),o=this._getOption("URL",r);o.dataType;let n=this._buildApiUrl(this._resourceName,e,t,o);return s.ajaxRequest({URL:n,method:r,headers:i,options:a})}_add(e,t,r){let i="POST",a=this._getOption("headers",i),o=this._getOption("options",i),n=this._getOption("URL",i),l=n.dataType,c=this._buildApiUrl(this._resourceName,e,r,n);return s.ajaxRequest({URL:c,method:i,headers:a,options:o,data:this._convertRequestData(t,l)})}_update(e,t,r){let i="PUT",a=this._getOption("headers",i),o=this._getOption("options",i),n=this._getOption("URL",i),l=n.dataType,c=this._buildApiUrl(this._resourceName,e,r,n);return s.ajaxRequest({URL:c,method:i,headers:a,options:o,data:this._convertRequestData(t,l)})}_convertRequestData(e,t){let r;return r=JSON.stringify(e),r}_convertResponseData(e,t){let r;return r=JSON.parse(e),r}_getOption(e,t){let r=this._options.get("ajaxOptions",{}),i=e in r&&"COMMON"in r[e]?r[e].COMMON:{},a=e in r&&t in r[e]?r[e][t]:{};return Object.assign(i,a)}_buildApiUrl(e,t,r,i){let a=i.baseURL||"",s=i.scheme||"",o=i.host||"",l=i.dataType||"",c=i.version||"";return(i.format||"").replace("@scheme@",s).replace("@host@",o).replace("@baseURL@",a).replace("@resource@",e).replace("@id@",t).replace("@dataType@",l).replace("@query@",n.buildQuery(r)).replace("@version@",c)}},"ResourcePerk"),a.registerHandler(class ObjectResourceHandler extends ResourceHandler{constructor(e,t,r){super(e,t,Object.assign({autoLoad:!0,autoFetch:!1,autoSubmit:!1},r)),r.items&&(this.data=r.items)}_load(e,t){return this._data}_update(e,t,r){this.data=t}},"ResourcePerk"),a.registerHandler(class LinkedResourceHandler extends ResourceHandler{constructor(e,t,r){super(e,t,Object.assign({autoLoad:!0,autoFetch:!1,autoSubmit:!1},r)),this._ref}get data(){return this._ref.data}set data(e){}get items(){return this._ref.items}getText(e){return this._ref.getText(e)}getItem(e){return this._ref.getItem(e)}_load(e,t){let r=this._options.get("selector"),i=this._options.get("resourceName")||this._resourceName;return this._unit.cast("status.wait",[r]).then((()=>(this._ref=document.querySelector(r).get("inventory","resource.resources")[i],this._ref)))}_remove(e,t){throw TypeError("LinkedResourceHandler is read only.")}_add(e,t,r){throw TypeError("LinkedResourceHandler is read only.")}_update(e,t,r){throw TypeError("LinkedResourceHandler is read only.")}},"ResourcePerk"),a.registerHandler(class WebStorageResourceHandler extends ResourceHandler{_load(e,t){let r,i=localStorage.getItem(e);return i&&(r=JSON.parse(i)),r}_remove(e,t){localStorage.removeItem(e)}_add(e,t,r){localStorage.setItem(e,JSON.stringify(t))}_update(e,t,r){localStorage.setItem(e,JSON.stringify(t))}},"ResourcePerk"),a.registerHandler(LocaleHandler,"LocalePerk"),a.registerHandler(class LocaleServerHandler extends LocaleHandler{init(e){let t=this._unit.get("setting","locale.options.localeServer",this._unit.get("setting","system.locale.options.localeServer"));return t=!0===t?"bm-locale":t,r.assert(t,(()=>`Locale Server node not specified in settings. name=${this._unit.tagName}`)),this._unit.cast("status.wait",[t]).then((()=>{let e=document.querySelector(t);this._messages.chain(e.get("inventory","locale.messages"))}))}loadMessages(e,t){}},"LocalePerk"),a.registerHandler(ValidationHandler,"ValidationPerk"),a.registerHandler(class HTML5FormValidationHandler extends ValidationHandler{constructor(e,t,r){super(e,t,r),this._valueHandler=this.options.get("valueHandler",ValueUtil)}checkValidity(e,t,i){let a,s={},o=r.scopedSelectorAll(this._unit,"form")[0];if(t||i){let e=this._valueHandler.getFields(o);s=super._validate(e,t,i)}a=this._validate(o,t);let n=r.deepMerge(s,a);this._unit.set("inventory","validation.validationResult.result",!(Object.keys(n).length>0)),this._unit.set("inventory","validation.validationResult.invalids",n)}reportValidity(e,t){let i=r.scopedSelectorAll(this._unit,"form")[0];r.assert(i,(()=>"FormValidationHandler.reportValidity(): Form tag does not exist."),TypeError),r.assert(i.reportValidity,(()=>"FormValidationHandler.reportValidity(): Report validity not supported."),TypeError),i.reportValidity()}_validate(e,t){let i={};return r.assert(e,(()=>"FormValidationHandler.checkValidity(): Form tag does not exist."),TypeError),r.assert(e.checkValidity,(()=>"FormValidationHandler.checkValidity(): check validity not supported."),TypeError),r.scopedSelectorAll(e,"input:not([novalidate])").forEach((e=>{let r=e.getAttribute("bm-bind"),a=this._valueHandler.getValue(e),s=t&&t[r]?t[r]:null,o=this._validateValue(e,r,a,s);o.length>0&&(i[r]=this._createValidationResult(r,a,s,o,{element:e}),i.message=i.message||e.validationMessage)})),i}_validateValue(e,t,r,i){let a=[],s=e.validity;if(!s.valid)for(const e in s)"valid"!==e&&s[e]&&a.push({validity:e});return a}},"ValidationPerk"),a.registerHandler(class ObjectValidationHandler extends ValidationHandler{checkValidity(e,t,i){let a=super._validate(e,t,i),s=this._validate(e,t),o=r.deepMerge(a,s);this._unit.set("inventory","validation.validationResult.result",!(Object.keys(o).length>0)),this._unit.set("inventory","validation.validationResult.invalids",o)}reportValidity(e,t){}_validate(e,t){let r={};return t&&Object.keys(e).forEach((i=>{if(t[i]){let a=this._validateValue(i,e[i],t[i]);a.length>0&&(r[i]=this._createValidationResult(i,e[i],t[i],a))}})),r}_validateValue(e,t,r){let i=[];return r&&r.constraints&&Object.keys(r.constraints).forEach((a=>{let s=this._checkConstraint(e,t,a,r.constraints[a]);s&&i.push(s)})),i}_checkConstraint(e,t,r,i){let a,s,o;switch(r){case"type":a=this._checkType(e,t,r,i);break;case"required":t||(a={rule:"required",validity:"valueMissing"});break;case"minlength":s=String(t).length,s<i&&(a={rule:"minlength",validity:"tooShort(min:"+i+")"});break;case"maxlength":s=String(t).length,s>i&&(a={rule:"maxlength",validity:"tooLong(max:"+i+")"});break;case"min":o=parseInt(t),o<i&&(a={rule:"min",validity:"rangeUnderflow(min:"+i+")"});break;case"max":o=parseInt(t),o>i&&(a={rule:"max",validity:"rangeOverflow(max:"+i+")"});break;case"pattern":new RegExp(i).test(t)||(a={rule:"pattern",validity:"patternMismatch(pattern:"+i+")"});break;case"valids":-1===i.indexOf(t)&&(a={rule:"valids",validity:"validsMismatch"});break;case"custom":i(e,t,i)||(a={rule:"custom",validity:"customMismatch"})}return a}_checkType(e,t,r,i){let a;if(t)switch(i){case"object":"object"!=typeof t&&(a={rule:"type",validity:"typeMismatch(object)"});break;case"function":"function"!=typeof t&&(a={rule:"type",validity:"typeMismatch(function)"});break;case"string":"string"!=typeof t&&(a={rule:"type",validity:"typeMismatch(string)"});break;case"number":let e=parseInt(t);isNaN(e)&&(a={rule:"type",validity:"typeMismatch(number)"})}return a}},"ValidationPerk");export{ArrayStore,BindableArrayStore,BindableStore,ErrorServer,FormatterUtil,LocaleFormatterUtil,LocaleServer,LocaleValueUtil,MultiStore,ObservableStore,PreferenceServer,Router,ValueUtil};

!function(){"use strict";function n(t){t=Object.assign({},t,{name:"ErrorManager",autoOpen:!1,autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);return e._targets={},e.addEventHandler(e,"afterConnect",e.onAfterConnect),e}function r(t){t=Object.assign({},t,{name:"PreferenceManager",autoOpen:!1,autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);e._targets={};var n=Object.assign({},t.defaults);return e._preferences=new BITSMIST.v1.Store({items:n}),BITSMIST.v1.Globals.preferences=e._preferences,e.addEventHandler(e,"afterConnect",e.onAfterConnect),e.addEventHandler(e,"beforeSetup",e.onBeforeSetup),e}function o(t){t=Object.assign({},t,{name:"SettingManager",autoOpen:!1,autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);return BITSMIST.v1.Globals.settings=e._settings,e.addEventHandler(e,"afterConnect",e.onAfterConnect),e}function t(t){t=Object.assign({},t,{name:"App",autoOpen:!1,autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);return e._targets={},e._preferenceManager=new r(e._settings.get("preferences")),e._errorManager=new n,e._settingManager=new o(e._settings.get("globals")),e.addEventHandler(e,"afterConnect",e.onAfterConnect),e}function e(t){t=Object.assign({},t,{name:"Router",autoOpen:!1,autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);return e._routes=e._routes||[],e._spec,e.addEventHandler(e,"afterConnect",e.onAfterConnect),e}function i(t){t=Object.assign({},t,{name:"TagLoader",autoSetup:!1});var e=Reflect.construct(BITSMIST.v1.Component,[t],this.constructor);return window.addEventListener("DOMContentLoaded",e.onDOMContentLoaded.bind(e)),e}BITSMIST.v1.ClassUtil.inherit(n,BITSMIST.v1.Component),customElements.define("bm-error",n),n.prototype.onAfterConnect=function(t,e){this.run()},n.prototype.run=function(){return this.__initErrorListeners(),this.open()},n.prototype.register=function(t,e){this._targets[t.uniqueId]={object:t,targets:e}},n.prototype.__isTarget=function(t,e,n){for(var r=!1,o=0;o<e.length;o++)e[o]&&n.name==e[o]&&(r=!0);return r},n.prototype.__initErrorListeners=function(){var i=this;window.addEventListener("unhandledrejection",function(t){var e={};return t.reason?(e.message=t.reason instanceof XMLHttpRequest?t.reason.statusText:t.reason.message,e.stack=t.reason.stack,e.object=t.reason):e.message=t,e.type=t.type,e.name=i.__getErrorName(t),e.filename="",e.funcname="",e.lineno="",e.colno="",i.__handleException(e),!1}),window.addEventListener("error",function(t,e,n,r){var o={type:"error"};return o.name=i.__getErrorName(t),o.message=t.message,o.file=t.filename,o.line=t.lineno,o.col=t.colno,t.error&&(o.stack=t.error.stack,o.object=t.error),i.__handleException(o),!1})},n.prototype.__getErrorName=function(t){var e,n,r=t.reason?t.reason:t.error?t.error:t.message;return r.name?e=r.name:r instanceof TypeError?e="TypeError":r instanceof XMLHttpRequest?e="AjaxError":r instanceof EvalError?e="EvalError":r instanceof RangeError?e="RangeError":r instanceof ReferenceError?e="ReferenceError":r instanceof SyntaxError?e="SyntaxError":r instanceof URIError?e="URIError":-1<(n=r.indexOf(":"))&&(e=r.substring(0,n)),e},n.prototype.__handleException=function(e){var n=this;Object.keys(this._targets).forEach(function(t){n.__isTarget(n._targets[t].object,n._targets[t].targets,e)&&n._targets[t].object.trigger("afterError",n,{error:e})})},BITSMIST.v1.ClassUtil.inherit(r,BITSMIST.v1.Component),customElements.define("bm-preference",r),Object.defineProperty(r.prototype,"items",{get:function(){return this._preferences.items}}),r.prototype.onAfterConnect=function(t,e){this.run()},r.prototype.onBeforeSetup=function(t,e){var r=this,o=e.detail;return new Promise(function(t,e){var n=[];Object.keys(r._targets).forEach(function(t){r.__isTarget(o,r._targets[t].targets)&&n.push(r._targets[t].object.setup(o))}),Promise.all(n).then(function(){t()})})},r.prototype.get=function(t,e){return this._preferences.get(t,e)},r.prototype.set=function(t,e){this._preferences.set(t,e)},r.prototype.run=function(){var n=this;return new Promise(function(t,e){Promise.resolve().then(function(){return n.load()}).then(function(t){return n._preferences.merge(t)}).then(function(){return n.open()}).then(function(){t()})})},r.prototype.setup=function(n){var r=this;return new Promise(function(t,e){(n=Object.assign({},n)).sender&&n.sender;BITSMIST.v1.Component.prototype.setup.call(r,n).then(function(){n.newPreferences&&(r._preferences.merge(n.newPreferences),r.save())}).then(function(){t()})})},r.prototype.register=function(t,e){this._targets[t.uniqueId]={object:t,targets:e}},r.prototype.deregister=function(t){delete this._targets[t.uniqueId]},r.prototype.load=function(t){var e=t&&t.sender?t.sender:this;return this.trigger("doLoadStore",e)},r.prototype.save=function(t){var e=t&&t.sender?t.sender:this;return this.trigger("doSaveStore",e,{preferences:this._preferences.items})},r.prototype.__initPreferences=function(){var n=this;return new Promise(function(t,e){Promise.resolve().then(function(){return n.load()}).then(function(t){return n._preferences.merge(t)}).then(function(){t()})})},r.prototype.__isTarget=function(t,e){for(var n=!1,r=0;r<e.length;r++)if(t.newPreferences.hasOwnProperty(e[r])){n=!0;break}return n},BITSMIST.v1.ClassUtil.inherit(o,BITSMIST.v1.Component),customElements.define("bm-setting",o),o.prototype.onAfterConnect=function(t,e){this.run()},o.prototype.get=function(t,e){return this._settings.get(t,e)},o.prototype.set=function(t,e){this._settings.set(t,e)},o.prototype.run=function(){return this.open()},BITSMIST.v1.ClassUtil.inherit(t,BITSMIST.v1.Component),customElements.define("bm-app",t),Object.defineProperty(t.prototype,"preferences",{get:function(){return this._preferenceManager}}),Object.defineProperty(t.prototype,"settings",{get:function(){return this._settingManager}}),t.prototype.onAfterConnect=function(t,e){return this.run()},t.prototype.run=function(){return this._settingManager.run(),this._preferenceManager.run(),this._errorManager.run(),this.open()},BITSMIST.v1.ClassUtil.inherit(e,BITSMIST.v1.Component),customElements.define("bm-router",e),Object.defineProperty(e.prototype,"routeInfo",{get:function(){return this._routeInfo}}),e.prototype.onAfterConnect=function(t,e){return this.run()},e.prototype.run=function(){var n=this;return new Promise(function(t,e){history.replaceState(n.__getDefaultState("connect"),null,null),n._routeInfo=n.__loadRouteInfo(window.location.href),n.__initPopState(),n.__initSpec(n._routeInfo.specName).then(function(){return n.trigger("afterSpecLoad",n,{spec:n._spec})}).then(function(){n.open()}).then(function(){t()})})},e.prototype.buildUrl=function(t){var e;return t.url?e=t.url:(e=t.path?t.path:this._routeInfo.path,e+=t.query?"?"+t.query:"",e+=t.queryParameters?this.buildUrlQuery(t.queryParameters):""),e},e.prototype.buildUrlQuery=function(n){var t="";return n&&(t=Object.keys(n).reduce(function(t,e){return Array.isArray(n[e])?t+=encodeURIComponent(e)+"="+encodeURIComponent(n[e].join())+"&":n[e]&&(t+=encodeURIComponent(e)+"="+encodeURIComponent(n[e])+"&"),t},"")),t?"?"+t.slice(0,-1):""},e.prototype.loadParameters=function(){var t,e,n={};if(-1<window.location.href.indexOf("?"))for(var r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<r.length;o++)e=(t=r[o].split("="))[1]?t[1].split("#")[0]:t[1],n[t[0]]=decodeURIComponent(e);return n},e.prototype.openRoute=function(t,e){e=Object.assign({},e),this._open(t,e)},e.prototype.jumpRoute=function(t,e){var n=this.buildUrl(t);this._jump(n)},e.prototype.refreshRoute=function(t,e){return this._refresh(t,e)},e.prototype.updateRoute=function(t,e){return this._update(t,e)},e.prototype.replaceRoute=function(t){history.replaceState(this.__getDefaultState("replaceRoute"),null,this.buildUrl(t)),this._routeInfo=this.__loadRouteInfo(window.location.href)},e.prototype._open=function(t,e){var n=this;(e=Object.assign({},e)).pushState=void 0===e.pushState||e.pushState;var r=this.buildUrl(t),o=Object.assign({},this._routeInfo),i=this.__loadRouteInfo(r);this._routeInfo=this.__loadRouteInfo(r),!e.jump&&i.name&&o.name==i.name?Promise.resolve().then(function(){e.pushState&&history.pushState(n.__getDefaultState("_open.pushState"),null,r)}).then(function(){return o.specName!=i.specName?n._update(i,e):n._refresh(t,e)}).then(function(){t.dispUrl&&history.replaceState(n.__getDefaultState("_open.dispUrl"),null,t.dispUrl)}):this._jump(r)},e.prototype._jump=function(t){window.location.href=t},e.prototype._refresh=function(t,e){var n=this._routeInfo.componentName;if(this._components[n])return this._components[n].refresh({sender:this,pushState:!1})},e.prototype._update=function(n,t){var r=this;return new Promise(function(t,e){r.clearOrganizers(),Promise.resolve().then(function(){return r.__initSpec(n.specName)}).then(function(){return r.trigger("afterSpecLoad",r,{spec:r._spec})}).then(function(){t()})})},e.prototype.__loadRouteInfo=function(t){for(var e,n,r={},o=new URL(t,window.location.href),i={},s=this._routes.length-1;0<=s;s--)if(!this._routes[s].origin||this._routes[s].origin&&o.origin==this._routes[s].origin){var a=this._routes[s].path?this._routes[s].re.exec(o.pathname):[];if(a){e=this._routes[s].name,f=this._routes[s].specName?this._routes[s].specName:"",n=this._routes[s].componentName;for(var c=0;c<a.length-1;c++){i[this._routes[s].keys[c].name]=a[c+1];var u=this._routes[s].keys[c].name,p=a[c+1],f=f.replace("{{:"+u+"}}",p)}break}}return r.name=e,r.specName=f,r.componentName=n,r.url=o.href,r.path=o.pathname,r.query=o.search,r.parsedUrl=o,r.routeParameters=i,r.queryParameters=this.loadParameters(),r},e.prototype.__initPopState=function(){var r=this;window.history&&window.history.pushState&&window.addEventListener("popstate",function(t){var e,n;t.state&&(n=r._routeInfo.componentName,r._components&&r._components[n]&&(e=r._components[n].trigger("beforePopState",r)),Promise.all([e]).then(function(){r.openRoute(r.__loadRouteInfo(window.location.href),{pushState:!1})}).then(function(){var t=r._routeInfo.componentName;r._components&&r._components[t]&&r._components[t].trigger("afterPopState",r)}))})},e.prototype.__initSpec=function(r){var o=this;return new Promise(function(e,t){var n;r?((n=o.getAttribute("data-specpath")||"")&&o._settings.set("system.specPath",n),n=o._settings.get("system.specPath"),o.loadSpec(r,n).then(function(t){o._spec=t,o.organize(t,"spec").then(function(){e()})})):e()})},e.prototype.__getDefaultState=function(t){return t+":"+window.location.href},BITSMIST.v1.ClassUtil.inherit(i,BITSMIST.v1.Component),customElements.define("bm-tagloader",i),i.prototype.onDOMContentLoaded=function(t,e){var n=this;return new Promise(function(t,e){Promise.resolve().then(function(){if(document.querySelector("bm-setting"))return n.waitFor([{name:"SettingManager",status:"opened"}])}).then(function(){var t=BITSMIST.v1.Util.concatPath([n._settings.get("system.appBaseUrl",""),n._settings.get("system.componentPath","")]),e=n._settings.get("system.splitComponent",!1);return n.loadTags(document,t,{splitComponent:e})}).then(function(){t()})})};function s(){}function a(t,e){void 0===e&&(e={});for(var i=function(t){for(var e=[],n=0;n<t.length;){var r=t[n];if("*"!==r&&"+"!==r&&"?"!==r)if("\\"!==r)if("{"!==r)if("}"!==r)if(":"!==r)if("("!==r)e.push({type:"CHAR",index:n,value:t[n++]});else{var o=1,i="";if("?"===t[a=n+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<t.length;)if("\\"!==t[a]){if(")"===t[a]){if(0===--o){a++;break}}else if("("===t[a]&&(o++,"?"!==t[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);i+=t[a++]}else i+=t[a++]+t[a++];if(o)throw new TypeError("Unbalanced pattern at "+n);if(!i)throw new TypeError("Missing pattern at "+n);e.push({type:"PATTERN",index:n,value:i}),n=a}else{for(var s="",a=n+1;a<t.length;){var c=t.charCodeAt(a);if(!(48<=c&&c<=57||65<=c&&c<=90||97<=c&&c<=122||95===c))break;s+=t[a++]}if(!s)throw new TypeError("Missing parameter name at "+n);e.push({type:"NAME",index:n,value:s}),n=a}else e.push({type:"CLOSE",index:n,value:t[n++]});else e.push({type:"OPEN",index:n,value:t[n++]});else e.push({type:"ESCAPED_CHAR",index:n++,value:t[n++]});else e.push({type:"MODIFIER",index:n,value:t[n++]})}return e.push({type:"END",index:n,value:""}),e}(t),n=e.prefixes,r=void 0===n?"./":n,o="[^"+w(e.delimiter||"/#?")+"]+?",s=[],a=0,c=0,u="",p=function(t){if(c<i.length&&i[c].type===t)return i[c++].value},f=function(t){var e=p(t);if(void 0!==e)return e;var n=i[c],r=n.type,o=n.index;throw new TypeError("Unexpected "+r+" at "+o+", expected "+t)},l=function(){for(var t,e="";t=p("CHAR")||p("ESCAPED_CHAR");)e+=t;return e};c<i.length;){var d,h,m,_,g,v=p("CHAR"),y=p("NAME"),S=p("PATTERN");y||S?(h=v||"",-1===r.indexOf(h)&&(u+=h,h=""),u&&(s.push(u),u=""),s.push({name:y||a++,prefix:h,suffix:"",pattern:S||o,modifier:p("MODIFIER")||""})):(d=v||p("ESCAPED_CHAR"))?u+=d:(u&&(s.push(u),u=""),p("OPEN")?(h=l(),m=p("NAME")||"",_=p("PATTERN")||"",g=l(),f("CLOSE"),s.push({name:m||(_?a++:""),pattern:m&&!_?o:_,prefix:h,suffix:g,modifier:p("MODIFIER")||""})):f("END"))}return s}function w(t){return t.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function I(t){return t&&t.sensitive?"":"i"}function c(t,e,n){return function(t,e,n){void 0===n&&(n={});for(var r=n.strict,o=void 0!==r&&r,i=n.start,s=void 0===i||i,a=n.end,c=void 0===a||a,u=n.encode,p=void 0===u?function(t){return t}:u,f="["+w(n.endsWith||"")+"]|$",l="["+w(n.delimiter||"/#?")+"]",d=s?"^":"",h=0,m=t;h<m.length;h++){var _,g,v,y=m[h];"string"==typeof y?d+=w(p(y)):(_=w(p(y.prefix)),g=w(p(y.suffix)),y.pattern?(e&&e.push(y),_||g?"+"===y.modifier||"*"===y.modifier?(v="*"===y.modifier?"?":"",d+="(?:"+_+"((?:"+y.pattern+")(?:"+g+_+"(?:"+y.pattern+"))*)"+g+")"+v):d+="(?:"+_+"("+y.pattern+")"+g+")"+y.modifier:d+="("+y.pattern+")"+y.modifier):d+="(?:"+_+g+")"+y.modifier)}{var S,b;c?(o||(d+=l+"?"),d+=n.endsWith?"(?="+f+")":"$"):(S=t[t.length-1],b="string"==typeof S?-1<l.indexOf(S[S.length-1]):void 0===S,o||(d+="(?:"+l+"(?="+f+"))?"),b||(d+="(?="+l+"|"+f+")"))}return new RegExp(d,I(n))}(a(t,n),e,n)}function u(t,e,n){return t instanceof RegExp?function(t,e){if(!e)return t;for(var n=/\((?:\?<(.*?)>)?(?!\?)/g,r=0,o=n.exec(t.source);o;)e.push({name:o[1]||r++,prefix:"",suffix:"",modifier:"",pattern:""}),o=n.exec(t.source);return t}(t,e):Array.isArray(t)?(r=e,o=n,i=t.map(function(t){return u(t,r,o).source}),new RegExp("(?:"+i.join("|")+")",I(o))):c(t,e,n);var r,o,i}s.init=function(e,n){return e._plugins||(e._plugins={}),n&&Object.keys(n).forEach(function(t){s.addPlugin(e,t,n[t])}),Promise.resolve()},s.isTarget=function(t){return"initComponent"!=t&&"connected"!=t?!1:!0},s.addPlugin=function(i,s,a){return new Promise(function(t,e){var n="className"in(a=Object.assign({},a))?a.className:s,r=null,r=BITSMIST.v1.ClassUtil.createObject(n,i,a),o=(i._plugins[s]=r).getOption("events",{});Object.keys(o).forEach(function(t){i.addEventHandler(i,t,o[t],null,r)}),a.expose&&Object.defineProperty(i.__proto__,s,{get:function(){return r}}),t(r)})};function p(){}p.init=function(t,e){if(t._routes=t._routes||[],e)for(var n=0;n<e.length;n++)p.addRoute(t,e[n]);return Promise.resolve()},p.isTarget=function(t){return"initComponent"!=t&&"connected"!=t&&"spec"!=t?!1:!0},p.addRoute=function(t,e,n){var r=[],o={origin:e.origin,name:e.name,path:e.path,keys:r,specName:e.specName,componentName:e.componentName,re:u(e.path,r)};n?t._routes.unshift(o):t._routes.push(o)};function f(t,e){this.init(t,e)}var l={component:{configurable:!0}};l.component.get=function(){return this._component},l.component.set=function(t){this._component=t},f.prototype.init=function(t,e){this._options=Object.assign({},this._options,e),this._component=t,this._events=this.getOption("events",{})},f.prototype.getOption=function(t,e){return BITSMIST.v1.Util.safeGet(this._options,t,e)},Object.defineProperties(f.prototype,l);function d(){this.target.push("NoRouteError")}var h=function(n){function t(t,e){n.call(this,t,e),this._options.events={afterError:{handler:this.onAfterError}}}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.onAfterError=function(t,e){return this.handle(e.detail.error)},t.prototype.handle=function(t){var e,o=this;"AjaxError"==t.name&&(e=t.object.status,Object.keys(this._options.handlers.statusCode).forEach(function(r){e==r&&Object.keys(o._options.handlers.statusCode[r]).forEach(function(t){var e=o._options.handlers.statusCode[r][t];switch(t){case"route":"appName"in e||(e.appName="");var n=e.routeInfo;Object.keys(n.queryParameters).forEach(function(t){n.queryParameters[t]=n.queryParameters[t].replace("@url@",location.href)}),document.querySelector("bm-router").openRoute(n,{jump:!0})}})}))},t}(f);function m(t){this._options=t||{}}d.prototype.handle=function(){if(this.container.loader.loadParameters()._redirected_by_norouteerrorhandler)throw new Error("Page not found");var t={resourceName:this.options.route.resourceName,commandName:this.options.route.commandName,parameters:this.options.route.parameters};t.parameters._redirected_by_norouteerrorhandler=!0,this.container.router.openRoute(t,{})},m.prototype.get=function(t){var e=document.cookie.split(";").reduce(function(t,e){var n=e.split("="),r=n[0],o=n[1];return r&&(t[r.trim()]=o?decodeURIComponent(o.trim()):void 0),t},{});return e[t]?JSON.parse(e[t]):{}},m.prototype.set=function(t,e,n){var r=t+"="+encodeURIComponent(JSON.stringify(e))+"; ";n=n||{},this._options&&(n=Object.assign(this._options,n)),r+=Object.keys(n).reduce(function(t,e){return t+=e+"="+n[e]+"; "},""),document.cookie=r};function _(t,e){this._name=t,this._options=e,this._data,this._parameters={}}var g=function(n){function t(t,e){n.call(this,t,e),this._options.events={doLoadStore:this.onDoLoadStore,doSaveStore:this.onDoSaveStore},this._cookie=new m(this._options.cookieOptions),this._cookieName=this.getOption("cookieOptions.name","preferences")}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.onDoLoadStore=function(){var n=this;return new Promise(function(t,e){t(n._cookie.get(n._cookieName))})},t.prototype.onDoSaveStore=function(t,e){this._cookie.set(this._cookieName,e.detail.preferences)},t}(f);_.prototype.get=function(c,u){var p=this;return new Promise(function(e,t){var n="GET",r=p._getOption("headers",n),o=p._getOption("options",n),i=p._getOption("url",n),s=i.dataType,a=p._buildApiUrl(p._name,c,u,i);BITSMIST.v1.AjaxUtil.ajaxRequest({url:a,method:n,headers:r,options:o}).then(function(t){e(p._convertResponseData(t.responseText,s))})})},_.prototype.delete=function(c,u){var p=this;return new Promise(function(e,t){var n="DELETE",r=p._getOption("headers",n),o=p._getOption("options",n),i=p._getOption("url",n),s=i.dataType,a=p._buildApiUrl(p._name,c,u,i);BITSMIST.v1.AjaxUtil.ajaxRequest({url:a,method:n,headers:r,options:o}).then(function(t){e(p._convertResponseData(t.responseText,s))})})},_.prototype.insert=function(c,u,p){var f=this;return new Promise(function(e,t){var n="POST",r=f._getOption("headers",n),o=f._getOption("options",n),i=f._getOption("url",n),s=i.dataType,a=f._buildApiUrl(f._name,c,p,i);BITSMIST.v1.AjaxUtil.ajaxRequest({url:a,method:n,headers:r,options:o,data:f._convertRequestData(u,s)}).then(function(t){e(f._convertResponseData(t.responseText,s))})})},_.prototype.update=function(c,u,p){var f=this;return new Promise(function(e,t){var n="PUT",r=f._getOption("headers",n),o=f._getOption("options",n),i=f._getOption("url",n),s=i.dataType,a=f._buildApiUrl(f._name,c,p,i);BITSMIST.v1.AjaxUtil.ajaxRequest({url:a,method:n,headers:r,options:o,data:f._convertRequestData(u,s)}).then(function(t){e(f._convertResponseData(t.responseText,s))})})},_.prototype._convertRequestData=function(t,e){var n;switch(e){case"json":default:n=JSON.stringify(t)}return n},_.prototype._convertResponseData=function(t,e){var n;switch(e){case"json":default:n=JSON.parse(t)}return n},_.prototype._getOption=function(t,e){var n="settings"in this._options?this._options.settings:{},r=t in n&&"COMMON"in n[t]?n[t].COMMON:{},o=t in n&&e in n[t]?n[t][e]:{};return Object.assign(r,o)},_.prototype._buildApiUrl=function(t,e,n,r){var o=r.baseUrl,i=r.scheme,s=r.host,a=r.dataType,c=r.version;return(r.format?r.format:"@baseUrl@@query@").replace("@scheme@",i).replace("@host@",s).replace("@baseUrl@",o).replace("@resource@",t).replace("@id@",e).replace("@dataType@",a).replace("@query@",this._buildUrlQuery(n)).replace("@version@",c)},_.prototype._buildUrlQuery=function(n){var t="";return n&&(t=Object.keys(n).reduce(function(t,e){return Array.isArray(n[e])?t+=encodeURIComponent(e)+"="+encodeURIComponent(n[e].join())+"&":n[e]&&(t+=encodeURIComponent(e)+"="+encodeURIComponent(n[e])+"&"),t},"")),t?"?"+t.slice(0,-1):""};var v=function(o){function t(t,e){var n,r;o.call(this,t,e),this._items,"items"in e&&(r="object"==typeof e.items?e.items:(n=window,e.items.split(".").forEach(function(t){if(!(n=n[t]))throw new ReferenceError("Master not found. Master="+e.items)}),n),this._items=this.__reshapeItems(r))}o&&(t.__proto__=o),(t.prototype=Object.create(o&&o.prototype)).constructor=t;var e={items:{configurable:!0}};return e.items.get=function(){return this._items},t.prototype.load=function(){var n=this;return new Promise(function(e,t){n.get("list").then(function(t){n._items=n.__reshapeItems(t.data),e()})})},t.prototype.getValue=function(t){var e=t,n=this._options.title;return this._items&&t in this._items&&(e=this._items[t][n]),e},t.prototype.getItem=function(t){var e;return this._items&&t in this._items&&(e=this._items[t]),e},t.prototype.filter=function(n){var r=this;return Object.keys(this._items).reduce(function(t,e){return n(r._items[e])&&(t[e]=r._items[e]),t},{})},t.prototype.__reshapeItems=function(t){var r=this._options.id,o=this._options.title;return t.reduce(function(t,e){var n=e[r];return t[n]=e,t[n].title=e[o],t},{})},Object.defineProperties(t.prototype,e),t}(_),y=function(n){function t(t,e){n.call(this,t,e),this._options.events={afterConnect:this.onAfterConnect,afterSpecLoad:this.onAfterSpecLoad},this._masters={}}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.onAfterConnect=function(){return this.__initMasters(this._component.settings.get("masters"))},t.prototype.onAfterSpecLoad=function(){return this.__initMasters(BITSMIST.v1.Util.safeGet(this._component,"_spec.masters"))},t.prototype.__initMasters=function(i){var s=this;return new Promise(function(t,e){var r,o=[];i&&((r=s._component.settings.get("ajaxUtil",{})).url.COMMON.baseUrl=s._component.settings.get("system.apiBaseUrl",""),Object.keys(i).forEach(function(n){s._masters[n]=new v(n,Object.assign({settings:r},i[n])),i[n].autoLoad?o.push(new Promise(function(t,e){s._masters[n].load().then(function(){s[n]=s._masters[n],t()})})):s[n]=s._masters[n]})),Promise.all(o).then(function(){t()})})},t}(f),S=function(o){function t(t,e){var n=this;o.call(this,t,e),this._options.events={doFetch:this.onDoFetch,doSubmit:this.onDoSubmit},this._options.settings=this._component.settings.get("ajaxUtil",""),this._options.settings.url.COMMON.baseUrl=this._component.settings.get("system.apiBaseUrl",""),this._resources={},this._defaultResourceName;var r=this.getOption("resources",[]);Object.keys(r).forEach(function(t){var e=r[t];n.addResource(e,{settings:n.getOption("settings",{})})}),this.switchResource(r[0])}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.addResource=function(t,e){this._resources[t]=new _(t,Object.assign({settings:e.settings})),this[t]=this._resources[t]},t.prototype.switchResource=function(t){this._defaultResourceName=t},t.prototype.onDoFetch=function(t,o){var i=this;return new Promise(function(e,t){var n=BITSMIST.v1.Util.safeGet(o.detail.target,"id"),r=BITSMIST.v1.Util.safeGet(o.detail.target,"parameters");BITSMIST.v1.Util.safeGet(o.detail.options,"autoLoad",i.getOption("autoLoad"))?i._resources[i._defaultResourceName].get(n,r).then(function(t){i._component.data=t,"items"in i._component?i._component.items=i.getOption("itemsGetter",function(t){return t.data})(t):"item"in i._component&&(i._component.item=i.getOption("itemGetter",function(t){return t.data[0]})(t)),e()}):e()})},t.prototype.onDoSubmit=function(t,o){var i=this;return new Promise(function(t,e){var n=BITSMIST.v1.Util.safeGet(o.detail.target,"id"),r=(BITSMIST.v1.Util.safeGet(o.detail.target,"parameters"),BITSMIST.v1.Util.safeGet(o.detail,"items"));Promise.resolve().then(function(){return n?i._resources[i._defaultResourceName].update(n,{items:r}):i._resources[i._defaultResourceName].insert(n,{items:r})}).then(function(){t()})})},t}(f);function b(){}function T(){}function E(t){var e=Reflect.construct(BITSMIST.v1.Pad,[t],this.constructor);return e._id,e._parameters,e._item={},e.__cancelSubmit=!1,e._target={},e}function C(t){var e=Reflect.construct(BITSMIST.v1.Pad,[t],this.constructor);return e._id,e._parameters,e._target={},e._data,e._items,e._listRootNode,e._row,e._rows,e.addEventHandler(e,"afterAppend",e.onListAfterAppend),e}b.format=function(t,e,n){var r=n;switch(e.toLowerCase()){case"yyyy/mm/dd":r=b.formatDate(e,r);break;case"price":r=b.formatPrice(e,r)}return r},b.formatPrice=function(t,e){return e?"¥"+String(parseInt(e)).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):""},b.formatNumber=function(t){return t?String(parseInt(t)).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):""},b.formatDate=function(t,e){var n="";return e&&8==e.length&&(n=e.substr(0,4)+"/"+e.substr(4,2)+"/"+e.substr(6,2)),n},b.deformat=function(t,e,n){var r=n;switch(e){case"yyyy/mm/dd":r=b.deformatDate(e,n);break;case"price":r=b.deformatPrice(e,n)}return r},b.deformatPrice=function(t,e){var n="";return e&&(n=e.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"").replace("¥","")),n},b.deformatDate=function(t,e){var n="";return e&&(n=e.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"")),n},b.getNow=function(t){t=t||"-";var e=new Date;return e.getFullYear()+t+("00"+(e.getMonth()+1)).slice(-2)+t+("00"+e.getDate()).slice(-2)+" "+("00"+e.getHours()).slice(-2)+":"+("00"+e.getMinutes()).slice(-2)+":"+("00"+e.getSeconds()).slice(-2)},b.getToday=function(t){t=void 0===t?"-":t;var e=new Date;return e.getFullYear()+t+("00"+(e.getMonth()+1)).slice(-2)+t+("00"+e.getDate()).slice(-2)},b.sanitize=function(t){return"string"==typeof t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):t},T.setFields=function(t,o,i){var s=this,e=t.querySelectorAll("[data-bm-field]");Array.prototype.concat([t],Array.prototype.slice.call(e,0)).forEach(function(t){var e,n,r=t.getAttribute("data-bm-field");r in o&&(t.hasAttribute("data-bm-master")?(e=t.getAttribute("data-bm-master"),n=s.getMasterValue(i,e,o[r]),s.setValue(t,n)):s.setValue(t,o[r]))})},T.getFields=function(t,e){var o=this,i={};e=e||"";var n=t.querySelectorAll(e+" [data-bm-formitem]");return(n=Array.prototype.slice.call(n,0)).forEach(function(t){var e,n=t.getAttribute("data-bm-field"),r=o.getValue(t);Array.isArray(i[n])?r&&i[n].push(r):i[n]?r&&((e=[]).push(i[n]),e.push(r),i[n]=e):i[n]=r}),i},T.clearFields=function(t,e){e=e||"";var n=t.querySelectorAll(e+" input");(n=Array.prototype.slice.call(n,0)).forEach(function(t){switch(t.type.toLowerCase()){case"search":case"text":case"number":t.value="";break;case"checkbox":case"radio":t.checked=!1}}),n=t.querySelectorAll(e+" select"),(n=Array.prototype.slice.call(n,0)).forEach(function(t){t.selectedIndex=-1})},T.buildFields=function(t,e,o){var n=t.querySelectorAll("[data-bm-field='"+e+"']");(n=Array.prototype.slice.call(n,0)).forEach(function(r){var t,e,n;"select"==r.tagName.toLowerCase()?(r.options.length=0,"emptyItem"in o&&(t="text"in o.emptyItem?o.emptyItem.text:"",e="value"in o.emptyItem?o.emptyItem.value:"",(n=document.createElement("option")).text=t,n.value=e,n.setAttribute("selected",""),r.appendChild(n)),Object.keys(o.items).forEach(function(t){var e=document.createElement("option");e.text=o.items[t].title,e.value=t,r.appendChild(e)})):Object.keys(o.items).forEach(function(t){var e=document.createElement("label"),n=document.createElement("input");n.type="radio",n.id=key,n.name=key,n.value=t,n.setAttribute("data-bm-field",key),n.setAttribute("data-bm-formitem",""),e.appendChild(n),e.appendChild(document.createTextNode(o.items[t].title)),r.appendChild(e)})})},T.getMasterValue=function(t,e,n){var r=n;return t&&e in t&&(r=t[e].getValue(n)),r},T.setValue=function(t,e){null!==e&&null!=e||(e=""),t.hasAttribute("data-bm-format")&&(e=b.format("",t.getAttribute("data-bm-format"),e));var n=b.sanitize(e),r=t.getAttribute("data-bm-target");if(r)for(var o=r.split(","),i=0;i<o.length;i++){var s=o[i].toLowerCase();switch(s){case"html":t.innerHTML=e;break;case"href":case"src":case"rel":"http"!=e.substring(0,4)&&"/"!=e.substring(0,1)||t.setAttribute(s,e);break;default:var a=(a=t.getAttribute(s))?a+" "+e:n;t.setAttribute(s,a)}}else if(t.hasAttribute("value"))"input"==t.tagName.toLowerCase()&&"checkbox"==t.type.toLowerCase()||"input"==t.tagName.toLowerCase()&&"radio"==t.type.toLowerCase()?Array.isArray(e)?-1<e.indexOf(t.getAttribute("value"))&&(t.checked=!0):t.getAttribute("value")==e&&(t.checked=!0):t.setAttribute("value",b.sanitize(e));else if("select"==t.tagName.toLowerCase())t.value=e;else if("fieldset"!=t.tagName.toLowerCase())if("input"==t.tagName.toLowerCase())switch(t.type.toLowerCase()){case"number":case"search":case"text":t.value=e;break;case"checkbox":t.checked=!!e;break;case"radio":t.value==e&&(t.checked=!0)}else t.innerText=e;var c=document.createEvent("HTMLEvents");c.initEvent("change",!0,!0),t.dispatchEvent(c)},T.getValue=function(t){var e=void 0;switch(t.tagName.toLowerCase()){case"input":switch(t.type.toLowerCase()){case"radio":case"checkbox":t.checked&&(e=t.hasAttribute("value")?t.getAttribute("value"):t.checked);break;default:e=t.value}break;case"select":e=t.value;break;default:t.hasAttribute("selected")&&(e=t.getAttribute("value"))}return t.hasAttribute("data-bm-format")&&(e=BITSMIST.v1.FormatterUtil.deformat("",t.getAttribute("data-bm-format"),e)),e},T.reportValidity=function(t){var e=!0,n=t.querySelectorAll("input");return(n=Array.prototype.slice.call(n,0)).forEach(function(t){switch(t.getAttribute("type")){case"number":(t.validity&&0==t.validity.valid||isNaN(t.value))&&(t.style.border="solid 3px red",e=!1)}}),e},BITSMIST.v1.ClassUtil.inherit(E,BITSMIST.v1.Pad),Object.defineProperty(E.prototype,"item",{get:function(){return this._item},set:function(t){this._item=t}}),Object.defineProperty(E.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t}}),E.prototype.build=function(e){var n=this;Object.keys(e).forEach(function(t){T.buildFields(n,t,e[t])})},E.prototype.fill=function(r){var o=this;return new Promise(function(t,e){var n=(r=Object.assign({},o.settings.items,r)).sender?r.sender:o;o._target.id="id"in r?r.id:o._target.id,o._target.parameters="parameters"in r?r.parameters:o._target.parameters,r.autoClear&&o.clear(),Promise.resolve().then(function(){return o.trigger("doTarget",n)}).then(function(){return o.trigger("beforeFetch",n,{target:o._target,options:r})}).then(function(){return o.trigger("doFetch",n,{target:o._target,options:r})}).then(function(){return o.trigger("afterFetch",n,{target:o._target,options:r})}).then(function(){return o.trigger("beforeFill",n)}).then(function(){return T.setFields(o,o._item,o.masters),o.trigger("afterFill",n)}).then(function(){t()})})},E.prototype.clear=function(t){return T.clearFields(this,t)},E.prototype.validate=function(r){var o=this;return new Promise(function(t,e){var n=(r=Object.assign({},r)).sender?r.sender:o;delete r.sender,o.trigger("beforeValidate",n).then(function(){var t=!0,e=o.querySelector("form");return o.settings.get("autoValidate")&&(t=e&&e.reportValidity?e.reportValidity():T.reportValidity(o)),t||(o.__cancelSubmit=!0),o.trigger("afterValidate",n)}).then(function(){t()})})},E.prototype.submit=function(r){var o=this;return new Promise(function(t,e){var n=(r=Object.assign({},r)).sender?r.sender:o;delete r.sender,o.__cancelSubmit=!1,o._item=o.getFields(),Promise.resolve(function(){return o.validate()}).then(function(){return o.trigger("beforeSubmit",n)}).then(function(){if(!o.__cancelSubmit){var t=o.settings.get("itemGetter",function(t){return[t]})(o._item);return o.trigger("doSubmit",n,{target:o._target,items:t})}}).then(function(){var t=o.settings.get("itemGetter",function(t){return[t]})(o._item);return o.trigger("afterSubmit",n,{target:o._target,items:t})}).then(function(){t()})})},E.prototype.getFields=function(){return T.getFields(this)},BITSMIST.v1.ClassUtil.inherit(C,BITSMIST.v1.Pad),Object.defineProperty(C.prototype,"row",{get:function(){return this._row}}),Object.defineProperty(C.prototype,"items",{get:function(){return this._items},set:function(t){this._items=t}}),Object.defineProperty(C.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t}}),C.prototype.onListAfterAppend=function(t,e){var r=this;return new Promise(function(t,e){r._listRootNode=r.querySelector(r._settings.get("listRootNode"));var n=r._settings.get("components")[r._settings.get("row")].className?r._settings.get("components")[r._settings.get("row")].className:r._settings.get("row");r._row=BITSMIST.v1.ClassUtil.createObject(n),(r._row._parent=r)._row.open().then(function(){t()})})},C.prototype.clear=function(){this._listRootNode.innerHTML=""},C.prototype.fill=function(i){var s=this;return new Promise(function(t,e){s._rows=[];var n=(i=Object.assign({},s.settings.items,i)).sender?i.sender:s,r=s._settings.get("async")?s._buildAsync:s._buildSync,o=document.createDocumentFragment();s._target.id="id"in i?i.id:s._target.id,s._target.parameters="parameters"in i?i.parameters:s._target.parameters,Promise.resolve().then(function(){return s.trigger("doTarget",s)}).then(function(){return s.trigger("beforeFetch",n,{target:s._target,options:i})}).then(function(){return s.trigger("doFetch",n,{target:s._target,options:i})}).then(function(){return s.trigger("afterFetch",n,{target:s._target,options:i})}).then(function(){return s.trigger("beforeFill",n)}).then(function(){if(s._items)return r.call(s,o)}).then(function(){i.autoClear&&s.clear()}).then(function(){s._listRootNode.appendChild(o)}).then(function(){return s.trigger("afterFill",n)}).then(function(){t()})})},C.prototype._buildSync=function(t){for(var e=0;e<this._items.length;e++)this.__appendRowSync(t,e,this._items[e])},C.prototype._buildAsync=function(e){for(var n=this,r=Promise.resolve(),t=0;t<n._items.length;t++)!function(t){r=r.then(function(){return n.__appendRowAsync(e,t,n._items[t])})}(t);return r},C.prototype.__appendRowAsync=function(o,i,s){var a=this;return new Promise(function(t,e){var n=a._row.clone();o.appendChild(n),a._rows.push(n);var r=a._row.getEventHandler(a._row.settings.get("events.click"));r&&a._row.addEventHandler(n,"click",r,{item:s,no:i,element:n}),Object.keys(a._row.settings.get("elements",{})).forEach(function(t){a._row.setHtmlEventHandlers(t,{item:ttem,no:i,element:n},n)}),Promise.resolve().then(function(){return a._row.trigger("beforeFillRow",a,{item:s,no:i,element:n})}).then(function(){T.setFields(n,s,a.masters)}).then(function(){return a._row.trigger("afterFillRow",a,{item:s,no:i,element:n})}).then(function(){t()})})},C.prototype.__appendRowSync=function(t,e,n){var r=this,o=this._row.clone();t.appendChild(o),this._rows.push(o);var i=this._row.getEventHandler(this._row.settings.get("events.click"));i&&this._row.addEventHandler(o,"click",i,{item:n,no:e,element:o}),Object.keys(this._row.settings.get("elements",{})).forEach(function(t){r._row.setHtmlEventHandlers(t,{item:n,no:e,element:o},o)}),this._row.triggerSync("beforeFillRow",this,{item:n,no:e,element:o}),T.setFields(o,n,this.masters),this.row.triggerSync("afterFillRow",this,{item:n,no:e,element:o})};var O=function(n){function t(t,e){n.call(this,t,e),this._options.events={afterAppend:this.onAfterAppend},this.__isComposing=!1}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.onAfterAppend=function(){var r=this,t=this._options.features.defaultKeys;t&&(this._component.addEventHandler(this._component,"keypress",this.__defaultKey,{options:t},this),this._component.addEventHandler(this._component,"compositionstart",this.__compositionStart,{options:t},this),this._component.addEventHandler(this._component,"compositionend",this.__compositionEnd,{options:t},this));var e,n=this._options.features.defaultButtons;n&&((e=function(e,n){var t;e&&(t=r._component.querySelectorAll(e.rootNode),(t=Array.prototype.slice.call(t,0)).forEach(function(t){r._component.addEventHandler(t,"click",n,{options:e},r)}))})(n.submit,this.__defaultSubmit),e(n.cancel,this.__defaultCancel),e(n.clear,this.__defaultClear))},t.prototype.__defaultKey=function(t,e){var n;this.__isComposing||229==e.keyCode||(n="esc"==(n=(n=e.key?e.key:this.__getKeyfromKeyCode(e.keyCode)).toLowerCase())?"escape":n,e.extraDetail.options.submit&&n==e.extraDetail.options.submit.key?(e.extraDetail={options:e.extraDetail.options.submit},this.__defaultSubmit(t,e)):e.extraDetail.options.cancel&&n==e.extraDetail.options.cancel.key?(e.extraDetail={options:e.extraDetail.options.cancel},this.__defaultCancel(t,e)):e.extraDetail.options.clear&&n==e.extraDetail.options.clear.key&&(e.extraDetail={options:e.extraDetail.options.clear},this.__defaultClear(t,e)))},t.prototype.__getKeyfromKeyCode=function(t){var e;switch(t){case 13:e="Enter";break;default:e=String.fromCharCode(t)}return e},t.prototype.__compositionStart=function(){this.__isComposing=!0},t.prototype.__compositionEnd=function(){this.__isComposing=!1},t.prototype.__defaultSubmit=function(t,e){var n=this;this._component.submit().then(function(){n._component.__cancelSubmit||(n._component._isModal&&(n._component._modalResult.result=!0),e.extraDetail.options&&e.extraDetail.options&&e.extraDetail.options.autoClose&&n._component.close())})},t.prototype.__defaultCancel=function(){this._component.close()},t.prototype.__defaultClear=function(t,e){var n;e.extraDetail.options&&e.extraDetail.options&&e.extraDetail.options.target&&(n=t.getAttribute(e.extraDetail.options.target)),this._component.clear(n)},t}(f),M=function(n){function t(t,e){n.call(this,"authentications",e)}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.authenticate=function(n,r,o){var i=this;return new Promise(function(t,e){i.get("list",{user:n,password:r}).then(function(t){0<t.result.resultCount?o&&"redirect"in o&&(location.href=decodeURI(o.redirect)):e("login failed")})})},t}(_);window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},window.BITSMIST.v1.App=t,window.BITSMIST.v1.Router=e,window.BITSMIST.v1.SettingManager=o,window.BITSMIST.v1.PreferenceManager=r,window.BITSMIST.v1.ErrorManager=n,BITSMIST.v1.Globals.addOrganizer(s,"plugins"),BITSMIST.v1.Globals.addOrganizer(p,"routes"),window.BITSMIST.v1.Plugin=f,window.BITSMIST.v1.AjaxErrorHandler=h,window.BITSMIST.v1.NoRouteErrorHandler=d,window.BITSMIST.v1.CookieStoreHandler=g,window.BITSMIST.v1.MasterHandler=y,window.BITSMIST.v1.ResourceHandler=S,window.BITSMIST.v1.Form=E,window.BITSMIST.v1.List=C,window.BITSMIST.v1.DefaultkeyHandler=O,window.BITSMIST.v1.AuthenticationUtil=M,window.BITSMIST.v1.FormatterUtil=b,window.BITSMIST.v1.MasterUtil=v,window.BITSMIST.v1.ResourceUtil=_}();

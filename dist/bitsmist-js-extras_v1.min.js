!function(){"use strict";if(!window.BITSMIST||!window.BITSMIST.v1||!window.BITSMIST.v1.Unit)throw new ReferenceError("Bitsmist Core Library does not exist.");var t=window.BITSMIST.v1;class MultiStore extends t.Store{constructor(e){super(e),this._stores=[]}add(e){this._stores.push(e)}clear(){this._stores=[]}clone(){let e={};for(let i=0;i<this._stores.length;i++)t.Util.deepMerge(e,this._stores[i].items);return e}get(e,t){let i,r=!1;for(let t=0;t<this._stores.length;t++)if(this._stores[t].has(e)){i=this._stores[t].get(e),r=!0;break}return r?i:t}merge(e,t){throw TypeError("MultiStore is read only.")}set(e,t,i){throw TypeError("MultiStore is read only.")}remove(e){throw TypeError("MultiStore is read only.")}has(e){let t=!1;for(let i=0;i<this._stores.length;i++)if(this._stores[i].has(e)){t=!0;break}return t}}class ArrayStore extends t.Store{constructor(e){super(Object.assign({},e)),this.items=t.Util.safeGet(this._options,"items",[])}get items(){return this.clone()}set items(e){t.Util.assert(Array.isArray(e),`ArrayStore.items(setter): Items is not an array. items=${e}`,TypeError),this._items=e}clear(){this._items=[]}clone(){return t.Util.deepMerge([],this._items)}get(e,i,r){return t.Util.safeGet(this._items[e],i,r)}set(e,i,r,s){if(s&&s.merge)return t.Util.safeMerge(this._items[e],i,defaultValue);t.Util.safeSet(this._items[e],i,r)}remove(e,r){t.Util.safeRemove(this._items[i],r)}has(e,i){return t.Util.safeHas(this._items[e],i)}}class ObservableStore extends t.Store{constructor(e){super(Object.assign({notifyOnChange:!0,async:!0},e)),this._filter,this._observers=[],this.filter=t.Util.safeGet(this._options,"filter",(()=>!0))}get filter(){return this._filter}set filter(e){t.Util.assert("function"==typeof e,`Store.filter(setter): Filter is not a function. filter=${e}`,TypeError),this._filter=e}set(e,i,r,...s){let a={},o=e?this.get(e):this._items;if(o&&"object"==typeof o?this.__deepMerge(o,i,a):this.get(e)!==i&&(t.Util.safeSet(this._items,e,i),a[e]=i),t.Util.safeGet(r,"notifyOnChange",t.Util.safeGet(this._options,"notifyOnChange"))&&Object.keys(a).length>0)return this.notify(a,...s)}clear(e,...t){return super.clear(),this.notify("*",...t)}replace(e,i,...r){if(this._items={},this.__deepMerge(this._items,e),t.Util.safeGet(i,"notifyOnChange",t.Util.safeGet(this._options,"notifyOnChange")))return this.notify(e,...r)}subscribe(e,i,r){t.Util.assert("function"==typeof i,`ObservableStore.subscribe(): Notification handler is not a function. id=${e}`,TypeError),this._observers.push({id:e,handler:i,options:r})}unsubscribe(e){for(let t=0;t<this._observers.length;t++)if(this._obvservers[t].id===e){this._observers.splice(t,1);break}}notify(e,...i){return t.Util.safeGet(this._options,"async",!1)?this.notifyAsync(e,...i):this.notifySync(e,...i)}notifySync(e,...t){let i=Promise.resolve();for(let r=0;r<this._observers.length;r++)i=i.then((()=>{if(this._filter(e,this._observers[r],...t))return this._observers[r].handler(e,this._observers[r],...t)}));return i}notifyAsync(e,...t){for(let i=0;i<this._observers.length;i++)this._filter(e,this._observers[i],...t)&&this._observers[i].handler(e,this._observers[i],...t);return Promise.resolve()}mute(){this._options.notifyOnChange=!1}unmute(){this._options.notifyOnChange=!0}__deepMerge(e,i,r){return r=r||{},t.Util.assert(e&&"object"==typeof e&&i&&"object"==typeof i,"ObservableStore.__deepMerge(): Parameters must be an object.",TypeError),Object.keys(i).forEach((t=>{Array.isArray(e[t])?(e[t]=e[t].concat(i[t]),r[t]=e[t]):e.hasOwnProperty(t)&&e[t]&&"object"==typeof e[t]&&i[t]&&"object"==typeof i[t]&&!(e[t]instanceof HTMLElement)?Util.deepMerge(e[t],i[t]):e[t]!==i[t]&&(e[t]=i[t],r[t]=e[t])})),e}}class FormatterUtil{static format(e,t,i){i=i||{};let r=t,s=this.__bisect(e,"-"),a=s[0],o=s.length>1?s[1]:"";switch(a){case"date":case"datetime":case"time":r=this.formatDate(a,o,t,i);break;case"price":r=this.formatPrice(a,o,t,i);break;case"number":r=this.formatNumber(a,o,t,i);break;default:"`"===e.charAt(0)&&(r=this.interpolateResources(e,t,i),r=this.interpolate(r,i),r=this.interpolateValue(r,t,i))}return String(r)}static formatPrice(e,t,i,r){let s=i;return i&&(i=parseInt(i).toLocaleString(navigator.language)),s||""}static formatNumber(e,t,i,r){let s=i;return i&&(i=parseInt(i).toLocaleString(navigator.language)),s||""}static formatDate(e,t,i,r){let s,a=i,o=t;if(s=8===i.length?new Date(`${i.substr(0,4)}-${i.substr(4,2)}-${i.substr(6,2)}`):new Date(i),""===t)a=s.toString();else{let e=String(s.getFullYear()),t=String(1+s.getMonth()),i=String(s.getDate()),r=String(s.getHours()),l=String(s.getMinutes()),n=String(s.getSeconds());a=o,a=a.replace(/YYYY/g,e.padStart(4,"0")),a=a.replace(/YY/g,e.slice(-2).padStart(2,"0")),a=a.replace(/MM/g,t.padStart(2,"0")),a=a.replace(/M/g,t.padStart(1,"0")),a=a.replace(/DD/g,i.padStart(2,"0")),a=a.replace(/D/g,i.padStart(1,"0")),a=a.replace(/hh/g,r.padStart(2,"0")),a=a.replace(/h/g,r.padStart(1,"0")),a=a.replace(/mm/g,l.padStart(2,"0")),a=a.replace(/m/g,l.padStart(1,"0")),a=a.replace(/ss/g,n.padStart(2,"0")),a=a.replace(/s/g,n.padStart(1,"0"))}return a||""}static deformat(e,t,i){let r=t;switch(e){case"yyyy/mm/dd":r=this.deformatDate(e,t);break;case"price":r=this.deformatPrice(e,t)}return r}static deformatPrice(e,t,i){var r="";return t&&(r=t.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"").replace("Â¥","")),r}static deformatDate(e,t,i){var r="";return t&&(r=t.replace(/,/g,"").replace(/\//g,"").replace(/\\/g,"")),r}static getNow(e,t,i){t=t||"-";var r=new Date;return r.getFullYear()+t+("00"+(r.getMonth()+1)).slice(-2)+t+("00"+r.getDate()).slice(-2)+" "+("00"+r.getHours()).slice(-2)+":"+("00"+r.getMinutes()).slice(-2)+":"+("00"+r.getSeconds()).slice(-2)}static getToday(e,t,i){t=void 0===t?"-":t;var r=new Date;return r.getFullYear()+t+("00"+(r.getMonth()+1)).slice(-2)+t+("00"+r.getDate()).slice(-2)}static sanitize(e,t){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):e}static interpolate(e,t){let i=e,r=t.interpolation;return r&&e.indexOf("${")>-1&&(i=i.replace(/\$\{(.+)\}/g,((e,i)=>{let s=this.__bisect(i,":"),a=r[s[0]];return a?a&&s.length>1&&(a=this.format(s[1],a,t)):a="${"+i+"}",a||""}))),i}static interpolateValue(e,t,i){let r=e;return e.indexOf("${value")>-1&&(r=r.replace(/\$\{value(.*)\}/g,((e,r)=>{let s=this.__bisect(r,":"),a=t;return s.length>1&&(a=this.format(s[1],t,i)),a||""}))),r}static interpolateResources(e,t,i){let r=e,s=i.resources;return s&&e.indexOf("#{")>-1&&(r=e.replace(/\#\{(.+)\}/g,((e,i)=>{let r=i.split("."),a=r[0],o=r[1];return this.__getResourceValue(s,a,t,o)||""}))),r}static __getResourceValue(e,t,i,r){let s=i;if(e&&t in e){let a=e[t].getItem(i);a&&(s=a[r])}return s}static __bisect(e,t){let i=[],r=e.indexOf(t);return r>-1?(i.push(e.substring(0,r)),i.push(e.substring(r+1))):i.push(e),i}}class ValueUtil{static get name(){return"ValueUtil"}static get attributeName(){return"bm-bind"}static get formatter(){return FormatterUtil}static setFields(e,i,r){let s=t.Util.scopedSelectorAll(e,`[${this.attributeName}]`);e.matches(`[${this.attributeName}]`)&&s.push(e),s.forEach((e=>{let s;s=e.hasAttribute(`${this.attributeName}-in`)?this.getValue(e):t.Util.safeGet(i,e.getAttribute(this.attributeName)),void 0!==s&&this.setValue(e,s,r)}))}static getFields(e,i){let r={},s=t.Util.scopedSelectorAll(e,`[${this.attributeName}]`);return e.matches(`[${this.attributeName}]`)&&s.push(e),s.forEach((e=>{let t=e.getAttribute(this.attributeName),i=this.getValue(e);if(Array.isArray(r[t]))i&&r[t].push(i);else if(r[t]){if(i){let e=[];e.push(r[t]),e.push(i),r[t]=e}}else r[t]=i})),r}static clearFields(e,i){let r=t.Util.safeGet(i,"target",""),s=t.Util.scopedSelectorAll(e,`${r} input`,i);s.forEach((e=>{this.clearValue(e,i)})),s=t.Util.scopedSelectorAll(e,`${r} select`,i),s.forEach((e=>{this.clearValue(e,i)}))}static setValue(e,t,i){i=i||{};let r=null==t?"":String(t);e.hasAttribute(`${this.attributeName}-format`)&&!e.hasAttribute(`${this.attributeName}-formatted`)&&(r=this.formatter.format(e.getAttribute(`${this.attributeName}-format`),t,i),e.setAttribute(`${this.attributeName}-formatted`,"")),"`"===r.charAt(0)&&(r=this.formatter.interpolateResources(r,t,i),r=this.formatter.interpolate(r,i),r=this.formatter.interpolateValue(r,t,i),r=r.replace(/^`|`$/g,""));let s=e.getAttribute(`${this.attributeName}-out`);if(s?this._setValue_target(e,s,r):e.hasAttribute("value")?this._setValue_value(e,r):this._setValue_element(e,r),i.triggerEvent){let t=new CustomEvent("change",{detail:i.triggerOptions});e.dispatchEvent(t)}}static getValue(e,t){let i,r=e.getAttribute(`${this.attributeName}-in`);return i=r?this._getValue_target(e,r):this._getValue_element(e),e.hasAttribute(`${this.attributeName}-format`)&&(i=this.formatter.deformat(e.getAttribute(`${this.attribueName}-format`),i)),i}static clearValue(e,t){switch(e.type.toLowerCase()){case"select-one":case"select-multiple":e.selectedIndex=-1;break;case"checkbox":case"radio":e.checked=!1;break;default:e.value=""}if(t&&t.triggerEvent){let i=new CustomEvent("change",{detail:t.triggerOptions});e.dispatchEvent(i)}}static _setValue_target(e,t,i){let r=t.split(",");for(let t=0;t<r.length;t++){let s=r[t].toLowerCase();switch(s){case"text":e.innerText=i;break;case"html":e.innerHTML=i;break;case"outerhtml":e.outerHTML=i;break;default:e.setAttribute(s,i)}}}static _setValue_value(e,t){"input"===e.tagName.toLowerCase()&&"checkbox"===e.type.toLowerCase()||"input"===e.tagName.toLowerCase()&&"radio"===e.type.toLowerCase()?Array.isArray(t)?t.indexOf(e.getAttribute("value"))>-1&&(e.checked=!0):e.getAttribute("value")===t&&(e.checked=!0):e.setAttribute("value",t)}static _setValue_element(e,t){switch(e.tagName.toLowerCase()){case"select":e.value=t;break;case"input":switch(e.type.toLowerCase()){case"number":case"search":case"text":e.value=t;break;case"checkbox":e.checked=!!t;break;case"radio":e.value===t&&(e.checked=!0)}break;default:e.innerText=t}}static _getValue_target(e,t){let i;if("text"===(t=t.toLowerCase()))i=e.innerText;else e.getAttribute(t);return i}static _getValue_element(e){let t;switch(e.tagName.toLowerCase()){case"input":switch(e.type.toLowerCase()){case"radio":case"checkbox":e.checked&&(t=e.hasAttribute("value")?e.getAttribute("value"):e.checked);break;default:t=e.value}break;case"select":t=e.value;break;default:t=e.hasAttribute("selected")?e.getAttribute("value"):e.textContent}return t}}class BindableStore extends t.Store{constructor(e){super(Object.assign({},e)),this._elems={},this._valueHandler=t.Util.safeGet(e,"valueHandler",ValueUtil)}clear(...e){return super.clear(),this._notify("*",...e)}replace(e,...t){return this._items=e,Object.keys(this._items).forEach((e=>{if(this._elems[e]&&this._elems[e].callback){let t=this._items[e];this._items[e]=this._elems[e].callback(t,{changedItem:{[e]:t}})}})),this._notify(e)}set(e,t,i,...r){return this._elems[e]&&this._elems[e].callback&&(t=this._elems[e].callback(t,{changedItem:{[e]:t}})),super.set(e,t),this._notify({[e]:t},...r)}bindTo(e,t,i){if(!!(!t.__bm_bindinfo||!t.__bm_bindinfo.bound)){this._elems[e]=this._elems[e]||{elements:[]},this._elems[e].elements.push(t),this._elems[e].callback=i;let r=this._options.direction;if("two-way"===r||"one-way-reverse"===r){let i=this._options.eventName||"change";t.addEventListener(i,(i=>{(!i.detail||i.detail&&"store"!==i.detail.triggeredBy)&&this.set(e,this._valueHandler.getValue(t),null,t)}).bind(this))}t.__bm_bindinfo={bound:!0}}}_notify(e,...t){if("one-way-reverse"!==this._options.direction)return this._notifyAsync(e,...t)}_notifyAsync(e,t,...i){return Object.keys(e).forEach((e=>{if(this._elems[e]){let i=this.get(e);for(let r=0;r<this._elems[e].elements.length;r++)this._elems[e].elements[r]!==t&&this._valueHandler.setValue(this._elems[e].elements[r],i,{resources:this._options.resources,triggerEvent:!0,triggerOptions:{triggeredBy:"store"}})}})),Promise.resolve()}}class BindableArrayStore extends ArrayStore{constructor(e){super(Object.assign({},e)),this._elems={},this._valueHandler=t.Util.safeGet(e,"valueHandler",ValueUtil)}clear(e,...t){super.clear(...t)}replace(e,t,...i){if(this._items[e]=t,this._elems[e])return Object.keys(this._items[e]).forEach((t=>{if(this._elems[e][t]&&this._elems[e][t].callback){let i=this._items[e][t];this._items[e][t]=this._elems[e][t].callback(i,{changedItem:{[t]:i}})}})),this._notify({index:e,values:t})}set(e,t,i,r,...s){return this._elems[e][t]&&this._elems[e][t].callback&&(i=this._elems[e][t].callback(i,{changedItem:{[t]:i}})),super.set(e,t,i),this._notify({index:e,values:{[t]:i}},...s)}bindTo(e,t,i,r){if(!!(!i.__bm_bindinfo||!i.__bm_bindinfo.bound)){this._elems[e]||(this._elems[e]={});let s=this._elems[e];s[t]=this._elems[e][t]||{elements:[]},s[t].elements.push(i),s[t].callback=r;let a=this._options.direction;if("two-way"===a||"one-way-reverse"===a){let r=this._options.eventName||"change";i.addEventListener(r,(r=>{(!r.detail||r.detail&&"store"!==r.detail.triggeredBy)&&this.set(e,t,this._valueHandler.getValue(i),null,i)}).bind(this))}i.__bm_bindinfo={bound:!0,index:e}}}_notify(e,...t){if("one-way-reverse"!==this._options.direction)return this._notifyAsync(e,...t)}_notifyAsync(e,t,...i){let r=e.index,s=e.values;return Object.keys(s).forEach((e=>{if(this._elems[r][e]){let i=this.get(r,e);for(let s=0;s<this._elems[r][e].elements.length;s++)this._elems[r][e].elements[s]!==t&&this._valueHandler.setValue(this._elems[r][e].elements[s],i,{resources:this._options.resources,triggerEvent:!0,triggerOptions:{triggeredBy:"store"}})}})),Promise.resolve()}}class FilePerk extends t.Perk{static get info(){return{section:"file",order:110}}static init(e,t){this.upgrade(e,"event","doApplySettings",FilePerk.FilePerk_onDoApplySettings)}static FilePerk_onDoApplySettings(e,i,r){let s=[];return Object.entries(t.Util.safeGet(i.detail,"settings.file.targets",{})).forEach((([e,i])=>{s.push(t.AjaxUtil.loadScript(i.href))})),Promise.all(s)}}class ErrorPerk extends t.Perk{static get info(){return{section:"error",order:120}}static ErrorPerk_onDoStart(e,i,r){let s=this.get("setting","locale.options.errorServer",this.get("setting","system.errorServer"));return s=!0===s?"bm-error":s,this.use("spell","status.wait",[s]).then((()=>{let e=document.querySelector(s);e.subscribe(this,t.Util.safeGet(i.detail,"settings.error")),this.set("vault","error.server",e)}))}}function r(){}r.showConditionalElements=function(e,i){t.Util.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{let r=e.getAttribute("bm-visible");t.Util.safeEval(r,i)?e.style.removeProperty("display"):e.style.display="none"}))},r.hideConditionalElements=function(e){t.Util.scopedSelectorAll(e,"[bm-visible]").forEach((e=>{e.style.display="none"}))},r.build=function(e,t,i){if("select"===e.tagName.toLowerCase())r._build_select(e,t,i)},r._build_select=function(e,t,i){if(i=i||{},e.options.length=0,"emptyItem"in i){let t="text"in i.emptyItem?i.emptyItem.text:"",r="value"in i.emptyItem?i.emptyItem.value:"",s=document.createElement("option");s.text=t,s.value=r,e.appendChild(s)}Object.keys(t).forEach((r=>{let s=document.createElement("option");s.text=i.text?t[r][i.text]:r,s.value=i.value?t[r][i.value]:r,e.appendChild(s)})),e.selectedIndex=-1,"defaultValue"in i&&(e.value=i.defaultValue)},r._build_radio=function(e,t,i){Object.keys(i.items).forEach((e=>{let t=document.createElement("label"),r=document.createElement("input");r.type="radio",r.id=key,r.name=key,r.value=e,r.setAttribute("bm-bind",key),r.setAttribute("bm-submit",""),t.appendChild(r),t.appendChild(document.createTextNode(i.items[e].title)),element.appendChild(t)}))};class ElementPerk extends t.Perk{static get info(){return{section:"element",order:220}}static init(e,t){this.upgrade(e,"vault","element.overlay"),this.upgrade(e,"vault","element.overlayPromise",Promise.resolve()),this.upgrade(e,"event","doApplySettings",ElementPerk.ElementPerk_onDoApplySettings)}static ElementPerk_onDoApplySettings(e,i,r){let s=ElementPerk.info.order;Object.entries(t.Util.safeGet(i.detail,"settings.element.targets",{})).forEach((([e,t])=>{this.use("skill","event.add",e,{handler:ElementPerk.ElementPerk_onDoProcess,order:s,options:{attrs:t}})}))}static ElementPerk_onDoProcess(e,t,i){let r=i.options.attrs,s=[];return Object.keys(r).forEach((e=>{s=s.concat(ElementPerk.__initElements(this,t,e,r[e]))})),Promise.all(s)}static __getTargetElements(e,i,r){let s;return s=r.rootNode?"this"===r.rootNode||r.rootNode===e.tagName.toLowerCase()?[e]:t.Util.scopedSelectorAll(e,r.rootNode):"this"===i||i===e.tagName.toLowerCase()?[e]:t.Util.scopedSelectorAll(e,`#${i}`),s}static __initElements(e,t,i,s){let a=[],o=ElementPerk.__getTargetElements(e,i,s);for(let l=0;l<o.length;l++){let n=o[l];Object.keys(s).forEach((t=>{switch(t){case"scroll":o[l].scrollTo(s[t]);break;case"showLoader":ElementPerk.__showOverlay(e,s[t]),n=e.get("vault","element.overlay");break;case"hideLoader":ElementPerk.__hideOverlay(e,s[t]),n=e.get("vault","element.overlay");break;case"build":let i=s[t].resourceName;r.build(o[l],e.get("inventory",`resource.resources.${i}`).items,s[t]);break;case"attribute":ElementPerk.__setAttributes(o[l],s[t]);break;case"class":ElementPerk.__setClasses(o[l],s[t]);break;case"style":Object.keys(s[t]).forEach((e=>{o[l].style[e]=s[t][e]}));break;case"property":Object.keys(s[t]).forEach((e=>{o[l][e]=s[t][e]}));break;case"autoFocus":o[l].focus()}})),s.waitFor&&a.push(ElementPerk.__waitFor(e,t,i,s,n))}return a}static __waitFor(e,i,r,s,a){let o=!1;switch(s.waitFor){case"transition":o="0s"!==window.getComputedStyle(a).getPropertyValue("transition-duration");break;case"animation":o="none"!==window.getComputedStyle(a).getPropertyValue("animation-name")}return t.Util.warn(o,`ElementPerk.__initAttr(): Element not in ${s.waitFor}. name=${e.tagName}, eventName=${i.type}, elementName=${r}`),new Promise(((o,l)=>{let n=setTimeout((()=>{l(`ElementPerk.__initAttr(): Timed out waiting for ${s.waitFor}. name=${e.tagName}, eventName=${i.type}, elementName=${r}`)}),t.Unit.get("setting","system.waitForTimeout",1e4));a.addEventListener(`${s.waitFor}end`,(()=>{clearTimeout(n),o()}),{once:!0})}))}static __setAttributes(e,t){Object.keys(t).forEach((i=>{switch(i){case"add":Object.keys(t[i]).forEach((r=>{e.setAttribute(r,t[i][r])}));break;case"remove":for(let r=0;r<t[i].length;r++)e.removeAttribute(t[i][r])}}))}static __setClasses(e,t){setTimeout((()=>{Object.keys(t).forEach((i=>{switch(i){case"add":e.classList.add(t[i]);break;case"remove":e.classList.remove(t[i]);break;case"replace":e.setAttribute("class",t[i])}}))}),1)}static __createOverlay(e,t){let i=e.get("vault","element.overlay");return i||(i=document.createElement("div"),i.classList.add("overlay"),e.unitRoot.appendChild(i),e.set("vault","element.overlay",i)),i}static __closeOnClick(e,t){e.get("vault","element.overlay").addEventListener("click",(t=>{t.target===t.currentTarget&&"function"==typeof e.close&&e.close({reason:"cancel"})}),{once:!0})}static __getEffect(e){let t="";return"0s"!==window.getComputedStyle(e).getPropertyValue("transition-duration")?t="transition":"none"!==window.getComputedStyle(e).getPropertyValue("animation-name")&&(t="animation"),t}static __showOverlay(e,i){let r=ElementPerk.__createOverlay(e);t.Util.safeGet(i,"closeOnClick")&&ElementPerk.__closeOnClick(e),window.getComputedStyle(r).getPropertyValue("visibility");let s=["show"].concat(t.Util.safeGet(i,"addClasses",[]));r.classList.add(...s),r.classList.remove(...t.Util.safeGet(i,"removeClasses",[]));let a=ElementPerk.__getEffect(r);a?e.get("vault","element.overlayPromise").then((()=>{e.set("vault","element.overlayPromise",new Promise(((e,t)=>{r.addEventListener(`${a}end`,(()=>{e()}),{once:!0})})))})):a=Promise.resolve()}static __hideOverlay(e,i){let r=e.get("vault","element.overlay");e.get("vault","element.overlayPromise").then((()=>{window.getComputedStyle(r).getPropertyValue("visibility");let e=["show"].concat(t.Util.safeGet(i,"removeClasses",[]));r.classList.remove(...e),r.classList.add(...t.Util.safeGet(i,"addClasses",[]))}))}}class ResourcePerk extends t.Perk{static get info(){return{section:"resource",order:300}}static init(e,t){this.upgrade(e,"spell","resource.addHandler",(function(...e){return ResourcePerk._addHandler(...e)})),this.upgrade(e,"inventory","resource.resources",{}),this.upgrade(e,"event","doApplySettings",ResourcePerk.ResourcePerk_onDoApplySettings),this.upgrade(e,"event","doFetch",ResourcePerk.ResourcePerk_onDoFetch),this.upgrade(e,"event","doSubmit",ResourcePerk.ResourcePerk_onDoSubmit)}static ResourcePerk_onDoApplySettings(e,i,r){let s=[];return Object.entries(t.Util.safeGet(i.detail,"settings.resource.handlers",{})).forEach((([e,t])=>{s.push(ResourcePerk._addHandler(this,e,t))})),Promise.all(s)}static ResourcePerk_onDoFetch(e,i,r){let s=[];return Object.keys(this.get("inventory","resource.resources")).forEach((e=>{let r=this.get("inventory",`resource.resources.${e}`);r.options.get("autoFetch",!0)&&(r.target.id=t.Util.safeGet(i.detail,"id",r.target.id),r.target.parameters=t.Util.safeGet(i.detail,"parameters",r.target.parameters),s.push(r.load(r.target.id,r.target.parameters).then((()=>{i.detail.items=r.items}))))})),Promise.all(s)}static ResourcePerk_onDoSubmit(e,i,r){let s=[],a=t.Util.safeGet(i.detail,"items");return Object.keys(this.get("inventory","resource.resources")).forEach((e=>{let r=this.get("inventory",`resource.resources.${e}`);if(r.options.get("autoSubmit",!0)){let o=t.Util.safeGet(i.detail,"method",r.target.method||"update"),l=t.Util.safeGet(i.detail,"id",r.target.id),n=t.Util.safeGet(i.detail,"parameters",r.target.parameters);s.push(this.get("inventory",`resource.resources.${e}`)[o](l,a,n))}})),Promise.all(s)}static _addHandler(e,i,r){t.Util.assert(r.handlerClassName,`ResourcePerk._addHandler(): handler class name not specified. name=${e.tagName}, handlerName=${i}`);let s=Promise.resolve(),a=e.get("inventory",`resource.resources.${i}`);return a||(a=t.ClassUtil.createObject(r.handlerClassName,e,i,r),e.set("inventory",`resource.resources.${i}`,a),s=a.init(r)),s}}class ValidationPerk extends t.Perk{static get info(){return{section:"validation",order:310}}static init(e,t){this.upgrade(e,"spell","validation.addHandler",(function(...e){return ValidationPerk._addHandler(...e)})),this.upgrade(e,"spell","validation.validate",(function(...e){return ValidationPerk._validate(...e)})),this.upgrade(e,"inventory","validation.validators",{}),this.upgrade(e,"state","validation.validationResult",{}),this.upgrade(e,"state","validation.validationResult",{}),this.upgrade(e,"event","doApplySettings",ValidationPerk.ValidationPerk_onDoApplySettings),this.upgrade(e,"event","doValidate",ValidationPerk.ValidationPerk_onDoValidate),this.upgrade(e,"event","doReportValidity",ValidationPerk.ValidationPerk_onDoReportValidity)}static ValidationPerk_onDoApplySettings(e,i,r){let s=[];return Object.entries(t.Util.safeGet(i.detail,"settings.validation.handlers",{})).forEach((([e,t])=>{s.push(ValidationPerk._addHandler(this,e,t))})),Promise.all(s)}static ValidationPerk_onDoValidate(e,i,r){let s=i.detail.validatorName;if(s){t.Util.assert(this.get("inventory",`validation.validators.${s}`),`ValidationPerk.ValidationPerk_onDoValidate(): Validator not found. name=${this.tagName}, validatorName=${s}`);let e=t.Util.safeGet(i.detail,"items"),r=this.get("setting",`validation.handlers.${s}.rules`),a=this.get("setting",`validation.handlers.${s}.handlerOptions`);this.get("inventory",`validation.validators.${s}`).checkValidity(e,r,a)}}static ValidationPerk_onDoReportValidity(e,i,r){let s=i.detail.validatorName;if(s){t.Util.assert(this.get("inventory",`validation.validators.${s}`),`ValidationPerk.ValidationPerk_onDoReportValidity(): Validator not found. name=${this.tagName}, validatorName=${s}`);let e=t.Util.safeGet(i.detail,"items"),r=this.get("setting",`validation.handlers.${s}.rules`),a=this.get("setting",`validation.handlers.${s}.handlerOptions`);this.get("inventory",`validation.validators.${s}`).reportValidity(e,r,a)}}static _addHandler(e,i,r){let s=Promise.resolve(),a=e.get("inventory",`validation.validators.${i}`);return r.handlerClassName&&!a&&(a=t.ClassUtil.createObject(r.handlerClassName,e,i,r),e.set("inventory",`validation.validators.${i}`,a),s=a.init(r)),s}static _validate(e,t){return t=t||{},e.set("state","validation.validationResult.result",!0),Promise.resolve().then((()=>e.use("spell","event.trigger","beforeValidate",t))).then((()=>e.use("spell","event.trigger","doValidate",t))).then((()=>e.get("state","validation.validationResult.result")?e.use("spell","event.trigger","doValidateSuccess",t):e.use("spell","event.trigger","doValidateFail",t))).then((()=>{if(!e.get("state","validation.validationResult.result"))return e.use("spell","event.trigger","doReportValidity",t)})).then((()=>e.use("spell","event.trigger","afterValidate",t)))}}class FormPerk extends t.Perk{static get info(){return{section:"form",order:310,depends:"ValidationPerk"}}static FormPerk_onAfterTransform(e,t,i){r.hideConditionalElements(this)}static FormPerk_onDoClear(e,i,r){if(this.get("setting","form.options.autoClear",!0)){let e=t.Util.safeGet(i.detail,"target",""),r=Object.assign({target:e,triggerEvent:"change"},i.detail.options);ValueUtil.clearFields(this,r)}}static FormPerk_onBeforeFill(e,t,i){t.detail.refill&&(t.detail.items=this.get("vault","form.lastItems"))}static FormPerk_onDoFill(e,i,s){if(this.get("setting","form.options.autoFill",!0)){let e=i.detail&&"rootNode"in i.detail?t.Util.scopedSelectorAll(this,i.detail.rootNode)[0]:this;ValueUtil.setFields(e,i.detail.items,{resources:this.get("inventory","resource.resources"),triggerEvent:!0}),r.showConditionalElements(this,i.detail.items)}this.set("vault","form.lastItems",i.detail.items)}static FormPerk_onDoCollect(e,t,i){this.get("setting","form.options.autoCollect",!0)&&(t.detail.items=ValueUtil.getFields(this))}static FormPerk_onAfterCollect(e,t,i){this.get("setting","form.options.autoCrop",!0)&&(t.detail.items=FormPerk.__collectData(this,t.detail.items))}static init(e,t){this.upgrade(e,"skill","form.build",(function(...e){return FormPerk._build(...e)})),this.upgrade(e,"spell","form.submit",(function(...e){return FormPerk._submit(...e)})),this.upgrade(e,"state","form.cancelSubmit",!1),this.upgrade(e,"vault","form.lastItems",{}),this.upgrade(e,"event","afterTransform",FormPerk.FormPerk_onAfterTransform),this.upgrade(e,"event","doClear",FormPerk.FormPerk_onDoClear),this.upgrade(e,"event","beforeFill",FormPerk.FormPerk_onBeforeFill),this.upgrade(e,"event","doFill",FormPerk.FormPerk_onDoFill),this.upgrade(e,"event","doCollect",FormPerk.FormPerk_onDoCollect),this.upgrade(e,"event","afterCollect",FormPerk.FormPerk_onAfterCollect)}static _build(e,t,i,s){r.build(t,i,s)}static _submit(e,t){return t=t||{},e.set("state","form.cancelSubmit",!1),Promise.resolve().then((()=>FormPerk.__collect(e,t))).then((()=>{if(e.get("setting","form.options.autoValidate",!0))return t.validatorName=t.validatorName||e.get("setting","form.options.validatorName"),e.use("spell","validation.validate",t).then((()=>{e.get("state","validation.validationResult.result")||e.set("state","form.cancelSubmit",!0)}))})).then((()=>e.use("spell","event.trigger","beforeSubmit",t).then((()=>{if(!e.get("state","form.cancelSubmit"))return Promise.resolve().then((()=>e.use("spell","event.trigger","doSubmit",t))).then((()=>e.use("spell","event.trigger","afterSubmit",t)))}))))}static __collect(e,t){return Promise.resolve().then((()=>e.use("spell","event.trigger","beforeCollect",t))).then((()=>e.use("spell","event.trigger","doCollect",t))).then((()=>e.use("spell","event.trigger","afterCollect",t)))}static __collectData(e,i){let r={},s=t.Util.scopedSelectorAll(e,"[bm-submit]");return s=Array.prototype.slice.call(s,0),s.forEach((e=>{let t=e.getAttribute("bm-bind");r[t]=i[t]})),r}}class ListPerk extends t.Perk{static get info(){return{section:"list",order:310}}static init(e,t){this.upgrade(e,"spell","list.transformRow",(function(...e){return ListPerk._transformRow(...e)})),this.upgrade(e,"vault","list.lastItems",{}),this.upgrade(e,"state","list.active.skinName",""),this.upgrade(e,"event","afterTransform",ListPerk.ListPerk_onAfterTransform),this.upgrade(e,"event","beforeFill",ListPerk.ListPerk_onBeforeFill),this.upgrade(e,"event","doFill",ListPerk.ListPerk_onDoFill)}static ListPerk_onAfterTransform(e,i,r){let s=this.get("setting","list.options.listRootNode");return this._listRootNode=s?t.Util.scopedSelectorAll(this.unitRoot,s)[0]:this.unitRoot,t.Util.assert(this._listRootNode,`List.ListPerk_onAfterTransform(): List root node not found. name=${this.tagName}, listRootNode=${this.get("setting","setting.listRootNode")}`),ListPerk._transformRow(this,this.get("setting","list.options.rowSkinName","row"))}static ListPerk_onBeforeFill(e,t,i){t.detail.refill&&(t.detail.items=this.get("vault","list.lastItems"))}static ListPerk_onDoFill(e,i,r){let s=t.Util.safeGet(i.detail.options,"async",this.get("setting","list.options.async",!0))?ListPerk.__buildAsync:ListPerk.__buildSync,a=document.createDocumentFragment();return Promise.resolve().then((()=>this.use("spell","event.trigger","beforeBuildRows"))).then((()=>s(this,a,i.detail.items,i.detail))).then((()=>(this._listRootNode.replaceChildren(a),this.set("vault","list.lastItems",i.detail.items),this.use("spell","event.trigger","afterBuildRows"))))}static _transformRow(e,t,i){return i=i||{},e.get("state","list.active.skinName")===t?Promise.resolve():Promise.resolve().then((()=>e.use("spell","skin.summon",t))).then((()=>{e.set("state","list.active.skinName",t)})).then((()=>e.use("spell","event.trigger","afterTransformRow",i))).then((()=>{}))}static __buildSync(e,i,s,a){let o=e.get("inventory","inventory","skin.skins"),l=e.get("state","list.active.skinName");t.Util.assert(o[l],`List.__buildSync(): Row skin not loaded yet. name=${e.tagName}, rowSkinName=${l}`);let n=e.get("setting","list.rowevents"),c=o[l].HTML,d=Promise.resolve();for(let t=0;t<s.length;t++)d=d.then((()=>{a.no=t,a.item=s[t];let o=ListPerk.__createRow(c);return i.appendChild(o),a.element=o,n&&Object.keys(n).forEach((t=>{e.use("skill","event.init",t,n[t],o)})),e.use("spell","event.trigger","beforeFillRow",a).then((()=>(e.get("setting","list.options.autoFill",!0)&&(r.showConditionalElements(o,a.item),ValueUtil.setFields(o,a.item,{resources:e.get("inventory","inventory","resource.resources")})),e.use("spell","event.trigger","doFillRow",a)))).then((()=>e.use("spell","event.trigger","afterFillRow",a)))}));return d.then((()=>{delete a.no,delete a.item,delete a.element}))}static __buildAsync(e,i,s,a){let o=e.get("inventory","skin.skins"),l=e.get("state","list.active.skinName");t.Util.assert(o[l],`List.__buildAsync(): Row skin not loaded yet. name=${e.tagName}, rowSkinName=${l}`);let n=e.get("setting","list.rowevents"),c=o[l].HTML;for(let t=0;t<s.length;t++){a.no=t,a.item=s[t];let o=ListPerk.__createRow(c);i.appendChild(o),a.element=o,n&&Object.keys(n).forEach((t=>{e.use("skill","event.init",t,n[t],o)})),e.use("skill","event.triggerSync","beforeFillRow",a),r.showConditionalElements(o,a.item),e.get("setting","list.options.autoFill",!0)&&ValueUtil.setFields(o,a.item,{resources:e.get("inventory","resource.resources")}),e.use("skill","event.triggerSync","doFillRow",a),e.use("skill","event.triggerSync","afterFillRow",a)}delete a.no,delete a.item,delete a.element}static __createRow(e){let t=document.createElement("tbody");t.innerHTML=e;let i=t.firstElementChild;return i.setAttribute("bm-powered",""),i}}class DatabindingPerk extends t.Perk{static get info(){return{section:"databinding",order:320}}static init(e,t){"single"===e.get("setting","databinding.options.dataType","single")?(this.upgrade(e,"skill","databinding.bindData",(function(...e){return DatabindingPerk._bindData(...e)})),this.upgrade(e,"vault","databinding.store",new BindableStore({resources:e.get("inventory","resource.resources"),direction:e.get("setting","databinding.options.direction","two-way")})),this.upgrade(e,"event","beforeTransform",DatabindingPerk.DatabindingPerk_onBeforeTransform),this.upgrade(e,"event","doFill",DatabindingPerk.DatabindingPerk_onDoFill)):(this.upgrade(e,"skill","databinding.bindData",(function(...e){return DatabindingPerk._bindDataArray(...e)})),this.upgrade(e,"vault","databinding.store",new BindableArrayStore({resources:e.resources,direction:e.get("setting","databinding.options.direction","two-way")})),this.upgrade(e,"event","doFillRow",DatabindingPerk.DatabindingPerk_onDoFillRow)),this.upgrade(e,"event","doClear",DatabindingPerk.DatabindingPerk_onDoClear),this.upgrade(e,"event","doCollect",DatabindingPerk.DatabindingPerk_onDoCollect)}static DatabindingPerk_onBeforeTransform(e,t,i){DatabindingPerk._bindData(this)}static DatabindingPerk_onDoClear(e,t,i){this.get("vault","databinding.store").clear()}static DatabindingPerk_onDoFill(e,t,i){t.detail.items&&(this.get("vault","databinding.store").replace(t.detail.items),r.showConditionalElements(this,t.detail.items))}static DatabindingPerk_onDoFillRow(e,t,i){DatabindingPerk._bindDataArray(this,t.detail.no,t.detail.element,t.detail.callbacks),this.get("vault","databinding.store").replace(t.detail.no,t.detail.item)}static DatabindingPerk_onDoCollect(e,t,i){this.get("setting","databinding.options.autoCollect",!0)&&(t.detail.items=this.get("vault","databinding.store").items)}static _bindData(e,i){i=i||e;let r=t.Util.scopedSelectorAll(i,"[bm-bind]");r=Array.prototype.slice.call(r,0),i.matches("[bm-bind]")&&r.push(i),r.forEach((t=>{let i=t.getAttribute("bm-bind"),r=DatabindingPerk.__getCallback(e,i);e.get("vault","databinding.store").bindTo(i,t,r)}))}static _bindDataArray(e,i,r){r=r||e;let s=t.Util.scopedSelectorAll(r,"[bm-bind]");s=Array.prototype.slice.call(s,0),r.matches("[bm-bind]")&&s.push(r),s.forEach((t=>{let r=t.getAttribute("bm-bind"),s=DatabindingPerk.__getCallback(e,r);e.get("vault","databinding.store").bindTo(i,r,t,s)}))}static __getCallback(e,t){let i;return Object.entries(e.get("setting","databinding",{})).forEach((([e,r])=>{if(r.callback){const s=r.key||e;new RegExp(s).test(t)&&(i=r.callback)}})),i}}class LocaleServer extends t.Unit{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["LocaleServer_onBeforeStart"],doApplyLocale:["LocaleServer_onDoApplyLocale"]}}}},locale:{handlers:{default:{handlerClassName:"BITSMIST.v1.LocaleHandler"}}},skin:{options:{skinRef:!1}},style:{options:{styleRef:!1}}}}LocaleServer_onBeforeStart(e,t,i){this._store=new ObservableStore({async:!0})}LocaleServer_onDoApplyLocale(e,t,i){if(this.get("setting","options.autoAttribute")){let e=this.get("setting","options.autoAttribute.rootNode"),t=e?document.querySelector(e):document.body,i=this.get("setting","options.autoAttribute.attributeName","data-locale");t.setAttribute(i,this.get("state","locale.active.localeName"))}return this._store.notify("*",t.detail)}subscribe(e,t){this._store.subscribe(`${e.tagName}_${e.uniqueId}`,this.__triggerEvent.bind(e))}__triggerEvent(e,t,i){return this.use("spell","locale.apply",{localeName:i.localeName})}}customElements.define("bm-locale",LocaleServer);class LocalePerk extends t.Perk{static get info(){return{section:"locale",order:215}}static init(e,t){this.upgrade(e,"skill","locale.localize",(function(...e){return LocalePerk._localize(...e)})),this.upgrade(e,"skill","locale.translate",(function(...e){return LocalePerk._getLocaleMessage(...e)})),this.upgrade(e,"spell","locale.apply",(function(...e){return LocalePerk._applyLocale(...e)})),this.upgrade(e,"spell","locale.summon",(function(...e){return LocalePerk._loadMessages(...e)})),this.upgrade(e,"spell","locale.addHandler",(function(...e){return LocalePerk._addHandler(...e)})),this.upgrade(e,"inventory","locale.localizers",{}),this.upgrade(e,"inventory","locale.messages",new MultiStore),this.upgrade(e,"state","locale.active",{localeName:e.get("setting","locale.options.localeName",e.get("setting","system.locale.options.localeName",navigator.language.substring(0,2))),fallbackLocaleName:e.get("setting","locale.options.fallbackLocaleName",e.get("setting","system.locale.options.fallbackLocaleName","en")),currencyName:e.get("setting","locale.options.currencyName",e.get("setting","system.locale.options.currencyName","USD"))}),this.upgrade(e,"event","doApplySettings",LocalePerk.LocalePerk_onDoApplySettings),this.upgrade(e,"event","doSetup",LocalePerk.LocalePerk_onDoSetup),this.upgrade(e,"event","beforeApplyLocale",LocalePerk.LocalePerk_onBeforeApplyLocale),this.upgrade(e,"event","doApplyLocale",LocalePerk.LocalePerk_onDoApplyLocale),e.get("setting","locale.options.autoLocalizeRows")&&this.upgrade(e,"event","afterFillRow",LocalePerk.LocalePerk_onAfterFillRow)}static LocalePerk_onDoApplySettings(e,i,r){let s=[];Object.entries(t.Util.safeGet(i.detail,"settings.locale.handlers",{})).forEach((([e,t])=>{s.push(LocalePerk._addHandler(this,e,t))}));let a=this.get("setting","locale.options.localeServer",this.get("setting","system.locale.options.localeServer"));return a=!0===a?"bm-locale":a,!a||this instanceof LocaleServer||s.push(this.use("spell","status.wait",[a]).then((()=>{let e=document.querySelector(a);e.subscribe(this),this.set("vault","locale.server",e);let t=e.get("state","locale.active");this.set("state","locale.active.localeName",t.localeName),this.set("state","locale.active.fallbackLocaleName",t.fallbackLocaleName),this.set("state","locale.active.currencyName",t.currencyName)}))),Promise.all(s)}static LocalePerk_onDoSetup(e,t,i){return LocalePerk._applyLocale(this,{localeName:this.get("state","locale.active.localeName")})}static LocalePerk_onBeforeApplyLocale(e,t,i){return this.use("spell","locale.summon",t.detail.localeName)}static LocalePerk_onDoApplyLocale(e,t,i){if(LocalePerk._localize(this,this),"ready"===this.get("state","status.status"))return this.use("spell","basic.fill",{refill:!0})}static LocalePerk_onAfterFillRow(e,t,i){LocalePerk._localize(this,t.detail.element,t.detail.item)}static _addHandler(e,i,r){let s=Promise.resolve();if(!e.get("inventory",`locale.localizers.${i}`)){let a=t.Util.safeGet(r,"handlerClassName","BITSMIST.v1.LocaleHandler"),o=t.ClassUtil.createObject(a,e,r);e.set("inventory",`locale.localizers.${i}`,o),s=o.init(r)}return s}static _applyLocale(e,t){return Promise.resolve().then((()=>e.use("spell","event.trigger","beforeApplyLocale",t))).then((()=>(e.set("state","locale.active.localeName",t.localeName),e.use("spell","event.trigger","doApplyLocale",t)))).then((()=>e.use("spell","event.trigger","afterApplyLocale",t)))}static _localize(e,t,i){t=t||e,Object.keys(e.get("inventory","locale.localizers")).forEach((r=>{e.get("inventory",`locale.localizers.${r}`).localize(t,Object.assign({interpolation:i},e.get("state","locale.active")))}))}static _loadMessages(e,t,i){let r=[];return Object.keys(e.get("inventory","locale.localizers")).forEach((s=>{r.push(e.get("inventory",`locale.localizers.${s}`).loadMessages(t,i))})),Promise.all(r)}static _getLocaleMessage(e,t,i){i=i||e.get("state","locale.active.localeName");let r=e.get("inventory","locale.messages").get(`${i}.${t}`);return void 0===r&&(r=e.get("inventory","locale.messages").get(`${e.get("state","locale.fallbackLocaleName")}.${t}`)),r}}class KeyPerk extends t.Perk{static get info(){return{section:"key",order:800}}static init(e,t){this.upgrade(e,"state","key.isComposing",!1),this.upgrade(e,"event","afterTransform",KeyPerk.KeyPerk_onAfterTransform)}static KeyPerk_onAfterTransform(e,t,i){let r=this.get("setting","key.keys");if(r){let e=KeyPerk.__getActions(r);this.addEventListener("keydown",(function(e){KeyPerk.KeyPerk_onKeyDown.call(this,e,this)})),this.addEventListener("keyup",(function(t){KeyPerk.KeyPerk_onKeyUp.call(this,t,this,r,e)})),Object.entries(r).forEach((([e,t])=>{KeyPerk.__initButtons(this,e,t)}))}}static KeyPerk_onKeyDown(e,t){t.set("state","key.isComposing",229===e.keyCode)}static KeyPerk_onKeyUp(e,t,i,r){if(t.get("state","key.isComposing"))return;let s=e.key?e.key:KeyPerk.__getKeyfromKeyCode(e.keyCode);switch(s){case"Esc":s="Escape";break;case"Down":s="ArrowDown";break;case"Up":s="ArrowUp";break;case"Left":s="ArrowLeft";break;case"Right":s="ArrowRight"}s=s.toLowerCase(),r[s]&&r[s].handler.call(this,e,t,r[s].option)}static __defaultSubmit(e,t,i){return t.use("spell","form.submit").then((()=>{if(!t.get("state","form.cancelSubmit")&&(t.get("state","dialog.isModal")&&t.set("state","dialog.modalResult.result",!0),i&&i.autoClose))return t.use("spell","dialog.close",{reason:"submit"})}))}static __defaultCancel(e,t,i){return t.use("spell","dialog.close",{reason:"cancel"})}static __defaultClear(e,t,i){let r="";return this.hasAttribute("bm-cleartarget")&&(r=this.getAttribute("bm-cleartarget")),t.use("spell","basic.clear",{target:r,options:i.options})}static __getKeyfromKeyCode(e){let t;if(13===e)t="Enter";else t=String.fromCharCode(e);return t}static __initButtons(e,i,r){if(r&&r.rootNode){let s=r.handler?r.handler:KeyPerk.__getDefaultHandler(i);t.Util.scopedSelectorAll(e,r.rootNode).forEach((t=>{t.addEventListener("click",(function(t){s.call(this,t,e,r)}))}))}}static __getActions(e){let t={};return Object.keys(e).forEach((i=>{let r=Array.isArray(e[i].key)?e[i].key:[e[i].key];for(let s=0;s<r.length;s++)t[r[s]]={},t[r[s]].type=i,t[r[s]].handler=e[i].handler?e[i].handler:KeyPerk.__getDefaultHandler(i),t[r[s]].option=e[i]})),t}static __getDefaultHandler(e){let t;switch(e){case"submit":t=KeyPerk.__defaultSubmit;break;case"clear":t=KeyPerk.__defaultClear;break;case"cancel":t=KeyPerk.__defaultCancel}return t}}class ChainPerk extends t.Perk{static get info(){return{section:"chain",order:800}}static init(e,t){this.upgrade(e,"event","doApplySettings",ChainPerk.onDoApplySettings)}static deinit(t,i){let r=e.details.setting.chains;r&&Object.keys(r).forEach((e=>{t.removeEventHandler(e,{handler:ChainPerk.onDoApplySettings,options:r[e]})}))}static onDoApplySettings(e,i,r){let s=ChainPerk.info.order;Object.entries(t.Util.safeGet(i.detail,"settings.chain.targets",{})).forEach((([e,t])=>{this.use("skill","event.add",e,{handler:ChainPerk.onDoProcess,order:s,options:t})}))}static onDoProcess(e,i,r){let s=r.options,a=[],o=Promise.resolve();for(let e=0;e<s.length;e++){let r=s[e].skillName||"basic.refresh",l=s[e].status||"ready",n=s[e].sync,c=this.use("skill","basic.locateAll",s[e]);t.Util.warn(c.length>0,`ChainPerk.onDoProcess(): Node not found. name=${this.tagName}, eventName=${i.type}, rootNode=${JSON.stringify(s[e])}, method=${r}`),o=n?o.then((()=>ChainPerk.__execTarget(this,c,r,l))):ChainPerk.__execTarget(this,c,r,l),a.push(o)}return Promise.all(a)}static __execTarget(e,t,i,r){let s=[];return t.forEach((t=>{let a=e.use("spell","status.wait",[{object:t,status:r}]).then((()=>t.use("spell",i,{sender:e})));s.push(a)})),Promise.all(s)}}class DialogPerk extends t.Perk{static get info(){return{section:"dialog",order:800}}static init(e,t){this.upgrade(e,"spell","dialog.open",(function(...e){return DialogPerk._open(...e)})),this.upgrade(e,"spell","dialog.openModal",(function(...e){return DialogPerk._openModal(...e)})),this.upgrade(e,"spell","dialog.close",(function(...e){return DialogPerk._close(...e)})),this.upgrade(e,"inventory","dialog.cancelClose"),this.upgrade(e,"vault","dialog.modalPromise"),this.upgrade(e,"vault","dialog.backdrop"),this.upgrade(e,"vault","dialog.backdropPromise",Promise.resolve()),this.upgrade(e,"state","dialog.isModal",!1),this.upgrade(e,"state","dialog.modalResult",{}),this.upgrade(e,"event","afterReady",DialogPerk.DialogPerk_onAfterReady)}static DialogPerk_onAfterReady(e,t,i){if(this.get("setting","dialog.options.autoOpen"))return this.use("spell","dialog.open")}static _open(e,i){return i=i||{},e.set("vault","dialog.options",i),e.use("spell","event.trigger","beforeOpen",i).then((()=>{if(!e.get("inventory","dialog.cancelOpen"))return Promise.resolve().then((()=>{if(e.get("setting","dialog.options.showBackdrop"))return DialogPerk.__showBackdrop(e,e.get("setting","dialog.backdropOptions"))})).then((()=>{if(t.Util.safeGet(i,"autoSetupOnOpen",e.get("setting","dialog.options.autoSetupOnOpen",!1)))return e.use("spell","basic.setup",i)})).then((()=>{if(t.Util.safeGet(i,"autoRefreshOnOpen",e.get("setting","dialog.options.autoRefreshOnOpen",!0)))return e.use("spell","basic.refresh",i)})).then((()=>e.use("spell","event.trigger","doOpen",i))).then((()=>e.use("spell","event.trigger","afterOpen",i)))}))}static _openModal(e,t){return new Promise(((i,r)=>(e.set("state","dialog.isModal",!0),e.set("state","dialog.modalResult",{result:!1}),e.set("vault","dialog.modalPromise",{resolve:i,reject:r}),DialogPerk._open(e,t))))}static _close(e,t){return t=t||{},e.set("inventory","dialog.cancelClose",!1),e.use("spell","event.trigger","beforeClose",t).then((()=>{if(!e.get("inventory","dialog.cancelClose"))return e.use("spell","event.trigger","doClose",t).then((()=>{if(e.get("setting","dialog.options.showBackdrop"))return DialogPerk.__removeCloseOnClickHandlers(),DialogPerk.__hideBackdrop(e,e.get("setting","dialog.backdropOptions"))})).then((()=>(e.get("state","dialog.isModal")&&e.get("vault","dialog.modalPromise").resolve(e.get("state","dialog.modalResult")),e.use("spell","event.trigger","afterClose",t))))}))}static __createBackdrop(e,t){DialogPerk._backdrop||(document.body.insertAdjacentHTML("afterbegin",'<div class="backdrop"></div>'),DialogPerk._backdrop=document.body.firstElementChild)}static __showBackdrop(e,i){return DialogPerk.__createBackdrop(e),e.get("vault","dialog.backdropPromise").then((()=>{if(e.set("vault","dialog.backdropPromise",new Promise(((r,s)=>{window.getComputedStyle(DialogPerk._backdrop).getPropertyValue("visibility");let a=["show"].concat(e.get("setting","dialog.backdropOptions.showOptions.addClasses",[]));DialogPerk._backdrop.classList.add(...a),DialogPerk._backdrop.classList.remove(...e.get("setting","dialog.backdropOptions.showOptions.removeClasses",[]));let o=DialogPerk.__getEffect();o?DialogPerk._backdrop.addEventListener(`${o}end`,(()=>{t.Util.safeGet(i,"closeOnClick",!0)&&DialogPerk.__installCloseOnClickHandler(e),r()}),{once:!0}):(t.Util.safeGet(i,"closeOnClick",!0)&&DialogPerk.__installCloseOnClickHandler(e),r())}))),t.Util.safeGet(i,"showOptions.sync",t.Util.safeGet(i,"sync")))return e.get("vault","dialog.backdropPromise")}))}static __hideBackdrop(e,i){return e.get("vault","dialog.backdropPromise").then((()=>{if(e.set("vault","dialog.backdropPromise",new Promise(((t,i)=>{window.getComputedStyle(DialogPerk._backdrop).getPropertyValue("visibility");let r=["show"].concat(e.get("setting","dialog.backdropOptions.hideOptions.removeClasses",[]));DialogPerk._backdrop.classList.remove(...r),DialogPerk._backdrop.classList.add(...e.get("setting","dialog.backdropOptions.hideOptions.addClasses",[]));let s=DialogPerk.__getEffect();s?DialogPerk._backdrop.addEventListener(`${s}end`,(()=>{t()}),{once:!0}):t()}))),t.Util.safeGet(i,"hideOptions.sync",t.Util.safeGet(i,"sync")))return e.get("vault","dialog.backdropPromise")}))}static __installCloseOnClickHandler(e,t){DialogPerk._backdrop.onclick=t=>{t.target===t.currentTarget&&DialogPerk._close(e,{reason:"cancel"})}}static __removeCloseOnClickHandlers(){DialogPerk._backdrop.onclick=null}static __getEffect(){let e="";return"0s"!==window.getComputedStyle(DialogPerk._backdrop).getPropertyValue("transition-duration")?e="transition":"none"!==window.getComputedStyle(DialogPerk._backdrop).getPropertyValue("animation-name")&&(e="animation"),e}}class PreferencePerk extends t.Perk{static get info(){return{section:"preference",order:900}}static init(e,t){this.upgrade(e,"skill","preference.get",(function(...e){return PreferencePerk._getPreferences(...e)})),this.upgrade(e,"spell","preference.set",(function(...e){return PreferencePerk._setPreferences(...e)})),this.upgrade(e,"spell","preference.apply",(function(...e){return PreferencePerk._applyPreferences(...e)})),this.upgrade(e,"vault","preference.server"),this.upgrade(e,"event","doApplySettings",PreferencePerk.PreferencePerk_onDoApplySettings),this.upgrade(e,"event","doSetup",PreferencePerk.PreferencePerk_onDoSetup)}static PreferencePerk_onDoApplySettings(e,i,r){let s=this.get("setting","locale.options.preferenceServer",this.get("setting","system.preference.options.preferenceServer"));return s=!0===s?"bm-preference":s,t.Util.assert(s,`Preference Server node not specified in settings. name=${this.tagName}`),this.use("spell","status.wait",[s]).then((()=>{let e=document.querySelector(s);e.subscribe(this,t.Util.safeGet(i.detail,"settings.preference")),this.set("vault","preference.server",e)}))}static PreferencePerk_onDoSetup(e,t,i){return this.use("spell","preference.apply",{preferences:this.get("vault","preference.server").items})}static _applyPreferences(e,t){return Promise.resolve().then((()=>e.use("spell","event.trigger","beforeApplyPreferences",t))).then((()=>e.use("spell","event.trigger","doApplyPreferences",t))).then((()=>e.use("spell","event.trigger","afterApplyPreferences",t)))}static _getPreferences(e,t,i){return t?e.get("vault","preference.server").getPreference(t,i):e.get("vault","preference.server").items}static _setPreferences(e,t,i){return e.get("vault","preference.server").setPreference(t,i,{sender:e})}}function s(e,t){void 0===t&&(t={});for(var i=function(e){for(var t=[],i=0;i<e.length;){var r=e[i];if("*"!==r&&"+"!==r&&"?"!==r)if("\\"!==r)if("{"!==r)if("}"!==r)if(":"!==r)if("("!==r)t.push({type:"CHAR",index:i,value:e[i++]});else{var s=1,a="";if("?"===e[l=i+1])throw new TypeError('Pattern cannot start with "?" at '.concat(l));for(;l<e.length;)if("\\"!==e[l]){if(")"===e[l]){if(0==--s){l++;break}}else if("("===e[l]&&(s++,"?"!==e[l+1]))throw new TypeError("Capturing groups are not allowed at ".concat(l));a+=e[l++]}else a+=e[l++]+e[l++];if(s)throw new TypeError("Unbalanced pattern at ".concat(i));if(!a)throw new TypeError("Missing pattern at ".concat(i));t.push({type:"PATTERN",index:i,value:a}),i=l}else{for(var o="",l=i+1;l<e.length;){var n=e.charCodeAt(l);if(!(n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||95===n))break;o+=e[l++]}if(!o)throw new TypeError("Missing parameter name at ".concat(i));t.push({type:"NAME",index:i,value:o}),i=l}else t.push({type:"CLOSE",index:i,value:e[i++]});else t.push({type:"OPEN",index:i,value:e[i++]});else t.push({type:"ESCAPED_CHAR",index:i++,value:e[i++]});else t.push({type:"MODIFIER",index:i,value:e[i++]})}return t.push({type:"END",index:i,value:""}),t}(e),r=t.prefixes,s=void 0===r?"./":r,o="[^".concat(a(t.delimiter||"/#?"),"]+?"),l=[],n=0,c=0,d="",u=function(e){if(c<i.length&&i[c].type===e)return i[c++].value},g=function(e){var t=u(e);if(void 0!==t)return t;var r=i[c],s=r.type,a=r.index;throw new TypeError("Unexpected ".concat(s," at ").concat(a,", expected ").concat(e))},h=function(){for(var e,t="";e=u("CHAR")||u("ESCAPED_CHAR");)t+=e;return t};c<i.length;){var p=u("CHAR"),m=u("NAME"),f=u("PATTERN");if(m||f){var _=p||"";-1===s.indexOf(_)&&(d+=_,_=""),d&&(l.push(d),d=""),l.push({name:m||n++,prefix:_,suffix:"",pattern:f||o,modifier:u("MODIFIER")||""})}else{var v=p||u("ESCAPED_CHAR");if(v)d+=v;else if(d&&(l.push(d),d=""),u("OPEN")){_=h();var k=u("NAME")||"",b=u("PATTERN")||"",y=h();g("CLOSE"),l.push({name:k||(b?n++:""),pattern:k&&!b?o:b,prefix:_,suffix:y,modifier:u("MODIFIER")||""})}else g("END")}}return l}function a(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function o(e){return e&&e.sensitive?"":"i"}function l(e,t,i){return function(e,t,i){void 0===i&&(i={});for(var r=i.strict,s=void 0!==r&&r,l=i.start,n=void 0===l||l,c=i.end,d=void 0===c||c,u=i.encode,g=void 0===u?function(e){return e}:u,h=i.delimiter,p=void 0===h?"/#?":h,m=i.endsWith,f="[".concat(a(void 0===m?"":m),"]|$"),_="[".concat(a(p),"]"),v=n?"^":"",k=0,b=e;k<b.length;k++){var y=b[k];if("string"==typeof y)v+=a(g(y));else{var P=a(g(y.prefix)),S=a(g(y.suffix));if(y.pattern)if(t&&t.push(y),P||S)if("+"===y.modifier||"*"===y.modifier){var R="*"===y.modifier?"?":"";v+="(?:".concat(P,"((?:").concat(y.pattern,")(?:").concat(S).concat(P,"(?:").concat(y.pattern,"))*)").concat(S,")").concat(R)}else v+="(?:".concat(P,"(").concat(y.pattern,")").concat(S,")").concat(y.modifier);else"+"===y.modifier||"*"===y.modifier?v+="((?:".concat(y.pattern,")").concat(y.modifier,")"):v+="(".concat(y.pattern,")").concat(y.modifier);else v+="(?:".concat(P).concat(S,")").concat(y.modifier)}}if(d)s||(v+="".concat(_,"?")),v+=i.endsWith?"(?=".concat(f,")"):"$";else{var w=e[e.length-1],E="string"==typeof w?_.indexOf(w[w.length-1])>-1:void 0===w;s||(v+="(?:".concat(_,"(?=").concat(f,"))?")),E||(v+="(?=".concat(_,"|").concat(f,")"))}return new RegExp(v,o(i))}(s(e,i),t,i)}function n(e,t,i){return e instanceof RegExp?function(e,t){if(!t)return e;for(var i=/\((?:\?<(.*?)>)?(?!\?)/g,r=0,s=i.exec(e.source);s;)t.push({name:s[1]||r++,prefix:"",suffix:"",modifier:"",pattern:""}),s=i.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,i){var r=e.map((function(e){return n(e,t,i).source}));return new RegExp("(?:".concat(r.join("|"),")"),o(i))}(e,t,i):l(e,t,i)}class RoutePerk extends t.Perk{static get info(){return{section:"routing",order:900,depends:"ValidationPerk"}}static globalInit(){history.replaceState(RoutePerk.__getState("connect"),null,null)}static init(e,t){this.upgrade(e,"skill","routing.addRoute",(function(...e){return RoutePerk._addRoute(...e)})),this.upgrade(e,"skill","routing.jumpRoute",(function(...e){return RoutePerk._jumpRoute(...e)})),this.upgrade(e,"skill","routing.refreshRoute",(function(...e){return RoutePerk._refreshRoute(...e)})),this.upgrade(e,"skill","routing.replaceRoute",(function(...e){return RoutePerk._replaceRoute(...e)})),this.upgrade(e,"spell","routing.switch",(function(...e){return RoutePerk._switchRoute(...e)})),this.upgrade(e,"spell","routing.openRoute",(function(...e){return RoutePerk._open(...e)})),this.upgrade(e,"spell","routing.updateRoute",(function(...e){return RoutePerk._updateRoute(...e)})),this.upgrade(e,"spell","routing.refreshRoute",(function(...e){return RoutePerk._refreshRoute(...e)})),this.upgrade(e,"spell","routing.normalizeRoute",(function(...e){return RoutePerk._normalizeROute(...e)})),this.upgrade(e,"vault","routing.routes",[]),this.upgrade(e,"state","routing.routeInfo",{}),this.upgrade(e,"event","doApplySettings",RoutePerk.RoutePerk_onDoApplySettings),this.upgrade(e,"event","doStart",RoutePerk.RoutePerk_onDoStart),this.upgrade(e,"event","afterReady",RoutePerk.RoutePerk_onAfterReady),this.upgrade(e,"event","doValidateFail",RoutePerk.RoutePerk_onDoValidateFail),this.upgrade(e,"event","doReportValidity",RoutePerk.RoutePerk_onDoReportValidity),RoutePerk.__initPopState(e)}static RoutePerk_onDoApplySettings(e,i,r){Object.entries(t.Util.safeGet(i.detail,"settings.routing.routes",{})).forEach((([e,t])=>{RoutePerk._addRoute(this,e,t)})),this.set("state","routing.routeInfo",RoutePerk.__loadRouteInfo(this,window.location.href))}static RoutePerk_onDoStart(e,t,i){let r=this.get("state","routing.routeInfo.name");if(r){let e={query:this.get("setting","unit.options.query")};return this.use("spell","routing.switch",r,e)}throw new Error("route not found")}static RoutePerk_onAfterReady(e,t,i){return this.use("spell","routing.openRoute")}static RoutePerk_onDoValidateFail(e,t,i){this.get("setting","routing.options.autoFix")&&RoutePerk.__fixRoute(this,t.detail.url)}static RoutePerk_onDoReportValidity(e,t,i){throw RoutePerk.__dumpValidationErrors(this),new URIError("URL validation failed.")}static _addRoute(e,t,i,r){let s=[],a={title:t,name:i.name||t,origin:i.origin,path:i.path,settingsRef:i.settingsRef,settings:i.settings,extenderRef:i.extenderRef,extender:i.extender,routeOptions:i.routeOptions,_re:n(i.path,s),_keys:s},o=e.get("vault","routing.routes");r?o.unshift(a):o.push(a),e.set("vault","routing.routes",o)}static _loadSettings(e,i,r){return t.AjaxUtil.loadJSON(RoutePerk.__getSettingsURL(e,i),Object.assign({bindTo:this._unit},r)).then((t=>{e.set("state","routing.routeInfo.settings",t)}))}static _loadExtender(e,i,r){return Promise.resolve().then((()=>{if(!e.get("state","routing.routeInfo.extender"))return t.AjaxUtil.loadText(RoutePerk.__getExtenderURL(e,i)).then((t=>{e.set("state","routing.routeInfo.extender",t)}))})).then((()=>{let t=e.get("state","routing.routeInfo.extender");t&&new Function(`"use strict";${t}`)()}))}static _switchRoute(e,i,r){let s;return t.Util.assert(i,"RoutePerk._switchRoute(): A route name not specified.",TypeError),Promise.resolve().then((()=>{if(RoutePerk.__hasExternalSettings(e,i))return RoutePerk._loadSettings(e,i)})).then((()=>{if(RoutePerk.__hasExternalExtender(e,i))return RoutePerk._loadExtender(e)})).then((()=>(s=e.get("state","routing.routeInfo.settings"),e.use("skill","setting.merge",s),e.use("spell","setting.apply",{settings:s}))))}static _open(e,i,r){r=Object.assign({},r);let s,a,o=e.get("state","routing.routeInfo");if(i?(s=t.URLUtil.buildURL(i,r),a=RoutePerk.__loadRouteInfo(e,s)):(s=window.location.href,a=o),!r.jump&&a.name&&o.name==a.name)return Promise.resolve().then((()=>{t.Util.safeGet(r,"pushState",!!i)&&history.pushState(RoutePerk.__getState("_open.pushState"),null,s),e.set("state","routing.routeInfo",a)})).then((()=>{if(e.get("setting","routing.options.autoValidate")){let i={validatorName:e.get("setting","routing.options.validatorName"),items:t.URLUtil.loadParameters(s),url:s};return e.use("spell","validation.validate",i)}})).then((()=>RoutePerk._refreshRoute(e,a,r))).then((()=>RoutePerk._normalizeRoute(e,window.location.href)));window.location.href=s}static _jumpRoute(e,i,r){let s=t.URLUtil.buildURL(i,r);window.location.href=s}static _updateRoute(e,t,i,r){return RoutePerk._switchRoute(e,i.name)}static _refreshRoute(e,t,i){return e.use("spell","basic.refresh",i)}static _replaceRoute(e,i,r){history.replaceState(RoutePerk.__getState("replaceRoute",window.history.state),null,t.URLUtil.buildURL(i,r)),e.set("state","routing.routeInfo",RoutePerk.__loadRouteInfo(e,window.location.href))}static _normalizeRoute(e,t){return Promise.resolve().then((()=>e.use("spell","event.trigger","beforeNormalizeURL"))).then((()=>e.use("spell","event.trigger","doNormalizeURL"))).then((()=>e.use("spell","event.trigger","afterNormalizeURL")))}static __hasExternalSettings(e,t){let i=!1;return e.get("state","routing.routeInfo.settings")||(i=!0),i}static __getSettingsURL(e,i){let r,s,a,o=e.get("state","routing.routeInfo.settingsRef");if(o&&!0!==o){let e=t.URLUtil.parseURL(o);s=e.filename,r=e.path,a=e.query}else{r=t.Util.concatPath([e.get("setting","system.unit.options.path",""),e.get("setting","unit.options.path","")]);let o=RoutePerk.__getSettingFormat(e);s=e.get("setting","unit.options.fileName",e.tagName.toLowerCase())+"."+i+".settings."+o,a=e.get("setting","unit.options.query")}return t.Util.concatPath([r,s])+(a?`?${a}`:"")}static __hasExternalExtender(e,t){let i=!1;return(e.get("state","routing.routeInfo.extenderRef")||e.get("state","routing.routeInfo.extender"))&&(i=!0),i}static __getExtenderURL(e,i){let r,s,a,o=e.get("state","routing.routeInfo.extenderRef");if(o&&!0!==o){let e=t.URLUtil.parseURL(o);r=e.path,s=e.filename,a=e.query}else r=r||t.Util.concatPath([e.get("setting","system.unit.options.path",""),e.get("setting","unit.options.path","")]),s=s||e.get("setting","unit.options.fileName",e.tagName.toLowerCase())+"."+i+".js",a=e.get("setting","unit.options.query");return t.Util.concatPath([r,s])+(a?`?${a}`:"")}static __loadRouteInfo(e,i){let r=new URL(i,window.location.href),s={URL:i,path:r.pathname,query:r.search,parsedURL:r,queryParameters:t.URLUtil.loadParameters(i)},a=e.get("vault","routing.routes");for(let i=a.length-1;i>=0;i--){if(a[i].origin&&r.origin!=a[i].origin)continue;let o=a[i].path?a[i]._re.exec(r.pathname):[];if(o){let r={};for(let e=0;e<o.length-1;e++)r[a[i]._keys[e].name]=o[e+1];s.title=a[i].title;let l=RoutePerk.__interpolate(a[i].name,r);s.name=l;let n=t.Util.safeGet(a[i],`routeOptions.${l}.settingsRef`,a[i].settingsRef);s.settingsRef=RoutePerk.__interpolate(n,r);let c=t.Util.safeGet(a[i],`routeOptions.${l}.settings`,a[i].settings);s.settings=t.Util.getObject(c,{format:RoutePerk.__getSettingFormat(e)});let d=t.Util.safeGet(a[i],`routeOptions.${l}.extenderRef`,a[i].extenderRef);s.extenderRef=RoutePerk.__interpolate(d,r),s.extender=t.Util.safeGet(a[i],`routeOptions.${l}.extender`,a[i].extender),s.routeParameters=r;break}}return s}static __interpolate(e,t){let i=e;if(t&&"string"==typeof e&&e.indexOf("${")>-1){let r=new RegExp(`\\$\\{(${Object.keys(t).join("|")})\\}`,"gi");i=e.replace(r,(function(e,i){return t[i]}))}return i}static __initPopState(e){window.addEventListener("popstate",(t=>Promise.resolve().then((()=>e.use("spell","event.trigger","beforePopState"))).then((()=>RoutePerk._open(e,{url:window.location.href},{pushState:!1}))).then((()=>e.use("spell","event.trigger","afterPopState")))))}static __getState(e,i){let r={msg:e};return i&&(r=t.Util.deepMerge(t.Util.deepClone(i),r)),r}static __fixRoute(e,i){let r=!0,s=t.URLUtil.loadParameters(i);Object.keys(e.get("state","validation.validationResult.invalids")).forEach((t=>{let i=e.get("state",`validation.validationResult.invalids.${t}`);void 0!==i.fix?s[i.key]=i.fix:"notAllowed"===i.failed[0].validity?delete s[i.key]:r=!1})),r&&(RoutePerk._replaceRoute(e,{queryParameters:s}),e.set("state","validation.validationResult.result",!0))}static __dumpValidationErrors(e){Object.keys(e.get("state","validation.validationResult.invalids")).forEach((t=>{let i=e.get("state",`validation.validationResult.invalids.${t}`);if(i.failed)for(let e=0;e<i.failed.length;e++);}))}static __getSettingFormat(e){return e.get("setting","routing.options.settingFormat",e.get("setting","system.setting.options.settingFormat","json"))}}class AliasPerk extends t.Perk{static get info(){return{section:"alias",order:330}}static globalInit(){AliasPerk._records={}}static init(e,t){this.upgrade(e,"skill","alias.resolve",(function(...e){return AliasPerk._resolve(...e)}))}static _resolve(e,t){return e.get("setting",`alias.${t}`,{})}}class RollCallPerk extends t.Perk{static get info(){return{section:"rollcall",order:330}}static globalInit(){RollCallPerk._records={}}static init(e,t){this.upgrade(e,"skill","rollcall.register",(function(...e){return RollCallPerk._register(...e)})),this.upgrade(e,"spell","rollcall.call",(function(...e){return RollCallPerk._call(...e)})),this.upgrade(e,"event","doApplySettings",RollCallPerk.RollCallPerk_onDoApplySettings)}static RollCallPerk_onDoApplySettings(e,i,r){Object.entries(t.Util.safeGet(i.detail,"settings.rollcall.members",{})).forEach((([e,t])=>{let i=t.name||e;RollCallPerk._register(this,i,t)}))}static _call(e,i,r){if(!RollCallPerk._records[i]){let e={},t=BITSMIST.v1.Unit.get("setting","system.waitForTimeout",1e4),r=new Promise(((r,s)=>{e.resolve=r,e.reject=s,e.timer=setTimeout((()=>{s(`RollCallPerk.call(): Timed out after ${t} milliseconds waiting for ${i}`)}),t)}));e.promise=r,RollCallPerk.__createEntry(i,null,e)}let s=RollCallPerk._records[i];return Promise.resolve().then((()=>{if(t.Util.safeGet(r,"waitForDOMContentLoaded"))return this.get("inventory","promise.documentReady")})).then((()=>{if(t.Util.safeGet(r,"waitForAttendance"))return s.waitInfo.promise})).then((()=>s.object))}static _register(e,t){RollCallPerk._records[t]||RollCallPerk.__createEntry(t);let i=RollCallPerk._records[t];i.object=e,i.waitInfo.resolve(),i.waitInfo.timer&&clearTimeout(i.waitInfo.timer)}static __createEntry(e,t,i){let r={object:t,waitInfo:i=i||{promise:Promise.resolve(),resolve:()=>{},reject:()=>{},timer:null}};return RollCallPerk._records[e]=r,r}}class ResourceHandler{constructor(e,i,r){r=r||{},this._resourceName=i,this._unit=e,this._options=new t.Store({items:r}),this._data={},this._items=[],this._target={},this._currentIndex=0}get resourceName(){return this._resourceName}set resourceName(e){this._resourceName=e}get target(){return this._target}get data(){return this._data}set data(e){this._data=e,this._items=this.__reshapeItems(e)}get items(){return this._items}get options(){return this._options}init(e){if(this._options.get("autoLoad")){let e=this._options.get("autoLoadOptions.id"),t=this._options.get("autoLoadOptions.parameters");return this.load(e,t)}}load(e,t){return Promise.resolve().then((()=>this._load(e,t))).then((e=>(this.data=e,this._data)))}remove(e,t){return this._remove(e,t)}add(e,t,i){return this._add(e,this.__reshapeData(t),i)}update(e,t,i){return this._update(e,this.__reshapeData(t),i)}getText(e){let t=e,i=this._options.get("fieldOptions.text");return this._items&&e in this._items&&(t=this._items[e][i]),t}getItem(e){let t;return this._items&&e in this._items&&(t=this._items[e]),t}_load(e,t){}_remove(e,t){}_add(e,t,i){}_update(e,t,i){}__reshapeItems(e){let i=this._options.get("fieldOptions.items"),r=i?t.Util.safeGet(e,i):e;if(this._options.get("reshapeOptions.load.reshape")){r=this._options.get("reshapeOptions.load.reshaper",this.__reshaper_load.bind(this))(r)}return r}__reshapeData(e){if(this._options.get("reshapeOptions.update.reshape")){let t=this._options.get("reshapeOptions.update.reshaper",(()=>e));e=t(e)}return e}__reshaper_load(e){let t;if(e){let i=this._options.get("fieldOptions.id");t=e.reduce(((e,t)=>(e[t[i]]=t,e)),{})}return t}}class LocaleFormatterUtil extends FormatterUtil{static formatPrice(e,t,i,r){let s=r&&r.localeName?r.localeName:navigator.language,a=r&&r.currencyName?r.currencyName:"USD";return new Intl.NumberFormat(s,{style:"currency",currency:a}).format(i)}static formatDate(e,t,i,r){let s=i;if(t)s=super.formatDate(e,t,i,r);else{let e,t=r&&r.localeName?r.localeName:navigator.language;e=8===i.length?new Date(`${i.substr(0,4)}-${i.substr(4,2)}-${i.substr(6,2)}`):new Date(i),s=new Intl.DateTimeFormat(t).format(e)}return s||""}}class LocaleValueUtil extends ValueUtil{static get name(){return"LocaleValueUtil"}static get attributeName(){return"bm-locale"}static get formatter(){return LocaleFormatterUtil}}class LocaleHandler{constructor(e,i){i=i||{},this._unit=e,this._options=new t.Store({items:i}),this._messages=new t.ChainableStore,this._valueHandler=this.options.get("valueHandler",LocaleValueUtil),this._localeInfo={}}get options(){return this._options}get messages(){return this._messages}init(e){if(this._unit.get("inventory","locale.messages").add(this._messages),e.messages){let i=t.Util.getObject(e.messages,{format:this.__getMessageFormat(this._unit)});this._messages.merge(i)}}has(e){return this._messages.has(e)}get(e,t){return t=e+(t?`.${t}`:""),this._messages.get(t)}localize(e,t){let i=this.get(t.localeName)||this.get(t.fallbackLocaleName);this._valueHandler.setFields(e,i,t)}loadMessages(e,i){let r=t.Util.safeGet(i,"splitLocale",this._options.get("handlerOptions.splitLocale",this._unit.get("setting","system.locale.options.splitLocale")));e=r?e:"";let s=this._localeInfo[e]||{},a=Promise.resolve();if("loaded"===s.status)return a;if(this.__hasExternalMessages(this._unit)){let r=this.__getMessageURL(this._unit,e);a=t.AjaxUtil.loadJSON(r,i).then((i=>{s.messages=t.Util.getObject(i,{format:this.__getMessageFormat(this._unit)}),s.status="loaded",this._messages.merge(i),this._localeInfo[e]=s}))}return a}__hasExternalMessages(e){let t=!1;return(e.hasAttribute("bm-localeref")||this._options.get("handlerOptions.localeRef"))&&(t=!0),t}__getMessageURL(e,i){let r,s,a,o=e.hasAttribute("bm-localeref")?e.getAttribute("bm-localeref")||!0:this._options.get("handlerOptions.localeRef");if(o&&!0!==o){let e=t.URLUtil.parseURL(o);s=e.filename,r=e.path,a=e.query}else{r=t.Util.concatPath([e.get("setting","system.locale.options.path",e.get("setting","system.unit.options.path","")),e.get("setting","locale.options.path",e.get("setting","unit.options.path",""))]),s=this._options.get("handlerOptions.fileName",e.get("setting","unit.options.fileName",e.tagName.toLowerCase()));let o=this.__getMessageFormat(e);a=e.get("setting","unit.options.query"),i&&(s=i?`${s}.${i}`:s),s=`${s}.messages.${o}`}return t.Util.concatPath([r,s])+(a?`?${a}`:"")}__getMessageFormat(e){return this._options.get("messageFormat",e.get("setting","locale.options.messageFormat",e.get("setting","system.locale.options.messageFormat","json")))}}class ValidationHandler{constructor(e,i,r){r=r||{},this._unit=e,this._options=new t.Store({items:r})}get options(){return this._options}init(e){}checkValidity(e,t,i){}reportValidity(e,t){}_validate(e,t,i){t=t||{};let r={};return(i=i||{}).allowList&&Object.keys(e).forEach((s=>{if(-1===i.allowList.indexOf(s)){let i=[{rule:"allowList",validity:"notAllowed"}];r[s]=this._createValidationResult(s,e[s],t[s],i)}})),i.allowOnlyInRules&&Object.keys(e).forEach((i=>{if(!(i in t)){let s=[{rule:"allowList",validity:"notAllowed"}];r[i]=this._createValidationResult(i,e[i],t[i],s)}})),i.disallowList&&Object.keys(e).forEach((s=>{if(i.disallowList.indexOf(s)>-1){let i=[{rule:"disallowList",validity:"disallowed"}];r[s]=this._createValidationResult(s,e[s],t[s],i)}})),Object.keys(t).forEach((i=>{if("constraints"in t[i]&&t[i].constraints&&"required"in t[i].constraints&&t[i].constraints.required&&!(i in e)){let s=[{rule:"required",validity:"valueMissing"}];r[i]=this._createValidationResult(i,e[i],t[i],s)}})),r}_createValidationResult(e,t,i,r,s){return{key:e,value:t,message:this._getFunctionValue(e,t,"message",i),fix:this._getFunctionValue(e,t,"fix",i),failed:r,extras:s}}_getFunctionValue(e,t,i,r){let s;return r&&i in r&&(s="function"==typeof r[i]?r[i](e,t,r):r[i]),s}}class ChainedSelect extends t.Unit{_getSettings(){return{setting:{autoClear:!0,autoSubmit:!0,useDefaultInput:!0,rootNodes:{newitem:".btn-newitem",removeitem:".btn-removeitem",edititem:".btn-edititem",select:"select"}},event:{events:{this:{handlers:{beforeStart:["ChainedSelect_onBeforeStart"],afterTransform:["ChainedSelect_onAfterTransform"],doClear:["ChainedSelect_onDoClear"],doFill:["ChainedSelect_onDoFill"]}},"cmb-item":{rootNode:"select",handlers:{change:["ChainedSelect_onCmbItemChange"]}},"btn-newitem":{rootNode:".btn-newitem",handlers:{click:["ChainedSelect_onBtnNewItemClick"]}},"btn-edititem":{rootNode:".btn-edititem",handlers:{click:["ChainedSelect_onBtnEditItemClick"]}},"btn-removeitem":{rootNode:".btn-removeitem",handlers:{click:["ChainedSelect_onBtnRemoveItemClick"]}}}},validation:{}}}get items(){let e=0,t=1;for(;this.querySelector(`:scope .item[data-level='${t}'] select`);)t++,e++;return e}ChainedSelect_onBeforeStart(e,t,i){this.rootNodes=this.get("setting","options.rootNodes"),this.get("setting","options.useDefaultInput",!0)&&(this.use("skills","event.add","beforeAdd","ChainedSelect_onBeforeAdd"),this.use("skills","event.add","doAdd","ChainedSelect_onDoAdd"),this.use("skills","event.add","beforeEdit","ChainedSelect_onBeforeEdit"),this.use("skills","event.add","doEdit","ChainedSelect_onDoEdit"),this.use("skills","event.add","beforeRemove","ChainedSelect_onBeforeRemove"),this.use("skills","event.add","doRemove","ChainedSelect_onDoRemove"))}ChainedSelect_onAfterTransform(e,t,i){this.use("skills","basic.clear",{fromLevel:1,toLevel:this.length}),this.get("setting","options.isAddable",!0)||this.querySelectorAll(`:scope ${this.rootNodes.newitem}`).forEach((e=>{e.style.display="none"})),this.get("setting","options.isEditable",!0)||this.querySelectorAll(`:scope ${this.rootNodes.edititem}`).forEach((e=>{e.style.display="none"})),this.get("setting","options.isRemovable",!0)||this.querySelectorAll(`:scope ${this.rootNodes.removeitem}`).forEach((e=>{e.style.display="none"}))}ChainedSelect_onDoClear(e,i,r){let s=t.Util.safeGet(i.detail,"fromLevel",1),a=t.Util.safeGet(i.detail,"toLevel",this.length);for(let e=s;e<=a;e++)this.get("setting","options.autoClear")&&(this.querySelector(`:scope .item[data-level='${e}'] ${this.rootNodes.select}`).options.length=0),this.querySelector(`:scope .item[data-level='${e}'] ${this.rootNodes.select}`).selectedIndex=-1,this._initElement("select",e),this._initElement("newitem",e),this._initElement("edititem",e),this._initElement("removeitem",e)}ChainedSelect_onDoFill(e,i,r){let s=t.Util.safeGet(i.detail,"level",1);this.assignItems(s,this.items)}ChainedSelect_onCmbItemChange(e,t,i){return this.selectItem(e.parentNode.getAttribute("data-level"),e.value)}ChainedSelect_onBtnNewItemClick(e,t,i){if(e.classList.contains("disabled"))return;let r=e.parentNode.getAttribute("data-level");this.set("state","dialog.modalResult.result",!1);let s={level:r,validatorName:""};return this.use("skills","event.trigger","beforeAdd",s).then((()=>{if(this.get("state","dialog.modalResult.result"))return this.validate(s).then((()=>{if(this.get("state","validation.validationResult.result"))return Promise.resolve().then((()=>this.use("skills","event.trigger","doAdd",s))).then((()=>this.use("skills","event.trigger","afterAdd",s))).then((()=>{if(this.get("setting","options.autoSubmit",!0))return this.use("skills","form.submit",s)}))}))}))}ChainedSelect_onBtnEditItemClick(e,t,i){if(e.classList.contains("disabled"))return;let r=e.parentNode.getAttribute("data-level");this.set("state","dialog.modalResult.result",!1);let s={level:r,validatorName:""};return this.use("skills","event.trigger","beforeEdit",s).then((()=>{if(this.get("state","dialog.modalResult.result"))return this.validate(s).then((()=>{if(this.get("state","validation.validationResult.result"))return Promise.resolve().then((()=>this.use("skills","event.trigger","doEdit",s))).then((()=>this.use("skills","event.trigger","afterEdit",s))).then((()=>{if(this.get("setting","options.autoSubmit",!0))return this.use("skills","form.submit",s)}))}))}))}onChainedSelect_onBtnRemoveItemClick(e,t,i){if(e.classList.contains("disabled"))return;let r=e.parentNode.getAttribute("data-level");this.set("state","dialog.modalResult.result",!1);let s={level:r,validatorName:""};return this.use("spell","event.trigger","beforeRemove",s).then((()=>{if(this.get("state","dialog.modalResult.result"))return this.validate(s).then((()=>{if(this.get("state","validation.validationResult.result"))return Promise.resolve().then((()=>this.use("spell","event.trigger","doRemove",s))).then((()=>this.use("spell","event.trigger","afterRemove",s))).then((()=>{if(this.get("setting","options.autoSubmit",!0))return this.use("spell","form.submit",s)}))}))}))}ChainedSelect_onBeforeAdd(e,t,i){return new Promise(((e,t)=>{let i=window.prompt("ã¢ã¤ãã åãå¥åãã¦ãã ãã","");i&&(this.set("state","dialog.modalResult.text",i),this.set("state","dialog.modalResult.value",i),this.set("state","dialog.modalResult.result",!0)),e()}))}ChainedSelect_onDoAdd(e,t,i){return this.newItem(t.detail.level,this.get("state","dialog.modalResult.text"),this.get("state","dialog.modalResult.value"))}ChainedSelect_onBeforeEdit(e,i,r){let s=parseInt(t.Util.safeGet(i.detail,"level",1)),a=this.getSelect(s);return new Promise(((e,t)=>{let i=window.prompt("ã¢ã¤ãã åãå¥åãã¦ãã ãã","");i&&(this.set("state","dialog.modalResult.old",{text:a.options[a.selectedIndex].text,value:a.value}),this.set("state","dialog.modalResult.new",{text:i,value:i}),this.set("state","dialog.modalResult.result",!0)),e()}))}ChainedSelect_onDoEdit(e,t,i){return this.editItem(t.detail.level,this.get("state","dialog.modalResult.new.text"),this.get("state","dialog.modalResult.new.value"))}ChainedSelect_onBeforeRemove(e,i,r){return new Promise(((e,r)=>{if(window.confirm("åé¤ãã¾ããï¼")){let e=parseInt(t.Util.safeGet(i.detail,"level",1)),r=this.getSelect(e);this.set("state","dialog.modalResult.text",r.options[r.selectedIndex].text),this.set("state","dialog.modalResult.value",r.value),this.set("state","dialog.modalResult.result",!0)}e()}))}ChainedSelect_onDoRemove(e,t,i){return this.removeItem(t.detail.level)}getSelect(e){return this.querySelector(`:scope [data-level='${e}'] ${this.rootNodes.select}`)}assignItems(e,i){let r=this.querySelector(`:scope [data-level='${e}'] > select`);if(t.Util.assert(r,`ChainedSelect.editItem(): select not found. name=${this.tagName}, level=${e}`),i=i||{},Array.isArray(i))for(let e=0;e<i.length;e++){let s=document.createElement("option");i[e];{s.value=t.Util.safeGet(i[e],"value",i[e]),s.text=t.Util.safeGet(i[e],"text",i[e]);let r=t.Util.safeGet(i[e],"css");r&&Object.keys(r).forEach((e=>{s.css[e]=r[e]}))}r.add(s)}else Object.keys(i).forEach((e=>{let s=document.createElement("option");s.value=t.Util.safeGet(i[e],"value",e),s.text=t.Util.safeGet(i[e],"text",e);let a=t.Util.safeGet(i[e],"css");a&&Object.keys(a).forEach((e=>{s.css[e]=a[e]})),r.add(s)}));r.value="",this._initElement("select",e,!0),this._initElement("newitem",e,!0)}selectItem(e,i){let r=this.querySelector(`:scope .item[data-level='${e}'] select`);return t.Util.assert(r,`ChainedSelect.editItem(): select not found. name=${this.tagName}, level=${e}`),r.value=i,this._initElement("edititem",e,!0),this._initElement("removeitem",e,!0),this.use("spell","basic.clear",{fromLevel:parseInt(e)+1,toLevel:this.length}),Promise.resolve().then((()=>{if(e++,this.querySelector(`:scope .item[data-level='${e}'] select`))return this._initElement("newitem",e),this.use("spell","basic.refresh",{level:e,value:i})}))}newItem(e,i,r){let s=this.querySelector(`:scope .item[data-level='${e}'] select`);t.Util.assert(s,`ChainedSelect.editItem(): select not found. name=${this.tagName}, level=${e}`);let a=s.selectedIndex,o=document.createElement("option");o.value=r||i,o.text=i,s.add(o),s.selectedIndex=a}editItem(e,i,r){let s=this.querySelector(`:scope .item[data-level='${e}'] select`);t.Util.assert(s,`ChainedSelect.editItem(): select not found. name=${this.tagName}, level=${e}`),s.options[s.selectedIndex].text=i,s.options[s.selectedIndex].value=r||i}removeItem(e){let i=this.querySelector(`:scope .item[data-level='${e}'] select`);t.Util.assert(i,`ChainedSelect.removeItem(): select not found. name=${this.tagName}, level=${e}`),i.remove(i.selectedIndex),i.value="",this._initElement("edititem",e),this._initElement("removeitem",e),this.use("spell","basic.clear",{fromLevel:parseInt(e)+1,toLevel:this.length})}_initElement(e,t,i){e=this.rootNodes[e],i?(this.querySelector(`:scope .item[data-level='${t}'] ${e}`).disabled=!1,this.querySelector(`:scope .item[data-level='${t}'] ${e}`).classList.remove("disabled")):(this.querySelector(`:scope .item[data-level='${t}'] ${e}`).disabled=!0,this.querySelector(`:scope .item[data-level='${t}'] ${e}`).classList.add("disabled"))}}customElements.define("bm-chainedselect",ChainedSelect);class TabIndex extends t.Unit{_getSettings(){return{basic:{options:{autoTransform:!1}},event:{events:{"tab-indices":{rootNode:"[data-tabindex]",handlers:{click:["TabIndex_onTabIndexClick"]}}}}}}TabIndex_onTabIndexClick(e,t,i){e.classList.contains("active")||this.switchIndex(e.getAttribute("data-tabindex"))}switchIndex(e){this.querySelector(":scope [data-tabindex].active").classList.remove("active"),this.querySelector(`:scope [data-tabindex='${e}']`).classList.add("active");let t=document.querySelector(this.getAttribute("data-pair"));t&&t.switchContent(e)}getActiveIndex(){return this.querySelector(":scope .active")}}customElements.define("bm-tabindex",TabIndex);class TabContent extends t.Unit{_getSettings(){return{basic:{options:{autoTransform:!1}}}}switchContent(e){this.querySelector(":scope > .active").classList.remove("active"),this.querySelector(`:scope > [data-tabindex='${e}']`).classList.add("active"),this.querySelector(`:scope > [data-tabindex='${e}']`).focus()}getActiveContent(){return this.querySelector(":scope .active")}}customElements.define("bm-tabcontent",TabContent);class PreferenceServer extends t.Unit{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["PreferenceServer_onBeforeStart"],beforeSubmit:["PreferenceServer_onBeforeSubmit"],doReportValidity:["PreferenceServer_onDoReportValidity"]}}}},form:{options:{autoCollect:!1,autoCrop:!1}},skin:{options:{skinRef:!1}},style:{options:{styleRef:!1}}}}get items(){return this._store.items}PreferenceServer_onBeforeStart=function(e,t,i){this._store=new ObservableStore({items:this.get("setting","options.defaults"),filter:this._filter,async:!0}),Object.keys(this.get("inventory","resource.resources",{})).forEach((e=>{this._store.merge(this.get("inventory",`resource.resources.${e}`).items)}))};PreferenceServer_onBeforeSubmit=function(e,t,i){this._store.set("",t.detail.items,t.detail.options,...t.detail.args),t.detail.items=this._store.items};PreferenceServer_onDoReportValidity=function(e,t,i){let r=`Invalid preference value. name=${this.tagName}`;Object.keys(this.get("state","validation.validationResult.invalids")).forEach((e=>{r+="\n\tkey="+this.get("state",`validation.validationResult.invalids.${e}.key`)+", value="+this.get("state",`validation.validationResult.invalids.${e}.value`)}))};subscribe(e,t){this._store.subscribe(`${e.tagName}_${e.uniqueId}`,this._triggerEvent.bind(e),t)}getPreference(e,t){return this._store.get(e,t)}setPreference(e,t,...i){let r=this.get("setting","options.validatorName");return this.use("spell","form.submit",{items:e,options:t,args:i,validatorName:r})}_triggerEvent(e,i,r){let s=t.Util.safeGet(r,"sender",this);return this.use("spell","preference.apply",{sender:s,preferences:e})}_filter(e,t,...i){let r=!1,s=t.options.targets;s=Array.isArray(s)?s:[s];for(let t=0;t<s.length;t++)if(e[s[t]]){r=!0;break}return r}}customElements.define("bm-preference",PreferenceServer);class ErrorServer extends t.Unit{_getSettings(){return{basic:{options:{autoRefresh:!1}},event:{events:{this:{handlers:{beforeStart:["ErrorServer_onBeforeStart"]}}}},skin:{options:{skinRef:!1}},style:{options:{styleRef:!1}}}}ErrorServer_onBeforeStart(e,i,r){this._observers=new t.ObservableStore({filter:this.__filter}),this.__initListeners()}__filter(e,t,...i){let r=!1,s=t.options.unit.get("setting","errors.targets"),a=i[0].error;for(let e=0;e<s.length;e++)if(a.name===s[e]||"*"===s[e]){r=!0;break}return r}__initListeners(){window.addEventListener("unhandledrejection",this.__rejectionHandler.bind(this)),window.addEventListener("error",this.__errorHandler.bind(this))}__rejectionHandler(e){let t={};try{e.reason?e.reason instanceof XMLHttpRequest?(t.message=e.reason.statusText,t.stack=e.reason.stack,t.object=e.reason):(t.message=e.reason.message,t.object=e.reason):t.message=e,t.type=e.type,t.name=this.__getErrorName(e),t.filename="",t.funcname="",t.lineno="",t.colno="",this.__handleException(t)}catch(t){}return!0}__errorHandler(e,t,i,r){let s={};try{s.type="error",s.name=this.__getErrorName(e),s.message=e.message,s.file=e.filename,s.line=e.lineno,s.col=e.colno,e.error&&(s.stack=e.error.stack,s.object=e.error),this.__handleException(s)}catch(s){}return!0}__getErrorName(e){let t,i;if(i=e.reason instanceof XMLHttpRequest||e.reason?e.reason:e.error?e.error:e.message,i.name)t=i.name;else if(i instanceof TypeError)t="TypeError";else if(i instanceof XMLHttpRequest)t="AjaxError";else if(i instanceof EvalError)t="EvalError";else if(i instanceof RangeError)t="RangeError";else if(i instanceof ReferenceError)t="ReferenceError";else if(i instanceof SyntaxError)t="SyntaxError";else if(i instanceof URIError)t="URIError";else{let e=i.indexOf(":");e>-1&&(t=i.substring(0,e))}return t}__handleException(e){let i=e.object.status,r=this.get("setting","handlers");return Object.keys(r.statusCode).forEach((e=>{i==e&&Object.keys(r.statusCode[e]).forEach((i=>{let s=r.statusCode[e][i];if("route"===i){let e=s.routeInfo;Object.keys(e.queryParameters).forEach((t=>{e.queryParameters[t]=e.queryParameters[t].replace("@URL@",location.href)})),window.location.href=t.URLUtil.buildURL(e)}}))})),this._observers.notifyAsync("error",{sender:this,error:e})}}customElements.define("bm-error",ErrorServer);class Router extends t.Unit{_getSettings(){return{basic:{options:{autoRefresh:!1,autoFetch:!1,autoClear:!1,autoFill:!1}},skin:{options:{skinRef:!1}},style:{options:{styleRef:!1}},routing:{}}}}customElements.define("bm-router",Router),window.BITSMIST.v1.MultiStore=MultiStore,window.BITSMIST.v1.ArrayStore=ArrayStore,window.BITSMIST.v1.ObservableStore=ObservableStore,window.BITSMIST.v1.BindableStore=BindableStore,window.BITSMIST.v1.BindableArrayStore=BindableArrayStore,t.PerkPerk.register(FilePerk),t.PerkPerk.register(ErrorPerk),t.PerkPerk.register(ElementPerk),t.PerkPerk.register(ResourcePerk),t.PerkPerk.register(ValidationPerk),t.PerkPerk.register(FormPerk),t.PerkPerk.register(ListPerk),t.PerkPerk.register(DatabindingPerk),t.PerkPerk.register(LocalePerk),t.PerkPerk.register(KeyPerk),t.PerkPerk.register(ChainPerk),t.PerkPerk.register(DialogPerk),t.PerkPerk.register(PreferencePerk),t.PerkPerk.register(RoutePerk),t.PerkPerk.register(AliasPerk),t.PerkPerk.register(RollCallPerk),window.BITSMIST.v1.CookieResourceHandler=class CookieResourceHandler extends ResourceHandler{constructor(e,i,r){super(e,i,Object.assign({autoLoad:!0,autoFetch:!1},r)),this._cookieName=t.Util.safeGet(r,"cookieOptions.name","preferences")}_load(e,t){return this.__getCookie(this._cookieName)}_add(e,t,i){this.__setCookie(this._cookieName,t)}_update(e,t,i){this.__setCookie(this._cookieName,t)}__getCookie(e){let t=document.cookie.split(";").reduce(((e,t)=>{const[i,r]=t.split("=");return i&&(e[i.trim()]=r?decodeURIComponent(r.trim()):void 0),e}),{});return t[e]?JSON.parse(t[e]):{}}__setCookie(e,t){let i=e+`=${encodeURIComponent(JSON.stringify(t))}; `,r=this._options.get("cookieOptions");i+=Object.keys(r).reduce(((e,t)=>e+=`${t}=${r[t]}; `),""),document.cookie=i}},window.BITSMIST.v1.APIResourceHandler=class APIResourceHandler extends ResourceHandler{_load(e,i){let r="GET",s=this._getOption("headers",r),a=this._getOption("options",r),o=this._getOption("URL",r),l=o.dataType,n=this._buildApiUrl(this._resourceName,e,i,o);return t.AjaxUtil.ajaxRequest({URL:n,method:r,headers:s,options:a}).then((e=>this._convertResponseData(e.responseText,l)))}_remove(e,i){let r="DELETE",s=this._getOption("headers",r),a=this._getOption("options",r),o=this._getOption("URL",r);o.dataType;let l=this._buildApiUrl(this._resourceName,e,i,o);return t.AjaxUtil.ajaxRequest({URL:l,method:r,headers:s,options:a})}_add(e,i,r){let s="POST",a=this._getOption("headers",s),o=this._getOption("options",s),l=this._getOption("URL",s),n=l.dataType,c=this._buildApiUrl(this._resourceName,e,r,l);return t.AjaxUtil.ajaxRequest({URL:c,method:s,headers:a,options:o,data:this._convertRequestData(i,n)})}_update(e,i,r){let s="PUT",a=this._getOption("headers",s),o=this._getOption("options",s),l=this._getOption("URL",s),n=l.dataType,c=this._buildApiUrl(this._resourceName,e,r,l);return t.AjaxUtil.ajaxRequest({URL:c,method:s,headers:a,options:o,data:this._convertRequestData(i,n)})}_convertRequestData(e,t){let i;return i=JSON.stringify(e),i}_convertResponseData(e,t){let i;return i=JSON.parse(e),i}_getOption(e,t){let i=this._options.get("ajaxOptions",{}),r=e in i&&"COMMON"in i[e]?i[e].COMMON:{},s=e in i&&t in i[e]?i[e][t]:{};return Object.assign(r,s)}_buildApiUrl(e,i,r,s){let a=s.baseURL||"",o=s.scheme||"",l=s.host||"",n=s.dataType||"",c=s.version||"";return(s.format||"").replace("@scheme@",o).replace("@host@",l).replace("@baseURL@",a).replace("@resource@",e).replace("@id@",i).replace("@dataType@",n).replace("@query@",t.URLUtil.buildQuery(r)).replace("@version@",c)}},window.BITSMIST.v1.ObjectResourceHandler=class ObjectResourceHandler extends ResourceHandler{constructor(e,t,i){super(e,t,Object.assign({autoLoad:!0,autoFetch:!1,autoSubmit:!1},i)),i.items&&(this.data=i.items)}_load(e,t){return this._data}_update(e,t,i){this.data=t}},window.BITSMIST.v1.LinkedResourceHandler=class LinkedResourceHandler extends ResourceHandler{constructor(e,t,i){super(e,t,Object.assign({autoLoad:!0,autoFetch:!1,autoSubmit:!1},i)),this._ref}get data(){return this._ref.data}set data(e){}get items(){return this._ref.items}getText(e){return this._ref.getText(e)}getItem(e){return this._ref.getItem(e)}_load(e,t){let i=this._options.get("rootNode"),r=this._options.get("resourceName")||this._resourceName;return this._unit.use("spell","status.wait",[i]).then((()=>(this._ref=document.querySelector(i).get("inventory","resource.resources")[r],this._ref)))}_remove(e,t){throw TypeError("LinkedResourceHandler is read only.")}_add(e,t,i){throw TypeError("LinkedResourceHandler is read only.")}_update(e,t,i){throw TypeError("LinkedResourceHandler is read only.")}},window.BITSMIST.v1.WebStorageResourceHandler=class WebStorageResourceHandler extends ResourceHandler{_load(e,t){let i,r=localStorage.getItem(e);return r&&(i=JSON.parse(r)),i}_remove(e,t){localStorage.removeItem(e)}_add(e,t,i){localStorage.setItem(e,JSON.stringify(t))}_update(e,t,i){localStorage.setItem(e,JSON.stringify(t))}},window.BITSMIST.v1.LocaleHandler=LocaleHandler,window.BITSMIST.v1.LocaleServerHandler=class LocaleServerHandler extends LocaleHandler{init(e){let i=this._unit.get("setting","locale.options.localeServer",this._unit.get("setting","system.locale.options.localeServer"));return i=!0===i?"bm-locale":i,t.Util.assert(i,`Locale Server node not specified in settings. name=${this._unit.tagName}`),this._unit.use("spell","status.wait",[i]).then((()=>{let e=document.querySelector(i);this._messages.chain(e.get("inventory","locale.messages"))}))}loadMessages(e,t){}},window.BITSMIST.v1.ValidationHandler=ValidationHandler,window.BITSMIST.v1.HTML5FormValidationHandler=class HTML5FormValidationHandler extends ValidationHandler{constructor(e,t,i){super(e,t,i),this._valueHandler=this.options.get("valueHandler",ValueUtil)}checkValidity(e,i,r){let s,a={},o=t.Util.scopedSelectorAll(this._unit,"form")[0];if(i||r){let e=this._valueHandler.getFields(o);a=super._validate(e,i,r)}s=this._validate(o,i);let l=t.Util.deepMerge(a,s);this._unit.set("state","validation.validationResult.result",!(Object.keys(l).length>0)),this._unit.set("state","validation.validationResult.invalids",l)}reportValidity(e,i){let r=t.Util.scopedSelectorAll(this._unit,"form")[0];t.Util.assert(r,"FormValidationHandler.reportValidity(): Form tag does not exist.",TypeError),t.Util.assert(r.reportValidity,"FormValidationHandler.reportValidity(): Report validity not supported.",TypeError),r.reportValidity()}_validate(e,i){let r={};return t.Util.assert(e,"FormValidationHandler.checkValidity(): Form tag does not exist.",TypeError),t.Util.assert(e.checkValidity,"FormValidationHandler.checkValidity(): check validity not supported.",TypeError),t.Util.scopedSelectorAll(e,"input:not([novalidate])").forEach((e=>{let t=e.getAttribute("bm-bind"),s=this._valueHandler.getValue(e),a=i&&i[t]?i[t]:null,o=this._validateValue(e,t,s,a);o.length>0&&(r[t]=this._createValidationResult(t,s,a,o,{element:e}),r.message=r.message||e.validationMessage)})),r}_validateValue(e,t,i,r){let s=[],a=e.validity;if(!a.valid)for(const e in a)"valid"!==e&&a[e]&&s.push({validity:e});return s}},window.BITSMIST.v1.ObjectValidationHandler=class ObjectValidationHandler extends ValidationHandler{checkValidity(e,i,r){let s=super._validate(e,i,r),a=this._validate(e,i),o=t.Util.deepMerge(s,a);this._unit.set("state","validation.validationResult.result",!(Object.keys(o).length>0)),this._unit.set("state","validation.validationResult.invalids",o)}reportValidity(e,t){}_validate(e,t){let i={};return t&&Object.keys(e).forEach((r=>{if(t[r]){let s=this._validateValue(r,e[r],t[r]);s.length>0&&(i[r]=this._createValidationResult(r,e[r],t[r],s))}})),i}_validateValue(e,t,i){let r=[];return i&&i.constraints&&Object.keys(i.constraints).forEach((s=>{let a=this._checkConstraint(e,t,s,i.constraints[s]);a&&r.push(a)})),r}_checkConstraint(e,t,i,r){let s,a,o;switch(i){case"type":s=this._checkType(e,t,i,r);break;case"required":t||(s={rule:"required",validity:"valueMissing"});break;case"minlength":a=String(t).length,a<r&&(s={rule:"minlength",validity:"tooShort(min:"+r+")"});break;case"maxlength":a=String(t).length,a>r&&(s={rule:"maxlength",validity:"tooLong(max:"+r+")"});break;case"min":o=parseInt(t),o<r&&(s={rule:"min",validity:"rangeUnderflow(min:"+r+")"});break;case"max":o=parseInt(t),o>r&&(s={rule:"max",validity:"rangeOverflow(max:"+r+")"});break;case"pattern":new RegExp(r).test(t)||(s={rule:"pattern",validity:"patternMismatch(pattern:"+r+")"});break;case"valids":-1===r.indexOf(t)&&(s={rule:"valids",validity:"validsMismatch"});break;case"custom":r(e,t,r)||(s={rule:"custom",validity:"customMismatch"})}return s}_checkType(e,t,i,r){let s;if(t)switch(r){case"object":"object"!=typeof t&&(s={rule:"type",validity:"typeMismatch(object)"});break;case"function":"function"!=typeof t&&(s={rule:"type",validity:"typeMismatch(function)"});break;case"string":"string"!=typeof t&&(s={rule:"type",validity:"typeMismatch(string)"});break;case"number":let e=parseInt(t);isNaN(e)&&(s={rule:"type",validity:"typeMismatch(number)"})}return s}},window.BITSMIST.v1.FormatterUtil=FormatterUtil,window.BITSMIST.v1.LocaleFormatterUtil=LocaleFormatterUtil,window.BITSMIST.v1.ValueUtil=ValueUtil,window.BITSMIST.v1.LocaleValueUtil=LocaleValueUtil,window.BITSMIST.v1.ChainedSelect=ChainedSelect,window.BITSMIST.v1.BmTabindex=TabIndex,window.BITSMIST.v1.BmTabcontent=TabContent,window.BITSMIST.v1.PreferenceServer=PreferenceServer,window.BITSMIST.v1.LocaleServer=LocaleServer,window.BITSMIST.v1.ErrorServer=ErrorServer,window.BITSMIST.v1.Router=Router}();
